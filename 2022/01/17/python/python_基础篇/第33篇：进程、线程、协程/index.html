<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/hedgehog.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/hedgehog.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"tongsiying.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"hide","b2t":true,"scrollpercent":true,"padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="article">
<meta property="og:title" content="第33篇：进程、线程、协程">
<meta property="og:url" content="https://tongsiying.github.io/2022/01/17/python/python_%E5%9F%BA%E7%A1%80%E7%AF%87/%E7%AC%AC33%E7%AF%87%EF%BC%9A%E8%BF%9B%E7%A8%8B%E3%80%81%E7%BA%BF%E7%A8%8B%E3%80%81%E5%8D%8F%E7%A8%8B/index.html">
<meta property="og:site_name" content="tongsiying">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://tongsiying.github.io/2022/01/17/python/python_%E5%9F%BA%E7%A1%80%E7%AF%87/%E7%AC%AC33%E7%AF%87%EF%BC%9A%E8%BF%9B%E7%A8%8B%E3%80%81%E7%BA%BF%E7%A8%8B%E3%80%81%E5%8D%8F%E7%A8%8B/1476293-20181213164417709-1617076872.png">
<meta property="og:image" content="https://tongsiying.github.io/2022/01/17/python/python_%E5%9F%BA%E7%A1%80%E7%AF%87/%E7%AC%AC33%E7%AF%87%EF%BC%9A%E8%BF%9B%E7%A8%8B%E3%80%81%E7%BA%BF%E7%A8%8B%E3%80%81%E5%8D%8F%E7%A8%8B/1476293-20181213165121093-913269748.png">
<meta property="article:published_time" content="2022-01-17T14:38:07.397Z">
<meta property="article:modified_time" content="2022-01-25T12:10:00.680Z">
<meta property="article:author" content="tongsiying">
<meta property="article:tag" content="python">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://tongsiying.github.io/2022/01/17/python/python_%E5%9F%BA%E7%A1%80%E7%AF%87/%E7%AC%AC33%E7%AF%87%EF%BC%9A%E8%BF%9B%E7%A8%8B%E3%80%81%E7%BA%BF%E7%A8%8B%E3%80%81%E5%8D%8F%E7%A8%8B/1476293-20181213164417709-1617076872.png">

<link rel="canonical" href="https://tongsiying.github.io/2022/01/17/python/python_%E5%9F%BA%E7%A1%80%E7%AF%87/%E7%AC%AC33%E7%AF%87%EF%BC%9A%E8%BF%9B%E7%A8%8B%E3%80%81%E7%BA%BF%E7%A8%8B%E3%80%81%E5%8D%8F%E7%A8%8B/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>第33篇：进程、线程、协程 | tongsiying</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
<!-- 加入APlayer音乐播放器 -->
<link rel="stylesheet" href="/dist/APlayer.min.css">
<div id="aplayer"></div>
<script type="text/javascript" src="/dist/APlayer.min.js"></script>
<script type="text/javascript" src="/dist/music.js"></script>
  <div class="container use-motion">
    <div class="headband"></div>
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

	<!-- catalog/ -->
	<!--     <a href="/" class="brand" rel="start"> -->
	
    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">tongsiying</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">阅读|运动|自律</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://tongsiying.github.io/2022/01/17/python/python_%E5%9F%BA%E7%A1%80%E7%AF%87/%E7%AC%AC33%E7%AF%87%EF%BC%9A%E8%BF%9B%E7%A8%8B%E3%80%81%E7%BA%BF%E7%A8%8B%E3%80%81%E5%8D%8F%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/gutianle.gif">
      <meta itemprop="name" content="tongsiying">
      <meta itemprop="description" content="问渠那得清如许？为有源头活水来。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="tongsiying">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          第33篇：进程、线程、协程
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-01-17 22:38:07" itemprop="dateCreated datePublished" datetime="2022-01-17T22:38:07+08:00">2022-01-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-01-25 20:10:00" itemprop="dateModified" datetime="2022-01-25T20:10:00+08:00">2022-01-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index"><span itemprop="name">python</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>22k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>20 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p class="description"></p>
<a id="more"></a>

<h1 id="一、IO多路复用"><a href="#一、IO多路复用" class="headerlink" title="一、IO多路复用"></a><strong>一、IO多路复用</strong></h1><p><strong><img src="/2022/01/17/python/python_%E5%9F%BA%E7%A1%80%E7%AF%87/%E7%AC%AC33%E7%AF%87%EF%BC%9A%E8%BF%9B%E7%A8%8B%E3%80%81%E7%BA%BF%E7%A8%8B%E3%80%81%E5%8D%8F%E7%A8%8B/1476293-20181213164417709-1617076872.png" alt="img"></strong></p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>阻塞I/O模型</span><br><span class="line">老李去火车站买票，排队三天买到一张退票。</span><br><span class="line">耗费：在车站吃喝拉撒睡 <span class="number">3</span>天，其他事一件没干。</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>非阻塞I/O模型</span><br><span class="line">老李去火车站买票，隔<span class="number">12</span>小时去火车站问有没有退票，三天后买到一张票。耗费：往返车站<span class="number">6</span>次，路上<span class="number">6</span>小时，其他时间做了好多事。<span class="number">3.</span>I/O复用模型</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>I/O复用模型　</span><br><span class="line">　<span class="number">1.</span>select/poll</span><br><span class="line">　　老李去火车站买票，委托黄牛，然后每隔<span class="number">6</span>小时电话黄牛询问，黄牛三天内买到票，然后老李去火车站交钱领票。</span><br><span class="line">耗费：往返车站<span class="number">2</span>次，路上<span class="number">2</span>小时，黄牛手续费<span class="number">100</span>元，打电话<span class="number">17</span>次</span><br><span class="line">　<span class="number">2.</span>epoll</span><br><span class="line">　　老李去火车站买票，委托黄牛，黄牛买到后即通知老李去领，然后老李去火车站交钱领票。</span><br><span class="line">耗费：往返车站<span class="number">2</span>次，路上<span class="number">2</span>小时，黄牛手续费<span class="number">100</span>元，无需打电话</span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>信号驱动I/O模型</span><br><span class="line">老李去火车站买票，给售票员留下电话，有票后，售票员电话通知老李，然后老李去火车站交钱领票。</span><br><span class="line">耗费：往返车站<span class="number">2</span>次，路上<span class="number">2</span>小时，免黄牛费<span class="number">100</span>元，无需打电话</span><br><span class="line"></span><br><span class="line"><span class="number">5.</span>异步I/O模型</span><br><span class="line">老李去火车站买票，给售票员留下电话，有票后，售票员电话通知老李并快递送票上门。</span><br><span class="line">耗费：往返车站<span class="number">1</span>次，路上<span class="number">1</span>小时，免黄牛费<span class="number">100</span>元，无需打电话</span><br></pre></td></tr></table></figure>



<p>　　如果一个I/O流进来，我们就开启一个进程处理这个I/O流。那么假设现在有一百万个I/O流进来，那我们就需要开启一百万个进程一一对应处理这些I/O流（——这就是传统意义下的<strong>多进程并发处理</strong>）。思考一下，一百万个进程，你的CPU占有率会多高，这个实现方式及其的不合理。所以人们提出了I/O多路复用这个模型，<strong>一个线程，通过记录I/O流的状态来同时管理多个I/O，可以提高服务器的吞吐能力</strong>。</p>
<p>　　I/O multiplexing 也就是我们所说的I/O多路复用，但是这个翻译真的很不生动，所以我更喜欢将它拆开，变成 <strong>I/O multi plexing。</strong>multi意味着多，而plex意味着丛（丛：聚集，许多事物凑在一起。），那么字面上来看I/O multiplexing 就是将<strong>多个I/O凑在一起</strong>。就像下面这张图的前半部分一样，中间的那条线就是我们的<strong>单个线程</strong>，它通过记录传入的每一个I/O流的状态来同时管理多个IO。</p>
<p><strong>IO多路复用的实现</strong> </p>
<p><strong><img src="/2022/01/17/python/python_%E5%9F%BA%E7%A1%80%E7%AF%87/%E7%AC%AC33%E7%AF%87%EF%BC%9A%E8%BF%9B%E7%A8%8B%E3%80%81%E7%BA%BF%E7%A8%8B%E3%80%81%E5%8D%8F%E7%A8%8B/1476293-20181213165121093-913269748.png" alt="img"></strong></p>
<p>我们来分析一下上面这张图</p>
<ul>
<li>当进程调用select，进程就会被阻塞</li>
<li>此时内核会监视所有select负责的的socket，当socket的数据准备好后，就立即返回。</li>
<li>进程再调用read操作，数据就会从内核拷贝到进程。</li>
</ul>
<p><strong>其实多路复用的实现有多种方式：select、poll、epoll</strong></p>
<p> selectors模块_client</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">@Datetime: 2018/9/7</span></span><br><span class="line"><span class="string">@Author: Zhang Yafei</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">sock = socket(AF_INET,SOCK_STREAM)</span><br><span class="line">sock.connect((<span class="string">'127.0.0.1'</span>,<span class="number">8090</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    data = input(<span class="string">'&gt;&gt;:'</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    sock.send(data.encode(<span class="string">'utf-8'</span>))</span><br><span class="line">    result = sock.recv(<span class="number">1024</span>)</span><br><span class="line">    print(result.decode(<span class="string">'utf-8'</span>))</span><br><span class="line"></span><br><span class="line">selectors模块_client</span><br></pre></td></tr></table></figure>

<p> selectors_serrer</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">@Datetime: 2018/9/7</span></span><br><span class="line"><span class="string">@Author: Zhang Yafei</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">import</span> selectors</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">sel = selectors.DefaultSelector()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">accept</span><span class="params">(sock, mask)</span>:</span></span><br><span class="line">    conn, addr = sock.accept()  <span class="comment"># Should be ready</span></span><br><span class="line">    print(<span class="string">'accepted'</span>, conn, <span class="string">'from'</span>, addr)</span><br><span class="line">    conn.setblocking(<span class="literal">False</span>)</span><br><span class="line">    sel.register(conn, selectors.EVENT_READ, read)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">(conn, mask)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        data = conn.recv(<span class="number">1000</span>)  <span class="comment"># Should be ready</span></span><br><span class="line">        <span class="keyword">if</span> data:</span><br><span class="line">            print(<span class="string">'echoing'</span>, repr(data), <span class="string">'to'</span>, conn)</span><br><span class="line">            conn.send(data)  <span class="comment"># Hope it won't block</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">'closing'</span>, conn)</span><br><span class="line">            sel.unregister(conn)</span><br><span class="line">            conn.close()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print(e)</span><br><span class="line">        print(<span class="string">'closing'</span>, conn)</span><br><span class="line">        sel.unregister(conn)</span><br><span class="line">        conn.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sock = socket.socket()</span><br><span class="line">sock.bind((<span class="string">'localhost'</span>, <span class="number">8090</span>))</span><br><span class="line">sock.listen(<span class="number">100</span>)</span><br><span class="line">sock.setblocking(<span class="literal">False</span>)</span><br><span class="line">sel.register(sock, selectors.EVENT_READ, accept)</span><br><span class="line"></span><br><span class="line">print(<span class="string">'server is starting..........'</span>)</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    events = sel.select()</span><br><span class="line">    <span class="keyword">for</span> key, mask <span class="keyword">in</span> events:</span><br><span class="line">        callback = key.data</span><br><span class="line">        callback(key.fileobj, mask)</span><br><span class="line"></span><br><span class="line">selectors_serrer</span><br></pre></td></tr></table></figure>



<p><strong>聊天</strong></p>
<p> client</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">@Datetime: 2018/9/6</span></span><br><span class="line"><span class="string">@Author: Zhang Yafei</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line">sk=socket.socket()</span><br><span class="line">sk.connect((<span class="string">'127.0.0.1'</span>,<span class="number">8801</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    inp=input(<span class="string">"&gt;&gt;&gt;&gt;"</span>)</span><br><span class="line">    sk.sendall(bytes(inp,<span class="string">"utf8"</span>))</span><br><span class="line">    data=sk.recv(<span class="number">1024</span>)</span><br><span class="line">    print(str(data,<span class="string">'utf8'</span>))</span><br><span class="line"></span><br><span class="line">client</span><br></pre></td></tr></table></figure>

<p> server</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">@Datetime: 2018/9/6</span></span><br><span class="line"><span class="string">@Author: Zhang Yafei</span></span><br><span class="line"><span class="string">"</span><span class="string">""</span></span><br><span class="line">import socket</span><br><span class="line">import select</span><br><span class="line"><span class="attribute">sk</span>=socket.socket()</span><br><span class="line">sk.bind((<span class="string">"127.0.0.1"</span>,8801))</span><br><span class="line">sk.listen(5)</span><br><span class="line">inputs=[sk,]</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    r,w,<span class="attribute">e</span>=select.select(inputs,[],[],5)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> obj <span class="keyword">in</span> r:</span><br><span class="line">        <span class="keyword">if</span> <span class="attribute">obj</span>==sk:</span><br><span class="line">            conn,<span class="attribute">add</span>=obj.accept()</span><br><span class="line">            <span class="builtin-name">print</span>(conn)</span><br><span class="line">            inputs.append(conn)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="attribute">data_byte</span>=obj.recv(1024)</span><br><span class="line">            <span class="builtin-name">print</span>(str(data_byte,<span class="string">'utf8'</span>))</span><br><span class="line">            <span class="attribute">inp</span>=input('回答%s号客户&gt;&gt;&gt;'%inputs.index(obj))</span><br><span class="line">            obj.sendall(bytes(inp,<span class="string">'utf8'</span>))</span><br><span class="line"></span><br><span class="line">    # <span class="builtin-name">print</span>(<span class="string">'&gt;&gt;'</span>,r)</span><br><span class="line"></span><br><span class="line">server</span><br></pre></td></tr></table></figure>



<p><strong>非阻塞IO</strong></p>
<p> client</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">@Datetime: 2018/9/6</span></span><br><span class="line"><span class="string">@Author: Zhang Yafei</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line">sk = socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    sk.connect((<span class="string">'127.0.0.1'</span>,<span class="number">6667</span>))</span><br><span class="line">    print(<span class="string">"hello"</span>)</span><br><span class="line">    sk.sendall(bytes(<span class="string">"hello"</span>,<span class="string">"utf8"</span>))</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">client</span><br></pre></td></tr></table></figure>

<p> server</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">@Datetime: 2018/9/6</span></span><br><span class="line"><span class="string">@Author: Zhang Yafei</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line">sk = socket(AF_INET,SOCK_STREAM)</span><br><span class="line">sk.setsockopt(SOL_SOCKET,SO_REUSEADDR,<span class="number">1</span>)</span><br><span class="line">sk.bind((<span class="string">'127.0.0.1'</span>,<span class="number">6667</span>))</span><br><span class="line">sk.listen(<span class="number">5</span>)</span><br><span class="line">sk.setblocking(<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> (<span class="string">'waiting client connection .......'</span>)</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        connection,address = sk.accept()   <span class="comment"># 进程主动轮询</span></span><br><span class="line">        print(<span class="string">"+++"</span>,address)</span><br><span class="line">        client_messge = connection.recv(<span class="number">1024</span>)</span><br><span class="line">        print(str(client_messge,<span class="string">'utf8'</span>))</span><br><span class="line">        connection.close()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print(e)</span><br><span class="line">        time.sleep(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">server</span><br></pre></td></tr></table></figure>



<p><strong>IO多路复用</strong></p>
<p> client</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">@Datetime: 2018/9/6</span></span><br><span class="line"><span class="string">@Author: Zhang Yafei</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">sk=socket.socket()</span><br><span class="line"></span><br><span class="line">sk.connect((<span class="string">"127.0.0.1"</span>,<span class="number">9904</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    inp=input(<span class="string">"&gt;&gt;"</span>).strip()</span><br><span class="line">    sk.send(inp.encode(<span class="string">"utf8"</span>))</span><br><span class="line">    data=sk.recv(<span class="number">1024</span>)</span><br><span class="line">    print(data.decode(<span class="string">"utf8"</span>))</span><br><span class="line"></span><br><span class="line">client</span><br></pre></td></tr></table></figure>

<p> server</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">@Datetime: 2018/9/6</span></span><br><span class="line"><span class="string">@Author: Zhang Yafei</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> select</span><br><span class="line">sk=socket.socket()</span><br><span class="line">sk.bind((<span class="string">"127.0.0.1"</span>,<span class="number">9904</span>))</span><br><span class="line">sk.listen(<span class="number">5</span>)</span><br><span class="line">inp = [sk,]</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    r,w,e=select.select(inp,[],[],<span class="number">5</span>) <span class="comment">#水平触发方式 r表示有人给我发送数据 w表示有人和我创建连接成功</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> r:</span><br><span class="line">        conn,add=i.accept()</span><br><span class="line">        <span class="comment">#print(conn)</span></span><br><span class="line">        inp.append(conn)</span><br><span class="line">        print(<span class="string">"hello"</span>)</span><br><span class="line">    print(<span class="string">'&gt;&gt;&gt;&gt;&gt;&gt;'</span>)</span><br><span class="line"></span><br><span class="line">server</span><br></pre></td></tr></table></figure>



<h1 id="二、select-FTP"><a href="#二、select-FTP" class="headerlink" title="二、select_FTP"></a><strong>二、select_FTP</strong></h1><p> client</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">@Datetime: 2018/9/7</span></span><br><span class="line"><span class="string">@Author: Zhang Yafei</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os,sys</span><br><span class="line"></span><br><span class="line">BASE_DIR = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">selectFtpClient</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.args = sys.argv</span><br><span class="line">        <span class="keyword">if</span> len(self.args) &gt; <span class="number">1</span>:</span><br><span class="line">            self.port = (self.args[<span class="number">1</span>],int(self.args[<span class="number">2</span>]))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.port = (<span class="string">'127.0.0.1'</span>,<span class="number">8080</span>)</span><br><span class="line">        self.create_socket()</span><br><span class="line">        self.command_fanout()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_socket</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.sk = socket(AF_INET,SOCK_STREAM)</span><br><span class="line">            self.sk.connect(self.port)</span><br><span class="line">            print(<span class="string">'连接FTP服务器成功！'</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            print(<span class="string">'error:'</span>,e)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">command_fanout</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            cmd = input(<span class="string">'&gt;&gt;:'</span>).strip()</span><br><span class="line">            <span class="keyword">if</span> cmd == <span class="string">'exit'</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            cmd,file = cmd.split()</span><br><span class="line">            <span class="keyword">if</span> hasattr(self,cmd):</span><br><span class="line">                func = getattr(self,cmd)</span><br><span class="line">                func(cmd,file)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                print(<span class="string">'调用错误！'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span><span class="params">(self,cmd,file)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> os.path.isfile(file):</span><br><span class="line">            fileName = os.path.basename(file)</span><br><span class="line">            fileSize = os.path.getsize(file)</span><br><span class="line">            fileiInfo = <span class="string">'%s|%s|%s'</span>%(cmd,fileName,fileSize)</span><br><span class="line">            self.sk.send(bytes(fileiInfo,encoding=<span class="string">'utf-8'</span>))</span><br><span class="line">            recvStatus = self.sk.recv(<span class="number">1024</span>)</span><br><span class="line">            print(<span class="string">'recvStatus:'</span>,recvStatus)</span><br><span class="line">            has_send = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> recvStatus.decode(<span class="string">'utf-8'</span>) == <span class="string">'OK'</span>:</span><br><span class="line">                <span class="keyword">with</span> open(file,<span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    <span class="keyword">while</span> has_send &lt; fileSize:</span><br><span class="line">                        content = f.read(<span class="number">1024</span>)</span><br><span class="line">                        recv_size = len(content)</span><br><span class="line">                        self.sk.send(content)</span><br><span class="line">                        has_send += recv_size</span><br><span class="line">                        s = str(int(has_send/fileSize*<span class="number">100</span>))+<span class="string">'%'</span></span><br><span class="line">                        print(<span class="string">'正在上传文件：'</span>+fileName+<span class="string">'已经上传：'</span>+s)</span><br><span class="line">                print(<span class="string">'%s文件上传完毕：'</span>%fileName)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">'文件不存在！'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    selectFtpClient()</span><br><span class="line"></span><br><span class="line">client</span><br></pre></td></tr></table></figure>

<p> server</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">@Datetime: 2018/9/7</span></span><br><span class="line"><span class="string">@Author: Zhang Yafei</span></span><br><span class="line"><span class="string">"</span><span class="string">""</span></span><br><span class="line">import os</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line">BASE_DIR = os.path.dirname(os.path.abspath(__file_<span class="number">_</span>))</span><br><span class="line"></span><br><span class="line">from socket import *</span><br><span class="line">import selectors</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">selectFtpServer</span>(<span class="title">object</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">self</span>.dic = &#123;&#125;</span><br><span class="line">        <span class="keyword">self</span>.hasReceived = <span class="number">0</span></span><br><span class="line">        <span class="keyword">self</span>.sel = selectors.DefaultSelector()</span><br><span class="line">        <span class="keyword">self</span>.create_socket()</span><br><span class="line">        <span class="keyword">self</span>.handle()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_socket</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        sk = socket(AF_INET,SOCK_STREAM)</span><br><span class="line">        sk.bind((<span class="string">'127.0.0.1'</span>,<span class="number">8080</span>))</span><br><span class="line">        sk.listen(<span class="number">100</span>)</span><br><span class="line">        sk.setblocking(False)</span><br><span class="line">        <span class="keyword">self</span>.sel.register(sk,selectors.EVENT_READ,<span class="keyword">self</span>.accept)</span><br><span class="line"></span><br><span class="line">        print(<span class="string">'服务端已开启，正在等待用户连接......'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="symbol">True:</span></span><br><span class="line">            events = <span class="keyword">self</span>.sel.select() <span class="comment">#[sock,conn1,conn2]</span></span><br><span class="line">            <span class="keyword">for</span> key,mask <span class="keyword">in</span> <span class="symbol">events:</span></span><br><span class="line">                callback = key.data</span><br><span class="line">                callback(key.fileobj,mask)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">accept</span><span class="params">(<span class="keyword">self</span>,sock,mask)</span></span><span class="symbol">:</span></span><br><span class="line">        conn,addr = sock.accept()</span><br><span class="line">        print(addr)</span><br><span class="line">        print(type(addr))</span><br><span class="line">        print(<span class="string">'from %s %s connected'</span>%addr)</span><br><span class="line">        conn.setblocking(False)</span><br><span class="line">        <span class="keyword">self</span>.sel.register(conn,selectors.EVENT_READ,<span class="keyword">self</span>.read)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.dic[conn] = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">(<span class="keyword">self</span>,conn,mask)</span></span><span class="symbol">:</span></span><br><span class="line">        <span class="symbol">try:</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">self</span>.dic[conn]<span class="symbol">:</span></span><br><span class="line">                data = conn.recv(<span class="number">1024</span>)</span><br><span class="line">                cmd,fileName,fileSize = str(data,encoding=<span class="string">'utf-8'</span>).split(<span class="string">'|'</span>)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">self</span>.dic = &#123;<span class="symbol">conn:</span>&#123;<span class="string">'cmd'</span><span class="symbol">:cmd</span>,<span class="string">'fileName'</span><span class="symbol">:fileName</span>,<span class="string">'fileSize'</span><span class="symbol">:int</span>(fileSize)&#125;&#125;</span><br><span class="line">                <span class="keyword">if</span> cmd == <span class="string">'put'</span><span class="symbol">:</span></span><br><span class="line">                    conn.send(bytes(<span class="string">'OK'</span>,encoding=<span class="string">'utf-8'</span>))</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> cmd == <span class="string">'get'</span><span class="symbol">:</span></span><br><span class="line">                    file = os.path.join(BASE_DIR,<span class="string">'download'</span>,fileName)</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> os.path.exists(file)<span class="symbol">:</span></span><br><span class="line">                        file_size = os.path.getsize(file)</span><br><span class="line">                        send_info = <span class="string">'%s|%s'</span><span class="string">%('YES',file_size)</span></span><br><span class="line">                        conn.send(bytes(send_info,encoding=<span class="string">'utf-8'</span>))</span><br><span class="line">                    <span class="symbol">else:</span></span><br><span class="line">                        send_info = <span class="string">'%s|%s'</span><span class="string">%('NO',0)</span></span><br><span class="line">                        conn.send(bytes(send_info,encoding=<span class="string">'utf-8'</span>))</span><br><span class="line">            <span class="symbol">else:</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">self</span>.dic[conn].get(<span class="string">'cmd'</span>,None)<span class="symbol">:</span></span><br><span class="line">                    cmd = <span class="keyword">self</span>.dic[conn].get(<span class="string">'cmd'</span>)</span><br><span class="line">                    <span class="keyword">if</span> hasattr(<span class="keyword">self</span>,cmd)<span class="symbol">:</span></span><br><span class="line">                        func = getattr(<span class="keyword">self</span>,cmd)</span><br><span class="line">                        func(conn)</span><br><span class="line">                    <span class="symbol">else:</span></span><br><span class="line">                        print(<span class="string">'error cmd!'</span>)</span><br><span class="line">                        conn.close()</span><br><span class="line">                <span class="symbol">else:</span></span><br><span class="line">                    print(<span class="string">'error cmd!'</span>)</span><br><span class="line">                    conn.close()</span><br><span class="line">        except Exception as <span class="symbol">e:</span></span><br><span class="line">            print(<span class="string">'error:'</span>,e)</span><br><span class="line">            <span class="keyword">self</span>.sel.unregister(conn)</span><br><span class="line">            conn.close()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span><span class="params">(<span class="keyword">self</span>,conn)</span></span><span class="symbol">:</span></span><br><span class="line">        fileName = <span class="keyword">self</span>.dic[conn][<span class="string">'fileName'</span>]</span><br><span class="line">        fileSize = <span class="keyword">self</span>.dic[conn][<span class="string">'fileSize'</span>]</span><br><span class="line">        path = os.path.join(BASE_DIR,<span class="string">'upload'</span>,fileName)</span><br><span class="line">        f = open(path,<span class="string">'ab'</span>)</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">self</span>.hasReceived &lt; <span class="symbol">fileSize:</span></span><br><span class="line">            <span class="symbol">try:</span></span><br><span class="line">                recv_data = conn.recv(<span class="number">1024</span>)</span><br><span class="line">            <span class="symbol">except:</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            f.write(recv_data)</span><br><span class="line">            <span class="keyword">self</span>.hasReceived += len(recv_data)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> fileSize == <span class="keyword">self</span>.<span class="symbol">hasReceived:</span></span><br><span class="line">            <span class="keyword">self</span>.hasReceived = <span class="number">0</span></span><br><span class="line">            <span class="keyword">if</span> conn <span class="keyword">in</span> <span class="keyword">self</span>.dic.keys()<span class="symbol">:</span></span><br><span class="line">                <span class="keyword">self</span>.dic[conn] = &#123;&#125;</span><br><span class="line">            print(<span class="string">'%s上传完毕！'</span>%fileName)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(<span class="keyword">self</span>,conn)</span></span><span class="symbol">:</span></span><br><span class="line">        pass</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name_<span class="number">_</span> == <span class="string">'__main__'</span><span class="symbol">:</span></span><br><span class="line">    selectFtpServer()</span><br><span class="line"></span><br><span class="line">server</span><br></pre></td></tr></table></figure>



<h1 id="三、GIL"><a href="#三、GIL" class="headerlink" title="三、GIL"></a><strong>三、GIL</strong></h1><ul>
<li><strong>GIL(全局解释器锁）</strong>（Global Interpreter Lock）是计算机程序设计语言解释器用于同步线程的工具，使得任何时刻一个进程仅有一个线程占用cpu</li>
<li><strong>这就造成了多线程不能同时执行，并且增加了切换的开销，串行的效率可能更高</strong></li>
</ul>
<h1 id="四、进程"><a href="#四、进程" class="headerlink" title="四、进程"></a><strong>四、进程</strong></h1><ul>
<li>进程定义：最小的资源单位</li>
<li>进程就是一个程序在一个数据集上的一次动态执行过程。（抽象）</li>
<li>进程一般由程序、数据集、进程控制块三部分组成。</li>
<li>我们编写的程序用来描述进程要完成哪些功能以及如何完成；</li>
<li>数据集则是程序在执行过程中所需要使用的资源；</li>
<li>进程控制块用来记录进程的外部特征，描述进程的执行变化过程，系统可以利用它来控制和管理进程，它是系</li>
<li>统感知进程存在的唯一标志</li>
</ul>
<h2 id="1-进程的调用"><a href="#1-进程的调用" class="headerlink" title="1. 进程的调用"></a>1. 进程的调用</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">@Datetime: 2018/9/6</span></span><br><span class="line"><span class="string">@Author: Zhang Yafei</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">#并行</span></span><br><span class="line"><span class="string">from multiprocessing import Process</span></span><br><span class="line"><span class="string">import time</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">def f(name):</span></span><br><span class="line"><span class="string">    time.sleep(1)</span></span><br><span class="line"><span class="string">    print('hello', name,time.ctime())</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">if __name__ == '__main__':</span></span><br><span class="line"><span class="string">    p_list=[]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    for i in range(3):</span></span><br><span class="line"><span class="string">        p = Process(target=f, args=('alvin',))</span></span><br><span class="line"><span class="string">        p_list.append(p)</span></span><br><span class="line"><span class="string">        p.start()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    for p in p_list:</span></span><br><span class="line"><span class="string">        p.join()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    print('ending....')</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">from multiprocessing import Process</span></span><br><span class="line"><span class="string">import time</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">class MyProcess(Process):</span></span><br><span class="line"><span class="string">    def __init__(self):</span></span><br><span class="line"><span class="string">        super(MyProcess, self).__init__()</span></span><br><span class="line"><span class="string">        #self.name = name</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    def run(self):</span></span><br><span class="line"><span class="string">        time.sleep(1)</span></span><br><span class="line"><span class="string">        print('hello', self.name,time.ctime())</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">if __name__ == '__main__':</span></span><br><span class="line"><span class="string">    p_list=[]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    for i in range(3):</span></span><br><span class="line"><span class="string">        p = MyProcess()</span></span><br><span class="line"><span class="string">        p.daemon = True</span></span><br><span class="line"><span class="string">        p.start()</span></span><br><span class="line"><span class="string">        p_list.append(p)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    # for p in p_list:</span></span><br><span class="line"><span class="string">    #     p.join()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    print('ending......')</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">info</span><span class="params">(title)</span>:</span></span><br><span class="line">    print(<span class="string">"title:"</span>, title)</span><br><span class="line">    print(<span class="string">'parent process:'</span>, os.getppid())</span><br><span class="line">    print(<span class="string">'process id:'</span>, os.getpid())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span><span class="params">(name)</span>:</span></span><br><span class="line">    info(<span class="string">'function f'</span>)</span><br><span class="line">    print(<span class="string">'hello'</span>, name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    info(<span class="string">'main process line'</span>)</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    print(<span class="string">"------------------"</span>)</span><br><span class="line">    p = Process(target=info, args=(<span class="string">'fei'</span>,))</span><br><span class="line">    p.start()</span><br><span class="line">    p.join()</span><br></pre></td></tr></table></figure>



<h2 id="2-process类"><a href="#2-process类" class="headerlink" title="2. process类"></a>2. process类</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">@Datetime: 2018/9/6</span></span><br><span class="line"><span class="string">@Author: Zhang Yafei</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyProcess</span><span class="params">(Process)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,num)</span>:</span></span><br><span class="line">        super(MyProcess, self).__init__()</span><br><span class="line">        self.num = num</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        print(self.pid)</span><br><span class="line">        print(self.is_alive())</span><br><span class="line">        print(self.num)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    p_list=[]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">        p = MyProcess(i)</span><br><span class="line">        p_list.append(p)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> p_list:</span><br><span class="line">        p.start()</span><br><span class="line"></span><br><span class="line">    print(<span class="string">'main process end'</span>)</span><br></pre></td></tr></table></figure>



<h2 id="3-进程通信"><a href="#3-进程通信" class="headerlink" title="3. 进程通信"></a>3. 进程通信</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">@Datetime: 2018/9/6</span></span><br><span class="line"><span class="string">@Author: Zhang Yafei</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">"""方式一：进程队列 不能实现数据共享"""</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">import multiprocessing</span></span><br><span class="line"><span class="string">import time</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">def foo(q):</span></span><br><span class="line"><span class="string">    time.sleep(1)</span></span><br><span class="line"><span class="string">    print('son process:',id(q))</span></span><br><span class="line"><span class="string">    q.put(123)</span></span><br><span class="line"><span class="string">    q.put('fei')</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">if __name__ == '__main__':</span></span><br><span class="line"><span class="string">    # q = queue.Queue() #线程队列</span></span><br><span class="line"><span class="string">    q = multiprocessing.Queue()</span></span><br><span class="line"><span class="string">    p = multiprocessing.Process(target=foo,args=(q,))</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    p.start()</span></span><br><span class="line"><span class="string">    print('main process:',id(q))</span></span><br><span class="line"><span class="string">    print(q.get())</span></span><br><span class="line"><span class="string">    print(q.get())</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">"""方式二：管道 不能实现数据共享"""</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">from multiprocessing import Process, Pipe</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">def f(conn):</span></span><br><span class="line"><span class="string">    conn.send([12, &#123;"name":"yuan"&#125;,、 'hello']) #没走网络通道，所以不用转化成字节</span></span><br><span class="line"><span class="string">    response=conn.recv()</span></span><br><span class="line"><span class="string">    print("response",response)</span></span><br><span class="line"><span class="string">    conn.close()</span></span><br><span class="line"><span class="string">    print("q_ID2:",id(conn))</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">if __name__ == '__main__':</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    parent_conn, child_conn = Pipe()</span></span><br><span class="line"><span class="string">    print("q_ID1:",id(child_conn))</span></span><br><span class="line"><span class="string">    p = Process(target=f, args=(child_conn,))</span></span><br><span class="line"><span class="string">    p.start()</span></span><br><span class="line"><span class="string">    print(parent_conn.recv())   # prints "[42, None, 'hello']"</span></span><br><span class="line"><span class="string">    parent_conn.send("儿子你好!")</span></span><br><span class="line"><span class="string">    p.join()</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">"""Queue和pipe只是实现了数据交互，并没实现数据共享，即一个进程去更改另一个进程的数据。"""</span></span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process, Manager</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span><span class="params">(d, l,n)</span>:</span></span><br><span class="line">    d[n] = <span class="string">'1'</span> <span class="comment">#&#123;0:'1'&#125;</span></span><br><span class="line">    d[<span class="string">'2'</span>] = <span class="number">2</span>  <span class="comment">#&#123;0:'1','2':2&#125;</span></span><br><span class="line">    l.append(n) <span class="comment">#[0,1,2,3,4,0,1,2,3,4,5,6,7,8,9]</span></span><br><span class="line">    <span class="comment">#print(l)</span></span><br><span class="line"></span><br><span class="line">    print(<span class="string">"son process:"</span>,id(d),id(l))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> Manager() <span class="keyword">as</span> manager:</span><br><span class="line">        d = manager.dict()</span><br><span class="line">        l = manager.list(range(<span class="number">5</span>)) <span class="comment">#[0,1,2,3,4]</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># print("main process:",id(d),id(l))</span></span><br><span class="line"></span><br><span class="line">        p_list = []</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">            p = Process(target=f, args=(d,l,i))</span><br><span class="line">            p.start()</span><br><span class="line">            p_list.append(p)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> res <span class="keyword">in</span> p_list:</span><br><span class="line">            res.join()</span><br><span class="line"></span><br><span class="line">        print(d)</span><br><span class="line">        print(l)</span><br></pre></td></tr></table></figure>



<h2 id="4-进程同步"><a href="#4-进程同步" class="headerlink" title="4. 进程同步"></a>4. 进程同步</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">@Datetime: 2018/9/6</span></span><br><span class="line"><span class="string">@Author: Zhang Yafei</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process, Lock</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span><span class="params">(l, i)</span>:</span></span><br><span class="line">    l.acquire()</span><br><span class="line">    print(<span class="string">'hello world %s'</span> % i)</span><br><span class="line">    l.release()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    lock = Lock()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> num <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">        Process(target=f, args=(lock, num)).start()</span><br></pre></td></tr></table></figure>



<h2 id="5-多进程"><a href="#5-多进程" class="headerlink" title="5. 多进程"></a>5. 多进程</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">@Datetime: 2018/9/6</span></span><br><span class="line"><span class="string">@Author: Zhang Yafei</span></span><br><span class="line"><span class="string">"</span><span class="string">""</span></span><br><span class="line"><span class="keyword">from</span> multiprocessing import Process,Pool</span><br><span class="line">import time,os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def Foo(i):</span><br><span class="line">    time.sleep(1)</span><br><span class="line">    <span class="builtin-name">print</span>(i)</span><br><span class="line">    <span class="builtin-name">print</span>(<span class="string">'son process:'</span>,os.getpid())</span><br><span class="line">    return <span class="string">'hello %s'</span>%i</span><br><span class="line"></span><br><span class="line"><span class="comment">#回调函数由主进程调用</span></span><br><span class="line">def Bar(arg):</span><br><span class="line">    <span class="builtin-name">print</span>(arg)</span><br><span class="line">    <span class="builtin-name">print</span>(<span class="string">'callback process:'</span>,os.getpid())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">   <span class="built_in"> pool </span>= Pool(5)</span><br><span class="line">    <span class="builtin-name">print</span>(<span class="string">'main process:'</span>,os.getpid())</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(10):</span><br><span class="line">    #     pool.apply(<span class="attribute">func</span>=Foo,args=(i,)) #同步接口</span><br><span class="line">    #回调函数：某个动作或函数执行结束之后再去执行的函数</span><br><span class="line">        pool.apply_async(<span class="attribute">func</span>=Foo, args=(i,),<span class="attribute">callback</span>=Bar)</span><br><span class="line"></span><br><span class="line">    # pool.map(Foo, [i <span class="keyword">for</span> i <span class="keyword">in</span> range(100)])</span><br><span class="line"></span><br><span class="line">    pool.close()</span><br><span class="line">    pool.join()</span><br><span class="line">    <span class="builtin-name">print</span>(<span class="string">'end'</span>)</span><br></pre></td></tr></table></figure>



<h1 id="五、线程"><a href="#五、线程" class="headerlink" title="五、线程"></a><strong>五、线程</strong></h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">线程：最小的执行单位</span><br><span class="line">进程和线程的区别</span><br></pre></td></tr></table></figure>

<ul>
<li><p>(1)、一个程序至少有一个进程,一个进程至少有一个线程.(进程可以理解成线程的容器)</p>
</li>
<li><p>(2)、进程在执行过程中拥有独立的内存单元，而多个线程共享内存，从而极大地提高了程序的运行效率。</p>
</li>
<li><p>(3)、线程在执行过程中与进程还是有区别的。每个独立的线程有一个程序运行的入口、顺序执行序列和</p>
<p>程序的出口。但是线程不能够独立执行，必须依存在应用程序中，由应用程序提供多个线程执行控制。</p>
</li>
<li><p>(4)、进程是具有一定独立功能的程序关于某个数据集合上的一次运行活动,进程是系统进行资源分配和调</p>
<p>度的一个独立单位. 线程是进程的一个实体,是CPU调度和分派的基本单位,它是比进程更小的能独立运行的基本单位.线程</p>
<p>自己基本上不拥有系统资源,只拥有一点在运行中必不可少的资源(如程序计数器,一组寄存器和栈)但是</p>
<p>它可与同属一个进程的其他的线程共享进程所拥有的全部资源.</p>
<p>一个线程可以创建和撤销另一个线程;同一个进程中的多个线程之间可以并发执行.</p>
</li>
</ul>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">同步锁<span class="comment">(互斥锁)</span>：对某一段程序设置同步锁，在这段程序内禁止cpu切换，只能串行。</span><br></pre></td></tr></table></figure>



<h2 id="1-线程继承"><a href="#1-线程继承" class="headerlink" title="1. 线程继承"></a>1. 线程继承</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">@Datetime: 2018/9/5</span></span><br><span class="line"><span class="string">@Author: Zhang Yafei</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span><span class="params">(threading.Thread)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, num)</span>:</span></span><br><span class="line">        threading.Thread.__init__(self)</span><br><span class="line">        self.num = num</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span>  <span class="comment"># 定义每个线程要运行的函数</span></span><br><span class="line"></span><br><span class="line">        print(<span class="string">"running on number:%s"</span> % self.num)</span><br><span class="line"></span><br><span class="line">        time.sleep(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    t1 = MyThread(<span class="number">1</span>)</span><br><span class="line">    t2 = MyThread(<span class="number">2</span>)</span><br><span class="line">    t1.start()</span><br><span class="line">    t2.start()</span><br><span class="line"></span><br><span class="line">    print(<span class="string">"ending......"</span>)</span><br><span class="line"></span><br><span class="line">线程继承</span><br></pre></td></tr></table></figure>



<h2 id="2-计算密集型任务"><a href="#2-计算密集型任务" class="headerlink" title="2. 计算密集型任务"></a>2. 计算密集型任务</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">@Datetime: 2018/9/6</span></span><br><span class="line"><span class="string">@Author: Zhang Yafei</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">()</span>:</span></span><br><span class="line">    sum = <span class="number">0</span></span><br><span class="line">    i = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> i&lt;=<span class="number">1000000</span>:</span><br><span class="line">        sum += i</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    print(<span class="string">'sum:'</span>,sum)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mul</span><span class="params">()</span>:</span></span><br><span class="line">    sum2 = <span class="number">1</span></span><br><span class="line">    i = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> i&lt;=<span class="number">100000</span>:</span><br><span class="line">        sum2 = sum2 * i</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    print(<span class="string">'sum2:'</span>,sum2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">start = time.time()</span><br><span class="line">t1 = Thread(target=add)</span><br><span class="line">t2 = Thread(target=mul)</span><br><span class="line"></span><br><span class="line">l = []</span><br><span class="line">l.append(t1)</span><br><span class="line">l.append(t2)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span> l:</span><br><span class="line">   t.start()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span> l:</span><br><span class="line">    t.join()</span><br><span class="line"><span class="comment"># add()</span></span><br><span class="line"><span class="comment"># mul() #串行比多线程还快</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">'cost time %s'</span>%(time.time()-start))</span><br><span class="line"></span><br><span class="line">计算密集型任务</span><br></pre></td></tr></table></figure>



<h2 id="3-同步锁"><a href="#3-同步锁" class="headerlink" title="3. 同步锁"></a>3. 同步锁</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">@Datetime: 2018/9/6</span></span><br><span class="line"><span class="string">@Author: Zhang Yafei</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"></span><br><span class="line">num = <span class="number">100</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sub</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">global</span> num</span><br><span class="line">    <span class="comment"># num -= 1 #没有IO操作，计算型任务，多线程不起作用，cpu会按照时间轮询切换，而这个操作时间太短，打不倒轮询的时间</span></span><br><span class="line">    lock.acquire() <span class="comment">#开启同步锁</span></span><br><span class="line">    temp = num</span><br><span class="line">    time.sleep(<span class="number">0.01</span>) <span class="comment">#IO阻塞，cpu会去执行其他线程，1秒时间足够长，所有线程拿到的temp都是100</span></span><br><span class="line">    num = temp<span class="number">-1</span></span><br><span class="line">    lock.release() <span class="comment">#释放同步锁</span></span><br><span class="line"></span><br><span class="line">l = []</span><br><span class="line">lock = threading.Lock()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">    t = Thread(target=sub)</span><br><span class="line">    t.start()</span><br><span class="line">    l.append(t)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span> l:</span><br><span class="line">    t.join()</span><br><span class="line"></span><br><span class="line">print(num)</span><br></pre></td></tr></table></figure>



<h2 id="4-递归锁"><a href="#4-递归锁" class="headerlink" title="4. 递归锁"></a>4. 递归锁</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">@Datetime: 2018/9/6</span></span><br><span class="line"><span class="string">@Author: Zhang Yafei</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span><span class="params">(threading.Thread)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">actionA</span><span class="params">(self)</span>:</span></span><br><span class="line">        r_lock.acquire()<span class="comment">#acquire一次，计数加一，只要计数大于零，其他线程将不能获得这把锁，这就造成</span></span><br><span class="line">        print(self.name,<span class="string">'getA'</span>,time.ctime())</span><br><span class="line">        time.sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">        r_lock.acquire()</span><br><span class="line">        print(self.name,<span class="string">'getB'</span>,time.ctime())</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        r_lock.release()</span><br><span class="line">        r_lock.release()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">actionB</span><span class="params">(self)</span>:</span></span><br><span class="line">        r_lock.acquire()</span><br><span class="line">        print(self.name,<span class="string">'getB'</span>,time.ctime())</span><br><span class="line">        time.sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">        r_lock.acquire()</span><br><span class="line">        print(self.name,<span class="string">'getA'</span>,time.ctime())</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        r_lock.release()</span><br><span class="line">        r_lock.release()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.actionA()</span><br><span class="line">        time.sleep(<span class="number">0.5</span>)</span><br><span class="line">        self.actionB()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># A = threading.Lock()</span></span><br><span class="line">    <span class="comment"># B = threading.Lock()</span></span><br><span class="line"></span><br><span class="line">    r_lock = threading.RLock()</span><br><span class="line"></span><br><span class="line">    L = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">        t = MyThread()</span><br><span class="line">        t.start()</span><br><span class="line">        L.append(t)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> L:</span><br><span class="line">        t.join()</span><br><span class="line"></span><br><span class="line">    print(<span class="string">'ending.....'</span>)</span><br></pre></td></tr></table></figure>



<h2 id="5-同步对象"><a href="#5-同步对象" class="headerlink" title="5. 同步对象"></a>5. 同步对象</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">@Datetime: 2018/9/6</span></span><br><span class="line"><span class="string">@Author: Zhang Yafei</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">import</span> threading,time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Boss</span><span class="params">(threading.Thread)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">"BOSS：今晚大家都要加班到22:00。"</span>)</span><br><span class="line">        print(event.isSet()) <span class="comment">#FALSE</span></span><br><span class="line">        event.set()</span><br><span class="line">        time.sleep(<span class="number">5</span>)</span><br><span class="line">        print(<span class="string">"BOSS：&lt;22:00&gt;可以下班了。"</span>)</span><br><span class="line">        print(event.isSet())</span><br><span class="line">        event.set() <span class="comment">#event设定之后，员工的wait解除，可以向下执行</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Worker</span><span class="params">(threading.Thread)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        event.wait()  <span class="comment">#一旦event被设定，等同于pass</span></span><br><span class="line">        print(<span class="string">"Worker：哎……命苦啊！"</span>)</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        event.clear() <span class="comment">#清空event.set，目的是为了等待老板的一句话</span></span><br><span class="line">        event.wait()</span><br><span class="line">        print(<span class="string">"Worker：OhYeah!"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:</span><br><span class="line">    event=threading.Event()</span><br><span class="line">    threads=[]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">        threads.append(Worker())</span><br><span class="line">    threads.append(Boss())</span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">        t.start()</span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> threads:</span><br><span class="line">        t.join()</span><br><span class="line"></span><br><span class="line">    print(<span class="string">'ending.....'</span>)</span><br></pre></td></tr></table></figure>



<h2 id="6-信号量"><a href="#6-信号量" class="headerlink" title="6. 信号量"></a>6. 信号量</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">@Datetime: 2018/9/6</span></span><br><span class="line"><span class="string">@Author: Zhang Yafei</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">import</span> threading,time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myThread</span><span class="params">(threading.Thread)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> semaphore.acquire():</span><br><span class="line">            print(self.name)</span><br><span class="line">            time.sleep(<span class="number">3</span>)</span><br><span class="line">            semaphore.release()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:</span><br><span class="line">    semaphore=threading.Semaphore(<span class="number">5</span>) <span class="comment">#允许同时运行多少个线程</span></span><br><span class="line">    thrs=[]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        thrs.append(myThread())</span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> thrs:</span><br><span class="line">        t.start()</span><br></pre></td></tr></table></figure>



<h2 id="7-队列"><a href="#7-队列" class="headerlink" title="7. 队列"></a>7. 队列</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">""</span><span class="comment">"</span></span><br><span class="line">@Datetime: <span class="number">2018</span>/<span class="number">9</span>/<span class="number">6</span></span><br><span class="line">@Author: Zhang Yafei</span><br><span class="line"><span class="string">""</span><span class="comment">"</span></span><br><span class="line"><span class="string">""</span><span class="string">"列表是不安全的数据结构"</span><span class="string">""</span></span><br><span class="line"><span class="string">""</span><span class="comment">"</span></span><br><span class="line">#先进先出 FIFO 队列是为了线程同步而使用的，多个线程共享变量</span><br><span class="line">import threading,time</span><br><span class="line"></span><br><span class="line">li=[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>]</span><br><span class="line"></span><br><span class="line">def pri():</span><br><span class="line">    <span class="keyword">while</span> li:</span><br><span class="line">        <span class="keyword">a</span>=li[-<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">print</span>(<span class="keyword">a</span>)</span><br><span class="line">        time.<span class="keyword">sleep</span>(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            li.<span class="built_in">remove</span>(<span class="keyword">a</span>)</span><br><span class="line">        except Exception <span class="keyword">as</span> <span class="keyword">e</span>:</span><br><span class="line">            <span class="keyword">print</span>(<span class="string">'----'</span>,<span class="keyword">a</span>,<span class="keyword">e</span>)</span><br><span class="line"></span><br><span class="line">t1=threading.Thread(target=pri,<span class="keyword">args</span>=())</span><br><span class="line">t1.start()</span><br><span class="line">t2=threading.Thread(target=pri,<span class="keyword">args</span>=())</span><br><span class="line">t2.start()</span><br><span class="line"><span class="string">""</span><span class="comment">"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">""</span><span class="comment">"</span></span><br><span class="line">import queue #线程队列</span><br><span class="line"></span><br><span class="line">q = queue.Queue(<span class="number">3</span>) #设置最大队列长度</span><br><span class="line"></span><br><span class="line">q.<span class="keyword">put</span>(<span class="number">12</span>)</span><br><span class="line">q.<span class="keyword">put</span>(<span class="string">'hello'</span>)</span><br><span class="line">q.<span class="keyword">put</span>(&#123;<span class="string">'name'</span>:<span class="string">'fei'</span>&#125;)</span><br><span class="line"></span><br><span class="line">q.<span class="keyword">put</span>(<span class="number">34</span>,block=False) #若添加不进去，报错，不阻塞</span><br><span class="line"><span class="keyword">while</span> True:</span><br><span class="line">    data = q.<span class="built_in">get</span>(block=False) #若取不到值，不阻塞，报错</span><br><span class="line">    <span class="keyword">print</span>(q.qsize())</span><br><span class="line">    <span class="keyword">print</span>(data)</span><br><span class="line">    <span class="keyword">print</span>(<span class="string">'-----------'</span>)</span><br><span class="line">    <span class="keyword">if</span> q.qsize()  == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="string">""</span><span class="comment">"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">""</span><span class="comment">"</span></span><br><span class="line">#后进先出</span><br><span class="line">import queue</span><br><span class="line"></span><br><span class="line">q = queue.LifoQueue()</span><br><span class="line"></span><br><span class="line">q.<span class="keyword">put</span>(<span class="number">12</span>)</span><br><span class="line">q.<span class="keyword">put</span>(<span class="string">'hello'</span>)</span><br><span class="line">q.<span class="keyword">put</span>(&#123;<span class="string">'name'</span>:<span class="string">'fei'</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> True:</span><br><span class="line">    data = q.<span class="built_in">get</span>()</span><br><span class="line">    <span class="keyword">print</span>(data)</span><br><span class="line">    <span class="keyword">print</span>(<span class="string">'--------'</span>)</span><br><span class="line"><span class="string">""</span><span class="comment">"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#高优先级优先</span><br><span class="line">import queue</span><br><span class="line"></span><br><span class="line">q = queue.PriorityQueue(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">q.<span class="keyword">put</span>([<span class="number">3</span>,<span class="number">12</span>])</span><br><span class="line">q.<span class="keyword">put</span>([<span class="number">2</span>,<span class="string">'hello'</span>])</span><br><span class="line">q.<span class="keyword">put</span>([<span class="number">4</span>,&#123;<span class="string">'name'</span>:<span class="string">'fei'</span>&#125;])</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span>(q.qsize())</span><br><span class="line"><span class="keyword">print</span>(q.<span class="built_in">empty</span>())</span><br><span class="line"><span class="keyword">print</span>(q.full())</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> True:</span><br><span class="line">    data = q.<span class="built_in">get</span>()</span><br><span class="line">    <span class="keyword">print</span>(data[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">print</span>(<span class="string">'--------'</span>)</span><br></pre></td></tr></table></figure>



<h2 id="8-多线程一"><a href="#8-多线程一" class="headerlink" title="8. 多线程一"></a>8. 多线程一</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">@Datetime: 2018/9/5</span></span><br><span class="line"><span class="string">@Author: Zhang Yafei</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">import</span> threading <span class="comment">#线程</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">H</span><span class="params">(num)</span>:</span></span><br><span class="line">    print(<span class="string">'hello &#123;&#125;'</span>.format(num))</span><br><span class="line">    time.sleep(<span class="number">3</span>)</span><br><span class="line">    print(time.time())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    t1 = threading.Thread(target=H, args=(<span class="number">10</span>,)) <span class="comment">#创建一个线程对象t1 子线程</span></span><br><span class="line">    t1.start()</span><br><span class="line"></span><br><span class="line">    t2 = threading.Thread(target=H, args=(<span class="number">9</span>,)) <span class="comment">#创建一个线程对象t2 子线程</span></span><br><span class="line">    t2.start()</span><br><span class="line"></span><br><span class="line">    print(<span class="string">'ending.......'</span>) <span class="comment">#主线程</span></span><br><span class="line">    print(time.time())</span><br></pre></td></tr></table></figure>



<h2 id="9-多线程二"><a href="#9-多线程二" class="headerlink" title="9. 多线程二"></a>9. 多线程二</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">@Datetime: 2018/9/5</span></span><br><span class="line"><span class="string">@Author: Zhang Yafei</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">import</span> threading <span class="comment">#线程</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">music</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'begin to listen music &#123;&#125;'</span>.format(time.ctime()))</span><br><span class="line">    time.sleep(<span class="number">3</span>)</span><br><span class="line">    print(<span class="string">'stop to listen music &#123;&#125;'</span>.format(time.ctime()))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">game</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'begin to play game &#123;&#125;'</span>.format(time.ctime()))</span><br><span class="line">    time.sleep(<span class="number">5</span>)</span><br><span class="line">    print(<span class="string">'stop to play game &#123;&#125;'</span>.format(time.ctime()))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    music()</span><br><span class="line">    game()</span><br><span class="line">    print(<span class="string">'ending.....'</span>)</span><br><span class="line">    <span class="comment"># t1 = threading.Thread(target=music) #创建一个线程对象t1 子线程</span></span><br><span class="line">    <span class="comment"># t2 = threading.Thread(target=game) #创建一个线程对象t2 子线程</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># t1.start()</span></span><br><span class="line">    <span class="comment"># t2.start()</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># # t1.join() #等待子线程执行完 t1不执行完，谁也不准往下走</span></span><br><span class="line">    <span class="comment"># t2.join()</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># print('ending.......') #主线程</span></span><br><span class="line">    <span class="comment"># print(time.ctime())</span></span><br></pre></td></tr></table></figure>



<h2 id="10-多线程三"><a href="#10-多线程三" class="headerlink" title="10. 多线程三"></a>10. 多线程三</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">@Datetime: 2018/9/5</span></span><br><span class="line"><span class="string">@Author: Zhang Yafei</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="comment">#http://www.cnblogs.com/yuanchenqi/articles/6248025.html</span></span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> ctime,sleep</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ListenMusic</span><span class="params">(name)</span>:</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">print</span> (<span class="string">"Begin listening to %s. %s"</span> %(name,ctime()))</span><br><span class="line">        sleep(<span class="number">3</span>) <span class="comment">#sleep等同于IO操作</span></span><br><span class="line">        print(<span class="string">"end listening %s"</span>%ctime())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">RecordBlog</span><span class="params">(title)</span>:</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">print</span> (<span class="string">"Begin recording the %s! %s"</span> %(title,ctime()))</span><br><span class="line">        sleep(<span class="number">5</span>)</span><br><span class="line">        print(<span class="string">'end recording %s'</span>%ctime())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">threads = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">t1 = threading.Thread(target=ListenMusic,args=(<span class="string">'水手'</span>,))</span><br><span class="line">t2 = threading.Thread(target=RecordBlog,args=(<span class="string">'python线程'</span>,))</span><br><span class="line"></span><br><span class="line">threads.append(t1)</span><br><span class="line">threads.append(t2)</span><br></pre></td></tr></table></figure>



<h2 id="11-生产者消费者模型"><a href="#11-生产者消费者模型" class="headerlink" title="11. 生产者消费者模型"></a>11. 生产者消费者模型</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"># -*- codin<span class="variable">g:</span> utf-<span class="number">8</span> -*-</span><br><span class="line"></span><br><span class="line"><span class="string">""</span><span class="comment">"</span></span><br><span class="line">@Datetime: <span class="number">2018</span>/<span class="number">9</span>/<span class="number">6</span></span><br><span class="line">@Author: Zhang Yafei</span><br><span class="line"><span class="string">""</span><span class="comment">"</span></span><br><span class="line">import time,random</span><br><span class="line">import queue,threading</span><br><span class="line"></span><br><span class="line">q = queue.Queue()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def Producer(name):</span><br><span class="line">  <span class="built_in">count</span> = <span class="number">0</span></span><br><span class="line">  <span class="keyword">while</span> <span class="built_in">count</span> &lt;<span class="number">10</span>:</span><br><span class="line">    <span class="keyword">print</span>(<span class="string">"making........"</span>)</span><br><span class="line">    time.<span class="keyword">sleep</span>(<span class="number">5</span>)</span><br><span class="line">    q.<span class="keyword">put</span>(<span class="built_in">count</span>)</span><br><span class="line">    <span class="keyword">print</span>(<span class="string">'Producer %s has produced %s baozi..'</span> %(name, <span class="built_in">count</span>))</span><br><span class="line">    <span class="built_in">count</span> +=<span class="number">1</span></span><br><span class="line">    # q.task_done() #给队列发信号,我做好了一个包子</span><br><span class="line">    q.<span class="keyword">join</span>()</span><br><span class="line">    <span class="keyword">print</span>(<span class="string">"ok......"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def Consumer(name):</span><br><span class="line">  <span class="built_in">count</span> = <span class="number">0</span></span><br><span class="line">  <span class="keyword">while</span> <span class="built_in">count</span> &lt;<span class="number">10</span>:</span><br><span class="line">    time.<span class="keyword">sleep</span>(random.randrange(<span class="number">4</span>))</span><br><span class="line">    <span class="keyword">print</span>(<span class="string">'waiting......'</span>)</span><br><span class="line">    # q.<span class="keyword">join</span>() #等待</span><br><span class="line">    # <span class="keyword">if</span> not q.<span class="built_in">empty</span>():</span><br><span class="line">    data = q.<span class="built_in">get</span>()</span><br><span class="line">    <span class="keyword">print</span>(<span class="string">'eating....'</span>)</span><br><span class="line">    time.<span class="keyword">sleep</span>(<span class="number">4</span>)</span><br><span class="line">    q.task_done() #告诉厨师我吃完了一个包子</span><br><span class="line">    <span class="keyword">print</span>(<span class="string">'\033[32;1mConsumer %s has eat %s baozi...\033[0m'</span> %(name, data))</span><br><span class="line">    # <span class="keyword">else</span>:</span><br><span class="line">    #     <span class="keyword">print</span>(<span class="string">"-----no baozi anymore----"</span>)</span><br><span class="line">    <span class="built_in">count</span> +=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p1 = threading.Thread(target=Producer, <span class="keyword">args</span>=(<span class="string">'厨师A'</span>,))</span><br><span class="line">c1 = threading.Thread(target=Consumer, <span class="keyword">args</span>=(<span class="string">'B君'</span>,))</span><br><span class="line">c2 = threading.Thread(target=Consumer, <span class="keyword">args</span>=(<span class="string">'C君'</span>,))</span><br><span class="line">c3 = threading.Thread(target=Consumer, <span class="keyword">args</span>=(<span class="string">'D君'</span>,))</span><br><span class="line">p1.start()</span><br><span class="line">c1.start()</span><br><span class="line">c2.start()</span><br><span class="line">c3.start()</span><br></pre></td></tr></table></figure>



<h1 id="六、协程"><a href="#六、协程" class="headerlink" title="六、协程"></a><strong>六、协程</strong></h1><p>线程和进程的操作是由程序触发系统接口，最后的执行者是系统；协程的操作则是程序员。</p>
<p>协程存在的意义：对于多线程应用，CPU通过切片的方式来切换线程间的执行，线程切换时需要耗时（保存状态，下次继续）。协程，则只使用一个线程，在一个线程中规定某个代码块执行顺序。</p>
<p>协程的适用场景：当程序中存在大量不需要CPU的操作时（IO），适用于协程；</p>
<p> greenlet</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">@Datetime: 2018/9/6</span></span><br><span class="line"><span class="string">@Author: Zhang Yafei</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">from</span> greenlet <span class="keyword">import</span> greenlet</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test1</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="number">12</span>)</span><br><span class="line">    gr2.switch()</span><br><span class="line">    print(<span class="number">34</span>)</span><br><span class="line">    gr2.switch()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test2</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="number">56</span>)</span><br><span class="line">    gr1.switch()</span><br><span class="line">    print(<span class="number">78</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">gr1 = greenlet(test1)</span><br><span class="line">gr2 = greenlet(test2)</span><br><span class="line">gr1.switch()</span><br><span class="line"></span><br><span class="line">greenlet</span><br></pre></td></tr></table></figure>

<p> gevent</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">@Datetime: 2018/9/6</span></span><br><span class="line"><span class="string">@Author: Zhang Yafei</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">import</span> gevent</span><br><span class="line"><span class="keyword">import</span> requests,time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">start=time.time()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span><span class="params">(url)</span>:</span></span><br><span class="line">    print(<span class="string">'GET: %s'</span> % url)</span><br><span class="line">    resp =requests.get(url)</span><br><span class="line">    data = resp.text</span><br><span class="line">    print(<span class="string">'%d bytes received from %s.'</span> % (len(data), url))</span><br><span class="line"></span><br><span class="line">gevent.joinall([</span><br><span class="line"></span><br><span class="line">        gevent.spawn(f, <span class="string">'https://www.python.org/'</span>),</span><br><span class="line">        gevent.spawn(f, <span class="string">'https://www.yahoo.com/'</span>),</span><br><span class="line">        gevent.spawn(f, <span class="string">'https://www.baidu.com/'</span>),</span><br><span class="line">        gevent.spawn(f, <span class="string">'https://www.sina.com.cn/'</span>),</span><br><span class="line"></span><br><span class="line">])</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># f('https://www.python.org/')</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># f('https://www.yahoo.com/')</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># f('https://baidu.com/')</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># f('https://www.sina.com.cn/')</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">"cost time:"</span>,time.time()-start)</span><br><span class="line"></span><br><span class="line">gevent</span><br></pre></td></tr></table></figure>

<p> yield</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">@Datetime: 2018/9/6</span></span><br><span class="line"><span class="string">@Author: Zhang Yafei</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> queue</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">consumer</span><span class="params">(name)</span>:</span></span><br><span class="line">    print(<span class="string">"---&gt;ready to eat baozi..."</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        new_baozi = <span class="keyword">yield</span></span><br><span class="line">        print(<span class="string">"[%s] is eating baozi %s"</span> % (name,new_baozi))</span><br><span class="line">        <span class="comment">#time.sleep(1)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">producer</span><span class="params">()</span>:</span></span><br><span class="line"></span><br><span class="line">    r = con.__next__()</span><br><span class="line">    r = con2.__next__()</span><br><span class="line">    n = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        print(<span class="string">"\033[32;1m[producer]\033[0m is making baozi %s and %s"</span> %(n,n+<span class="number">1</span>) )</span><br><span class="line">        con.send(n)</span><br><span class="line">        con2.send(n+<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        n +=<span class="number">2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    con = consumer(<span class="string">"c1"</span>)</span><br><span class="line">    con2 = consumer(<span class="string">"c2"</span>)</span><br><span class="line">    p = producer()</span><br><span class="line"></span><br><span class="line"><span class="keyword">yield</span></span><br></pre></td></tr></table></figure>



    </div>

    
    
    
      
  <div class="popular-posts-header">相关文章推荐</div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\2008\01\04\python\2008-01-04-python-draft\" rel="bookmark">python-draft</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\2008\01\05\python\2008-01-04-python-ruan\" rel="bookmark">python-ruan</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\2021\11\25\python\python_基础篇\基础篇-目录\" rel="bookmark">基础篇</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\2022\03\03\python\python_举例\举例\" rel="bookmark">举例</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\2021\11\24\python\python_基础篇\第13篇：字典集合最佳练习\" rel="bookmark">第13篇：字典集合最佳练习</a></div>
    </li>
  </ul>

        <div class="reward-container">
  <div>赞赏一下吧～</div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/alipay.png" alt="tongsiying 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>tongsiying
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://tongsiying.github.io/2022/01/17/python/python_%E5%9F%BA%E7%A1%80%E7%AF%87/%E7%AC%AC33%E7%AF%87%EF%BC%9A%E8%BF%9B%E7%A8%8B%E3%80%81%E7%BA%BF%E7%A8%8B%E3%80%81%E5%8D%8F%E7%A8%8B/" title="第33篇：进程、线程、协程">https://tongsiying.github.io/2022/01/17/python/python_基础篇/第33篇：进程、线程、协程/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener external nofollow noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/python/" rel="tag"># python</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/01/17/python/python_%E5%9F%BA%E7%A1%80%E7%AF%87/%E7%AC%AC32%E7%AF%87%EF%BC%9A%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B(socket)/" rel="prev" title="第32篇：网络编程(socket)">
      <i class="fa fa-chevron-left"></i> 第32篇：网络编程(socket)
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/01/18/python/python_%E5%9F%BA%E7%A1%80%E7%AF%87/%E7%AC%AC34%E7%AF%87%EF%BC%9APython%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" rel="next" title="第34篇：Python正则表达式">
      第34篇：Python正则表达式 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#一、IO多路复用"><span class="nav-text">一、IO多路复用</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#二、select-FTP"><span class="nav-text">二、select_FTP</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#三、GIL"><span class="nav-text">三、GIL</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#四、进程"><span class="nav-text">四、进程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-进程的调用"><span class="nav-text">1. 进程的调用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-process类"><span class="nav-text">2. process类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-进程通信"><span class="nav-text">3. 进程通信</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-进程同步"><span class="nav-text">4. 进程同步</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-多进程"><span class="nav-text">5. 多进程</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#五、线程"><span class="nav-text">五、线程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-线程继承"><span class="nav-text">1. 线程继承</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-计算密集型任务"><span class="nav-text">2. 计算密集型任务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-同步锁"><span class="nav-text">3. 同步锁</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-递归锁"><span class="nav-text">4. 递归锁</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-同步对象"><span class="nav-text">5. 同步对象</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-信号量"><span class="nav-text">6. 信号量</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-队列"><span class="nav-text">7. 队列</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-多线程一"><span class="nav-text">8. 多线程一</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-多线程二"><span class="nav-text">9. 多线程二</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-多线程三"><span class="nav-text">10. 多线程三</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-生产者消费者模型"><span class="nav-text">11. 生产者消费者模型</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#六、协程"><span class="nav-text">六、协程</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="tongsiying"
      src="/images/gutianle.gif">
  <p class="site-author-name" itemprop="name">tongsiying</p>
  <div class="site-description" itemprop="description">问渠那得清如许？为有源头活水来。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">436</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">49</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/tongsiying" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;tongsiying" rel="noopener external nofollow noreferrer" target="_blank"><i class="github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:wxtlucky1015@163.com" title="E-Mail → mailto:wxtlucky1015@163.com" rel="noopener external nofollow noreferrer" target="_blank"><i class="envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/u/2964109344" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;u&#x2F;2964109344" rel="noopener external nofollow noreferrer" target="_blank"><i class="weibo fa-fw"></i>Weibo</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://tongsiying.github.io/" title="tongsiying → https:&#x2F;&#x2F;tongsiying.github.io"><i class="wrench fa-fw"></i>tongsiying</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://tongsiying.github.io/ReadingNotes/" title="ReadingNotes → https:&#x2F;&#x2F;tongsiying.github.io&#x2F;ReadingNotes&#x2F;"><i class="book fa-fw"></i>ReadingNotes</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://tongsiying.github.io/blog/" title="blog → https:&#x2F;&#x2F;tongsiying.github.io&#x2F;blog&#x2F;"><i class="book fa-fw"></i>blog</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://tongsiying.github.io/blog/tools/" title="tools → https:&#x2F;&#x2F;tongsiying.github.io&#x2F;blog&#x2F;tools&#x2F;"><i class="wrench fa-fw"></i>tools</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://tongsiying.github.io/lanlan/" title="lanlan → https:&#x2F;&#x2F;tongsiying.github.io&#x2F;lanlan&#x2F;"><i class="wrench fa-fw"></i>lanlan</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://tongsiying.github.io/Music/" title="note → https:&#x2F;&#x2F;tongsiying.github.io&#x2F;Music&#x2F;"><i class="wrench fa-fw"></i>note</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://tongsiying.github.io/sound/" title="Music → https:&#x2F;&#x2F;tongsiying.github.io&#x2F;sound&#x2F;"><i class="wrench fa-fw"></i>Music</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://tongsiying.github.io/JSONFormat/" title="JSONFormat → https:&#x2F;&#x2F;tongsiying.github.io&#x2F;JSONFormat&#x2F;"><i class="wrench fa-fw"></i>JSONFormat</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://tongsiying.github.io/HTML5-Canvas/" title="Canvas → https:&#x2F;&#x2F;tongsiying.github.io&#x2F;HTML5-Canvas&#x2F;"><i class="wrench fa-fw"></i>Canvas</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://tongsiying.github.io/games/" title="games → https:&#x2F;&#x2F;tongsiying.github.io&#x2F;games&#x2F;"><i class="wrench fa-fw"></i>games</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://tongsiying.github.io/love/" title="love → https:&#x2F;&#x2F;tongsiying.github.io&#x2F;love&#x2F;"><i class="wrench fa-fw"></i>love</a>
      </span>
  </div>



		<div style="">
  <canvas id="canvas" style="width:60%;">��ǰ�������֧��canvas������������������</canvas>
</div>
<script>
(function(){

   var digit=
    [
        [
            [0,0,1,1,1,0,0],
            [0,1,1,0,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,0,1,1,0],
            [0,0,1,1,1,0,0]
        ],//0
        [
            [0,0,0,1,1,0,0],
            [0,1,1,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [1,1,1,1,1,1,1]
        ],//1
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,0,0,0],
            [0,1,1,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,0,0,0,1,1],
            [1,1,1,1,1,1,1]
        ],//2
        [
            [1,1,1,1,1,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,1,1,0],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//3
        [
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,1,0],
            [0,0,1,1,1,1,0],
            [0,1,1,0,1,1,0],
            [1,1,0,0,1,1,0],
            [1,1,1,1,1,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,1,1]
        ],//4
        [
            [1,1,1,1,1,1,1],
            [1,1,0,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,1,1,1,1,0],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//5
        [
            [0,0,0,0,1,1,0],
            [0,0,1,1,0,0,0],
            [0,1,1,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,0,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//6
        [
            [1,1,1,1,1,1,1],
            [1,1,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0]
        ],//7
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//8
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,1,1,0,0,0,0]
        ],//9
        [
            [0,0,0,0,0,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,0,0,0]
        ]//:
    ];

var canvas = document.getElementById('canvas');

if(canvas.getContext){
    var cxt = canvas.getContext('2d');
    //����canvas�Ŀ���
    var H = 100,W = 700;
    canvas.height = H;
    canvas.width = W;
    cxt.fillStyle = '#f00';
    cxt.fillRect(10,10,50,50);

    //�洢ʱ������
    var data = [];
    //�洢�˶���С��
    var balls = [];
    //�������Ӱ뾶
    var R = canvas.height/20-1;
    (function(){
        var temp = /(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date());
        //�洢ʱ�����֣���ʮλСʱ����λСʱ��ð�š�ʮλ���ӡ���λ���ӡ�ð�š�ʮλ���ӡ���λ������7���������
        data.push(temp[1],temp[2],10,temp[3],temp[4],10,temp[5],temp[6]);
    })();

    /*���ɵ�������*/
    function renderDigit(index,num){
        for(var i = 0; i < digit[num].length; i++){
            for(var j = 0; j < digit[num][i].length; j++){
                if(digit[num][i][j] == 1){
                    cxt.beginPath();
                    cxt.arc(14*(R+2)*index + j*2*(R+1)+(R+1),i*2*(R+1)+(R+1),R,0,2*Math.PI);
                    cxt.closePath();
                    cxt.fill();
                }
            }
        }
    }

    /*����ʱ��*/
    function updateDigitTime(){
        var changeNumArray = [];
        var temp = /(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date());
        var NewData = [];
        NewData.push(temp[1],temp[2],10,temp[3],temp[4],10,temp[5],temp[6]);
        for(var i = data.length-1; i >=0 ; i--){
            //ʱ�䷢���仯
            if(NewData[i] !== data[i]){
                //���仯������ֵ����data�����е������洢��changeNumArray������
                changeNumArray.push(i+'_'+(Number(data[i])+1)%10);
            }
        }
        //����С��
        for(var i = 0; i< changeNumArray.length; i++){
            addBalls.apply(this,changeNumArray[i].split('_'));
        }
        data = NewData.concat();
    }

    /*����С��״̬*/
    function updateBalls(){
        for(var i = 0; i < balls.length; i++){
            balls[i].stepY += balls[i].disY;
            balls[i].x += balls[i].stepX;
            balls[i].y += balls[i].stepY;
            if(balls[i].x > W + R || balls[i].y > H + R){
                balls.splice(i,1);
                i--;
            }
        }
    }

    /*����Ҫ�˶���С��*/
    function addBalls(index,num){
        var numArray = [1,2,3];
        var colorArray =  ["#3BE","#09C","#A6C","#93C","#9C0","#690","#FB3","#F80","#F44","#C00"];
        for(var i = 0; i < digit[num].length; i++){
            for(var j = 0; j < digit[num][i].length; j++){
                if(digit[num][i][j] == 1){
                    var ball = {
                        x:14*(R+2)*index + j*2*(R+1)+(R+1),
                        y:i*2*(R+1)+(R+1),
                        stepX:Math.floor(Math.random() * 4 -2),
                        stepY:-2*numArray[Math.floor(Math.random()*numArray.length)],
                        color:colorArray[Math.floor(Math.random()*colorArray.length)],
                        disY:1
                    };
                    balls.push(ball);
                }
            }
        }
    }

    /*��Ⱦ*/
    function render(){
        //���û������ȣ��ﵽ��ջ�����Ч��
        canvas.height = 100;
        //��Ⱦʱ��
        for(var i = 0; i < data.length; i++){
            renderDigit(i,data[i]);
        }
        //��ȾС��
        for(var i = 0; i < balls.length; i++){
            cxt.beginPath();
            cxt.arc(balls[i].x,balls[i].y,R,0,2*Math.PI);
            cxt.fillStyle = balls[i].color;
            cxt.closePath();
            cxt.fill();
        }
    }

    clearInterval(oTimer);
    var oTimer = setInterval(function(){
        //����ʱ��
        updateDigitTime();
        //����С��״̬
        updateBalls();
        //��Ⱦ
        render();
    },50);
}

})();
</script>
      </div>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; Weeny – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">tongsiying</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">7.7m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">116:27</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
