<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/hedgehog.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/hedgehog.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"tongsiying.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"hide","b2t":true,"scrollpercent":true,"padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="article">
<meta property="og:title" content="performance">
<meta property="og:url" content="https://tongsiying.github.io/2021/06/29/STE/2021-06-29-performance/index.html">
<meta property="og:site_name" content="tongsiying">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://tongsiying.github.io/2021/06/29/STE/2021-06-29-performance/328846-20180301165331936-258226035.png">
<meta property="og:image" content="https://tongsiying.github.io/2021/06/29/STE/2021-06-29-performance/328846-20180301165427774-1204451515.png">
<meta property="og:image" content="https://tongsiying.github.io/2021/06/29/STE/2021-06-29-performance/328846-20180301165404729-486161047.png">
<meta property="og:image" content="https://tongsiying.github.io/2021/06/29/STE/2021-06-29-performance/328846-20180301170359419-586503512.png">
<meta property="og:image" content="https://tongsiying.github.io/2021/06/29/STE/2021-06-29-performance/328846-20180301165457773-593293320.png">
<meta property="og:image" content="https://tongsiying.github.io/2021/06/29/STE/2021-06-29-performance/328846-20180301165504168-1545495961.png">
<meta property="og:image" content="https://tongsiying.github.io/2021/06/29/STE/2021-06-29-performance/328846-20180301165517379-2124801784.png">
<meta property="og:image" content="https://tongsiying.github.io/2021/06/29/STE/2021-06-29-performance/328846-20180301165526149-679999705.png">
<meta property="og:image" content="https://tongsiying.github.io/2021/06/29/STE/2021-06-29-performance/328846-20180301165539709-1841664437.png">
<meta property="og:image" content="https://tongsiying.github.io/2021/06/29/STE/2021-06-29-performance/328846-20180301165550212-1790187616.png">
<meta property="og:image" content="https://tongsiying.github.io/2021/06/29/STE/2021-06-29-performance/328846-20180301165557108-1259309741.png">
<meta property="og:image" content="https://tongsiying.github.io/2021/06/29/STE/2021-06-29-performance/328846-20180301165606265-689147647.png">
<meta property="og:image" content="https://tongsiying.github.io/2021/06/29/STE/2021-06-29-performance/328846-20180301165617205-648364546.png">
<meta property="og:image" content="https://tongsiying.github.io/2021/06/29/STE/2021-06-29-performance/region.png">
<meta property="og:image" content="https://tongsiying.github.io/2021/06/29/STE/2021-06-29-performance/Y1.png">
<meta property="og:image" content="https://tongsiying.github.io/2021/06/29/STE/2021-06-29-performance/Y2.png">
<meta property="og:image" content="https://tongsiying.github.io/2021/06/29/STE/2021-06-29-performance/Y3.png">
<meta property="og:image" content="https://tongsiying.github.io/2021/06/29/STE/2021-06-29-performance/Y4.png">
<meta property="og:image" content="https://tongsiying.github.io/2021/06/29/STE/2021-06-29-performance/M1.png">
<meta property="og:image" content="https://hpeng526.github.io/upload/2019/M2.png">
<meta property="og:image" content="https://tongsiying.github.io/2021/06/29/STE/2021-06-29-performance/M3.png">
<meta property="article:published_time" content="2021-06-29T10:37:19.000Z">
<meta property="article:modified_time" content="2022-01-26T11:49:22.588Z">
<meta property="article:author" content="tongsiying">
<meta property="article:tag" content="STE">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://tongsiying.github.io/2021/06/29/STE/2021-06-29-performance/328846-20180301165331936-258226035.png">

<link rel="canonical" href="https://tongsiying.github.io/2021/06/29/STE/2021-06-29-performance/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>performance | tongsiying</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
<!-- 加入APlayer音乐播放器 -->
<link rel="stylesheet" href="/dist/APlayer.min.css">
<div id="aplayer"></div>
<script type="text/javascript" src="/dist/APlayer.min.js"></script>
<script type="text/javascript" src="/dist/music.js"></script>
  <div class="container use-motion">
    <div class="headband"></div>
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">tongsiying</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">阅读|运动|自律</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/catalog/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-目录">

    <a href="/catalog/" rel="section"><i class="fa fa fa-th fa-fw"></i>目录</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-读书清单">

    <a href="/read" rel="section"><i class="fa fa-book fa-fw"></i>读书清单</a>

  </li>
        <li class="menu-item menu-item-读书笔记">

    <a href="/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" rel="section"><i class="fa fa-book fa-fw"></i>读书笔记</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://tongsiying.github.io/2021/06/29/STE/2021-06-29-performance/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/gutianle.gif">
      <meta itemprop="name" content="tongsiying">
      <meta itemprop="description" content="问渠那得清如许？为有源头活水来。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="tongsiying">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          performance
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-06-29 18:37:19" itemprop="dateCreated datePublished" datetime="2021-06-29T18:37:19+08:00">2021-06-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-01-26 19:49:22" itemprop="dateModified" datetime="2022-01-26T19:49:22+08:00">2022-01-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/STE/" itemprop="url" rel="index"><span itemprop="name">STE</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>42k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>38 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p class="description"></p>
<a id="more"></a>

<h1 id="java性能工具"><a href="#java性能工具" class="headerlink" title="java性能工具"></a>java性能工具</h1><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">性能工具：</span><br><span class="line">async-profiler   <span class="keyword">java火焰图</span></span><br><span class="line"><span class="keyword">jprofile</span></span><br><span class="line"><span class="keyword">arthas</span></span><br><span class="line"><span class="keyword">j </span>s ta c k</span><br><span class="line"><span class="keyword">jstat</span></span><br><span class="line"><span class="keyword">mat</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword">jvm内存快照 </span>神风炼</span><br><span class="line"></span><br><span class="line">性能调优：</span><br><span class="line">hpeng526.github</span><br><span class="line"></span><br><span class="line">百度：良好的状态指标</span><br><span class="line"></span><br><span class="line">top -H -p</span><br></pre></td></tr></table></figure>



<h1 id="jvm内存快照dump文件太大，怎么分析"><a href="#jvm内存快照dump文件太大，怎么分析" class="headerlink" title="jvm内存快照dump文件太大，怎么分析"></a><a href="https://www.cnblogs.com/liangzs/p/8489321.html" target="_blank" rel="noopener external nofollow noreferrer">jvm内存快照dump文件太大，怎么分析</a></h1><h2 id="1、场景"><a href="#1、场景" class="headerlink" title="1、场景"></a>1、场景</h2><p>通常，使用eclipse的mat图形化工具打开dump的时候都会内存溢出.</p>
<p><img src="/2021/06/29/STE/2021-06-29-performance/328846-20180301165331936-258226035.png" alt="img"></p>
<p>对于比较小的dump，eclipse可以打开，但一旦dump文件太大，eclipse就有点束手无策。</p>
<p>这时候怎么办呢？可以使用linux下的mat，既Memory Analyzer Tools</p>
<h2 id="2、dump生成"><a href="#2、dump生成" class="headerlink" title="2、dump生成"></a>2、dump生成</h2><p>dump可以是内存溢出时让其自动生成，或者手工直接导。配置jvm参数-XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/home/biapp/m.hprof</p>
<p>手工直接导，PID为进程号</p>
<p>jmap -dump:live,format=b,file=m.hprof PID</p>
<h2 id="3、准备工作，下载LINUX的MAT"><a href="#3、准备工作，下载LINUX的MAT" class="headerlink" title="3、准备工作，下载LINUX的MAT"></a>3、准备工作，下载LINUX的MAT</h2><p>地址：<a href="http://www.eclipse.org/mat/downloads.php" target="_blank" rel="noopener external nofollow noreferrer">http://www.eclipse.org/mat/downloads.php</a></p>
<p>在linux服务器执行命令 uname –m查看版本</p>
<p> <img src="/2021/06/29/STE/2021-06-29-performance/328846-20180301165427774-1204451515.png" alt="img"></p>
<p>下载对应的版本</p>
<p> <img src="/2021/06/29/STE/2021-06-29-performance/328846-20180301165404729-486161047.png" alt="img"></p>
<p>下载后将包传到linux服务器上解压。</p>
<p><img src="/2021/06/29/STE/2021-06-29-performance/328846-20180301170359419-586503512.png" alt="img"></p>
<p>MemoryAnalyzer.ini 配置文件可以修改最大的内存，默认1G基本够用了。</p>
<h2 id="4、在linux执行分析命令"><a href="#4、在linux执行分析命令" class="headerlink" title="4、在linux执行分析命令"></a>4、在linux执行分析命令</h2><p>执行命令</p>
<p>./ParseHeapDump.sh m.hprof  org.eclipse.mat.api:suspects org.eclipse.mat.api:overview org.eclipse.mat.api:top_components。</p>
<p>m.hprof就是jvm的dump文件，在mat目录下会生成3份.zip结尾的报告和一些m.相关的文件，将生成的m.hprof相关的文件都下载到windows本地磁盘。</p>
<p>如：</p>
<p> <img src="/2021/06/29/STE/2021-06-29-performance/328846-20180301165457773-593293320.png" alt="img"></p>
<h2 id="5、打开分析报告"><a href="#5、打开分析报告" class="headerlink" title="5、打开分析报告"></a>5、打开分析报告</h2><p>1）使用浏览器</p>
<p>解压缩以.zip结尾的文件，解压后</p>
<p> <img src="/2021/06/29/STE/2021-06-29-performance/328846-20180301165504168-1545495961.png" alt="img"></p>
<p>使用浏览器打开index.html文件内容，查看分析报告</p>
<p> <img src="/2021/06/29/STE/2021-06-29-performance/328846-20180301165517379-2124801784.png" alt="img"></p>
<p>查看Class Histogram一项</p>
<p> <img src="/2021/06/29/STE/2021-06-29-performance/328846-20180301165526149-679999705.png" alt="img"></p>
<p>发现其中一个类对象占用了7个G，这里的Heap单位都是Byte，自行换算。</p>
<p>Shallow Heap 既对象本身的大小</p>
<p>Retained Heap 对象自身加起直接或间接引用的大小</p>
<p>​    </p>
<p>2）使用eclipse的mat工具</p>
<p>Eclipse需要按照mat工具，安装步骤可以百度，或者参考</p>
<p><a href="https://jingyan.baidu.com/article/cb5d61053562ed005c2fe022.html" target="_blank" rel="noopener external nofollow noreferrer">https://jingyan.baidu.com/article/cb5d61053562ed005c2fe022.html</a></p>
<p>如果直接打开dump文件还是会内存溢出，所以可以使用eclipse打开分析报告即可。</p>
<p>使用eclipse-File-Open File打开dump文件，如下：</p>
<p> <img src="/2021/06/29/STE/2021-06-29-performance/328846-20180301165539709-1841664437.png" alt="img"></p>
<p>会提示错误，点击OK忽略错误，然后选择第三项，重新打开之前的运行报告</p>
<p> <img src="/2021/06/29/STE/2021-06-29-performance/328846-20180301165550212-1790187616.png" alt="img"></p>
<p>点击Next,出现如下界面</p>
<p> <img src="/2021/06/29/STE/2021-06-29-performance/328846-20180301165557108-1259309741.png" alt="img"></p>
<p>选择其中的一份报告打开，如m_System_Overview.zip</p>
<p> <img src="/2021/06/29/STE/2021-06-29-performance/328846-20180301165606265-689147647.png" alt="img"></p>
<p>得到相同的结果</p>
<p> <img src="/2021/06/29/STE/2021-06-29-performance/328846-20180301165617205-648364546.png" alt="img"></p>
<h1 id="G1GC-概念与性能调优-jdk11"><a href="#G1GC-概念与性能调优-jdk11" class="headerlink" title="G1GC 概念与性能调优 (jdk11)"></a>G1GC 概念与性能调优 (jdk11)</h1><blockquote>
<p>本文不讨论 G1 底层数据结构与算法, 从 G1 GC 行为上做简要介绍 G1 的过程</p>
</blockquote>
<p>Garbage-First Garbage Collector 从官网的描述来看 <code>G1 is a generational, incremental, parallel, mostly concurrent, stop-the-world, and evacuating garbage collector which monitors pause-time goals in each of the stop-the-world pauses. Similar to other collectors, G1 splits the heap into (virtual) young and old generations. Space-reclamation efforts concentrate on the young generation where it is most efficient to do so, with occasional space-reclamation in the old generation</code></p>
<p>从介绍可以加粗几个重点</p>
<ul>
<li>分代</li>
<li>并发</li>
<li>STW</li>
<li>在每个STW阶段关注暂停时间目标</li>
<li>回收主要集中在最有效的young generation, old generation则没这么频繁</li>
</ul>
<p>在G1中, 为了提升吞吐量, 有一些操作永远是(STW) stop-the-world 的. 其他的一些要长期的, 如全局标记这种要全堆进行的操作与应用程序并发进行. 为了让空间回收的 STW 尽可能减少, G1并行的分步的递增进行空间回收. G1通过追踪此前应用行为和垃圾回收停顿的信息来构建一个与开销有关的模型(Pause Prediction Model). 它使用这些信息停顿期间可做的工作. 举个例子, G1首先回收最高效的区域(也即垃圾最满的区域, 因此称为垃圾-优先).</p>
<h2 id="堆"><a href="#堆" class="headerlink" title="堆"></a>堆</h2><p>G1把堆分成了n个大小相同的region</p>
<p><img src="/2021/06/29/STE/2021-06-29-performance/region.png" alt="region"></p>
<ul>
<li>E 是 eden region</li>
<li>S 是 survivor region</li>
<li>O 是 old region</li>
<li>H 是 humongous (老年代可以是 humongous, 可以看出, 他可以跨越多个连续regions. 直接分配到老年代, 防止反复拷贝移动)</li>
</ul>
<h2 id="Java-9-以后开启的参数"><a href="#Java-9-以后开启的参数" class="headerlink" title="Java 9 以后开启的参数"></a>Java 9 以后开启的参数</h2><p>自从 Java9 后, 引入的统一的日志, 也就是 Xlog 参数. 下面是建议的 GCLog 参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Xlog:gc*:file=your.log:tags,time,uptime,level:filecount=5,filesize=100m</span><br></pre></td></tr></table></figure>



<h2 id="G1-的-GC-阶段"><a href="#G1-的-GC-阶段" class="headerlink" title="G1 的 GC 阶段"></a>G1 的 GC 阶段</h2><p>我们明白, 调优的基本步骤就是</p>
<ol>
<li>Measure 收集相关诊断信息 (例如, 收集详细的gclog, 默认log level info 可以满足大部分情况)</li>
<li>Understand 理解发生了什么</li>
<li>Tune 调优</li>
</ol>
<p>只有明白了GC内部发生了什么, 才能针对性的对其进行调整</p>
<p>下面通过一些正常的 GC log 来理解 GC 的三种方式 GC 做了什么</p>
<h3 id="Young-Only-Phase"><a href="#Young-Only-Phase" class="headerlink" title="Young Only Phase"></a>Young Only Phase</h3><p>先用张图来简单理解 Young GC 过程</p>
<ul>
<li>垃圾回收的过程就是 Allocated-&gt;eden; eden -&gt; survivor; survivor -&gt; survivor; survivor -&gt; old;</li>
</ul>
<p><img src="/2021/06/29/STE/2021-06-29-performance/Y1.png" alt="y1"></p>
<ul>
<li>可以看到, 这里有 eden, survivor, old 还有个 free region.</li>
</ul>
<p><img src="/2021/06/29/STE/2021-06-29-performance/Y2.png" alt="y2"></p>
<ul>
<li>橙色就是活着的对象</li>
</ul>
<p><img src="/2021/06/29/STE/2021-06-29-performance/Y3.png" alt="y3"></p>
<ul>
<li>G1会把橙色对象拷贝到free region</li>
</ul>
<p><img src="/2021/06/29/STE/2021-06-29-performance/Y4.png" alt="y4"></p>
<ul>
<li>当拷贝完毕, free region 就会晋升为 survivor region, 以前的 eden 就被释放了</li>
<li>如果 Young gc 中, 花费了大量的时间<ul>
<li>正常来说, 大部分在 Young 的对象都不会存活很长时间</li>
</ul>
</li>
<li>如果不符合这个规则 (大部分在 Young 的对象都不会存活很长时间), 你可能需要调整一下 Young 区域占比, 来降低 Young 对象的拷贝时间<ul>
<li><code>-XX:G1NewSizePercent</code> (默认:5) Young region 最小值</li>
<li><code>-XX:G1MaxNewSizePercent</code> (默认: 60) Young region 最大值</li>
</ul>
</li>
</ul>
<h3 id="Mixed-gc-Phase"><a href="#Mixed-gc-Phase" class="headerlink" title="Mixed gc Phase"></a>Mixed gc Phase</h3><ul>
<li>Mixed gc 会选取所有的 Young region + 收益高的若干个 Old region.</li>
</ul>
<p><img src="/2021/06/29/STE/2021-06-29-performance/M1.png" alt="M1"> <img src="https://hpeng526.github.io/upload/2019/M2.png" alt="M2"> <img src="/2021/06/29/STE/2021-06-29-performance/M3.png" alt="M3"></p>
<ul>
<li><p>同样的, 被回收的 region 就变回 free region 了</p>
</li>
<li><p>从上图可以了解到 Mixed gc 只能回收部分的老年代</p>
</li>
<li><p>G1 是如何选择要回收的 regions 的?</p>
<ul>
<li><code>-XX:G1MaxNewSizePercent</code> 与 Young 关联</li>
<li><code>-XX:MixedGCCountTarget</code> 与 old 关联</li>
</ul>
</li>
<li><pre><code>-XX:MixedGCCountTarget
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   </span><br><span class="line"></span><br><span class="line">  默认是8, 意味着要在8次以内回收完所有的 old region</span><br><span class="line"></span><br><span class="line">  - 换句话说, 如果你有 800 个 old region, 那么一次 mixed gc 最大会回收 100 个 old region</span><br><span class="line"></span><br><span class="line">- G1 也可以被调整成不做这么多工作, 也就是回收少点, 浪费堆内存, 导致更堆使用</span><br><span class="line"></span><br><span class="line">  - `-XX:G1MixedGCLiveThresholdPercent` (默认:85) 可能会提高堆使用率</span><br><span class="line">  - `-XX:G1HeapWastePercent` (默认:5) 如果可回收低于这个值, 那么将不会启动Mixed gc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### Full gc Phase</span><br><span class="line"></span><br><span class="line">- Full gc 是不应该发生的</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 先来看看 GC 周期</span><br><span class="line"></span><br><span class="line">![gcy](2021-06-29-performance/gcy.png)</span><br><span class="line"></span><br><span class="line">G1 有两个阶段, 它会在这两个阶段往返, 分别是 Young-only, Space Reclamation.</span><br><span class="line"></span><br><span class="line">- Young-only 包含一系列逐渐填满 old gen 的 gc</span><br><span class="line">- Space Reclamation G1 会递进地回收 old gen 的空间, 同时也处理 Young region</span><br><span class="line"></span><br><span class="line">图是来自 oracle 上对 gc 周期的描述, 实心圆都表示一次 GC 停顿</span><br><span class="line"></span><br><span class="line">- 蓝色 Young-only</span><br><span class="line">- 黄色 标记过程的停顿</span><br><span class="line">- 红色 Mixed gc 停顿</span><br><span class="line"></span><br><span class="line">在几次gc后, old gen 的对象占有比超过了 `InitiatingHeapOccupancyPercent`, gc就会进入并发标记准备(concurrent mark).</span><br><span class="line"></span><br><span class="line">- G1 在每一次 Young 回收中都会查找活对象(有引用的对象)</span><br><span class="line">- G1 在 old region 并发查找活对象</span><br><span class="line">  - 叫 concurrent marking</span><br><span class="line">  - 可能花费很长时间</span><br><span class="line">  - 不会停止 Java 应用</span><br><span class="line">- G1 没有活对象的引用信息是不能进行垃圾回收的</span><br><span class="line">  - Mixed gc 依赖 concurrent mark</span><br><span class="line"></span><br><span class="line">回到 full gc, 从上面简单分析得出, full gc 发生是没有足够的 free region, 如果堆是足够大的, Mixed gc 没有回收足够的 old region, 或者 concurrent mark 没法及时完成, 都可能会导致 full gc.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### gc 日志</span><br><span class="line"></span><br><span class="line">```log</span><br><span class="line">[gc,start     ] GC(78) Pause Young (Normal) (G1 Evacuation Pause)</span><br><span class="line">[gc,task      ] GC(78) Using 10 workers of 10 for evacuation</span><br><span class="line">[gc,phases    ] GC(78)   Pre Evacuate Collection Set: 3.2ms</span><br><span class="line">[gc,phases    ] GC(78)   Evacuate Collection Set: 28.8ms</span><br><span class="line">[gc,phases    ] GC(78)   Post Evacuate Collection Set: 1.8ms</span><br><span class="line">[gc,phases    ] GC(78)   Other: 1.1ms</span><br><span class="line">[gc,heap      ] GC(78) Eden regions: 538-&gt;0(871)</span><br><span class="line">[gc,heap      ] GC(78) Survivor regions: 69-&gt;33(76)</span><br><span class="line">[gc,heap      ] GC(78) Old regions: 1041-&gt;1077</span><br><span class="line">[gc,heap      ] GC(78) Humongous regions: 3-&gt;1</span><br><span class="line">[gc,metaspace ] GC(78) Metaspace: 71777K-&gt;71777K(1114112K)</span><br><span class="line">[gc           ] GC(78) Pause Young (Normal) (G1 Evacuation Pause) 3300M-&gt;2220M(6144M) 34.907ms</span><br><span class="line">[gc,cpu       ] GC(78) User=0.24s Sys=0.05s Real=0.04s</span><br><span class="line">[gc,start     ] GC(79) Pause Young (Concurrent Start) (G1 Humongous Allocation)</span><br><span class="line">[gc,task      ] GC(79) Using 10 workers of 10 for evacuation</span><br><span class="line">[gc,phases    ] GC(79)   Pre Evacuate Collection Set: 0.2ms</span><br><span class="line">[gc,phases    ] GC(79)   Evacuate Collection Set: 22.3ms</span><br><span class="line">[gc,phases    ] GC(79)   Post Evacuate Collection Set: 0.9ms</span><br><span class="line">[gc,phases    ] GC(79)   Other: 1.8ms</span><br><span class="line">[gc,heap      ] GC(79) Eden regions: 569-&gt;0(656)</span><br><span class="line">[gc,heap      ] GC(79) Survivor regions: 33-&gt;55(113)</span><br><span class="line">[gc,heap      ] GC(79) Old regions: 1077-&gt;1077</span><br><span class="line">[gc,heap      ] GC(79) Humongous regions: 1-&gt;1</span><br><span class="line">[gc,metaspace ] GC(79) Metaspace: 71780K-&gt;71780K(1114112K)</span><br><span class="line">[gc           ] GC(79) Pause Young (Concurrent Start) (G1 Humongous Allocation) 3357M-&gt;2264M(6144M) 25.305ms</span><br><span class="line">[gc,cpu       ] GC(79) User=0.21s Sys=0.00s Real=0.03s</span><br><span class="line">[gc           ] GC(80) Concurrent Cycle</span><br><span class="line">[gc,marking   ] GC(80) Concurrent Clear Claimed Marks</span><br><span class="line">[gc,marking   ] GC(80) Concurrent Clear Claimed Marks 0.147ms</span><br><span class="line">[gc,marking   ] GC(80) Concurrent Scan Root Regions</span><br><span class="line">[gc,marking   ] GC(80) Concurrent Scan Root Regions 16.125ms</span><br><span class="line">[gc,marking   ] GC(80) Concurrent Mark (373.358s)</span><br><span class="line">[gc,marking   ] GC(80) Concurrent Mark From Roots</span><br><span class="line">[gc,task      ] GC(80) Using 4 workers of 4 for marking</span><br><span class="line">[gc,marking   ] GC(80) Concurrent Mark From Roots 57.029ms</span><br><span class="line">[gc,marking   ] GC(80) Concurrent Preclean</span><br><span class="line">[gc,marking   ] GC(80) Concurrent Preclean 0.454ms</span><br><span class="line">[gc,marking   ] GC(80) Concurrent Mark (373.358s, 373.415s) 57.548ms</span><br><span class="line">[gc,start     ] GC(80) Pause Remark</span><br><span class="line">[gc,stringtable] GC(80) Cleaned string and symbol table, strings: 36361 processed, 315 removed, symbols: 192117 processed, 500 removed</span><br><span class="line">[gc            ] GC(80) Pause Remark 2326M-&gt;956M(6144M) 14.454ms</span><br><span class="line">[gc,cpu        ] GC(80) User=0.08s Sys=0.03s Real=0.02s</span><br><span class="line">[gc,marking    ] GC(80) Concurrent Rebuild Remembered Sets</span><br><span class="line">[gc,marking    ] GC(80) Concurrent Rebuild Remembered Sets 38.843ms</span><br><span class="line">[gc,start      ] GC(80) Pause Cleanup</span><br><span class="line">[gc            ] GC(80) Pause Cleanup 974M-&gt;974M(6144M) 0.660ms</span><br><span class="line">[gc,cpu        ] GC(80) User=0.00s Sys=0.00s Real=0.00s</span><br><span class="line">[gc,marking    ] GC(80) Concurrent Cleanup for Next Mark</span><br><span class="line">[gc,marking    ] GC(80) Concurrent Cleanup for Next Mark 16.673ms</span><br><span class="line">[gc            ] GC(80) Concurrent Cycle 146.748ms</span><br><span class="line">[gc,start      ] GC(81) Pause Young (Prepare Mixed) (G1 Evacuation Pause)</span><br><span class="line">[gc,task       ] GC(81) Using 10 workers of 10 for evacuation</span><br><span class="line">[gc,mmu        ] GC(81) MMU target violated: 61.0ms (60.0ms/61.0ms)</span><br><span class="line">[gc,phases     ] GC(81)   Pre Evacuate Collection Set: 0.1ms</span><br><span class="line">[gc,phases     ] GC(81)   Evacuate Collection Set: 76.8ms</span><br><span class="line">[gc,phases     ] GC(81)   Post Evacuate Collection Set: 0.9ms</span><br><span class="line">[gc,phases     ] GC(81)   Other: 1.1ms</span><br><span class="line">[gc,heap       ] GC(81) Eden regions: 211-&gt;0(136)</span><br><span class="line">[gc,heap       ] GC(81) Survivor regions: 55-&gt;17(34)</span><br><span class="line">[gc,heap       ] GC(81) Old regions: 392-&gt;443</span><br><span class="line">[gc,heap       ] GC(81) Humongous regions: 3-&gt;1</span><br><span class="line">[gc,metaspace  ] GC(81) Metaspace: 71780K-&gt;71780K(1114112K)</span><br><span class="line">[gc            ] GC(81) Pause Young (Prepare Mixed) (G1 Evacuation Pause) 1320M-&gt;919M(6144M) 78.857ms</span><br><span class="line">[gc,cpu        ] GC(81) User=0.41s Sys=0.37s Real=0.08s</span><br><span class="line">[gc,start      ] GC(82) Pause Young (Mixed) (G1 Evacuation Pause)</span><br><span class="line">[gc,task       ] GC(82) Using 10 workers of 10 for evacuation</span><br><span class="line">[gc,phases     ] GC(82)   Pre Evacuate Collection Set: 0.1ms</span><br><span class="line">[gc,phases     ] GC(82)   Evacuate Collection Set: 22.1ms</span><br><span class="line">[gc,phases     ] GC(82)   Post Evacuate Collection Set: 0.8ms</span><br><span class="line">[gc,phases     ] GC(82)   Other: 0.9ms</span><br><span class="line">[gc,heap       ] GC(82) Eden regions: 136-&gt;0(142)</span><br><span class="line">[gc,heap       ] GC(82) Survivor regions: 17-&gt;11(20)</span><br><span class="line">[gc,heap       ] GC(82) Old regions: 443-&gt;367</span><br><span class="line">[gc,heap       ] GC(82) Humongous regions: 1-&gt;1</span><br><span class="line">[gc,metaspace  ] GC(82) Metaspace: 71780K-&gt;71780K(1114112K)</span><br><span class="line">[gc            ] GC(82) Pause Young (Mixed) (G1 Evacuation Pause) 1191M-&gt;757M(6144M) 23.970ms</span><br><span class="line">[gc,cpu        ] GC(82) User=0.15s Sys=0.08s Real=0.03s</span><br><span class="line">[gc,start      ] GC(83) Pause Young (Mixed) (G1 Evacuation Pause)</span><br><span class="line">[gc,task       ] GC(83) Using 10 workers of 10 for evacuation</span><br><span class="line">[gc,phases     ] GC(83)   Pre Evacuate Collection Set: 0.1ms</span><br><span class="line">[gc,phases     ] GC(83)   Evacuate Collection Set: 5.0ms</span><br><span class="line">[gc,phases     ] GC(83)   Post Evacuate Collection Set: 0.8ms</span><br><span class="line">[gc,phases     ] GC(83)   Other: 1.1ms</span><br><span class="line">[gc,heap       ] GC(83) Eden regions: 142-&gt;0(783)</span><br><span class="line">[gc,heap       ] GC(83) Survivor regions: 11-&gt;10(20)</span><br><span class="line">[gc,heap       ] GC(83) Old regions: 367-&gt;294</span><br><span class="line">[gc,heap       ] GC(83) Humongous regions: 1-&gt;1</span><br><span class="line">[gc,metaspace  ] GC(83) Metaspace: 71780K-&gt;71780K(1114112K)</span><br></pre></td></tr></table></figure>
</code></pre></li>
</ul>
<p>上面是连续几次GC的日志, 可以对照着 gc 周期来看 为了方便排版, 把时间相关的tag给精简掉了</p>
<ul>
<li>GC(78) 是一次普通的young gc, 里面信息有各种 region 的变化<ul>
<li>这里简单说一下 humongous 对象的处理</li>
<li>humongous 对象在G1中是被特殊对待的, G1 只决定它们是否生存, 回收他们占用的空间, 从不会移动它们.</li>
<li>Young-Only 阶段, humongous regions 可能会被回收</li>
<li>Space-Reclamation, humongous regions 可能会被回收</li>
</ul>
</li>
<li>GC(79) 开始进入并发阶段</li>
<li>GC(80) 完成了 Cleanup, 紧接着一个 Prepare Mixed GC(81) 的垃圾收集, 对应周期虚线右边的蓝实心圆</li>
<li>GC(82) 之后就是 Space Reclamation 阶段了. 多个 Mixed GC 会进行</li>
</ul>
<p>根据日志, 可以简单看到每个步骤花费的时间, 以及对应区域垃圾的回收情况, 结合GC参数, 可以定位出什么问题, 针对性的调整参数.</p>
<blockquote>
<p>吞吐量跟低延时是无法兼得的, 低延时意味着GC工作会更加频繁, 相对的, 会占用应用的资源, 吞吐量降低. 需要大吞吐量, 那么GC工作就会减少, 相对的, 每次回收的垃圾就会多, 暂停时间就会增加, 延时就会增加. <code>-XX:MaxGCPauseMillis</code> G1 会尽量满足这个参数设定的目标时间, 通过此参数可以平衡应用需要的吞吐量以及延时.</p>
</blockquote>
<h3 id="g1gc-young-shrinking"><a href="#g1gc-young-shrinking" class="headerlink" title="g1gc young shrinking"></a>g1gc young shrinking</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[gc,start      ] GC(29233) Pause Young (Normal) (G1 Evacuation Pause)</span><br><span class="line">[gc,task       ] GC(29233) Using 8 workers of 8 for evacuation</span><br><span class="line">[gc,phases     ] GC(29233)   Pre Evacuate Collection Set: 0.1ms</span><br><span class="line">[gc,phases     ] GC(29233)   Evacuate Collection Set: 28.7ms</span><br><span class="line">[gc,phases     ] GC(29233)   Post Evacuate Collection Set: 1.2ms</span><br><span class="line">[gc,phases     ] GC(29233)   Other: 1.1ms</span><br><span class="line">[gc,heap       ] GC(29233) Eden regions: 1779-&gt;0(1771)</span><br><span class="line">[gc,heap       ] GC(29233) Survivor regions: 64-&gt;72(231)</span><br><span class="line">[gc,heap       ] GC(29233) Old regions: 327-&gt;327</span><br><span class="line">[gc,heap       ] GC(29233) Humongous regions: 1-&gt;1</span><br><span class="line">[gc,metaspace  ] GC(29233) Metaspace: 75815K-&gt;75815K(1118208K)</span><br><span class="line">[gc            ] GC(29233) Pause Young (Normal) (G1 Evacuation Pause) 4339M-&gt;798M(6144M) 31.124ms</span><br><span class="line">[gc,cpu        ] GC(29233) User&#x3D;0.24s Sys&#x3D;0.00s Real&#x3D;0.04s</span><br><span class="line">[gc,start      ] GC(29234) Pause Young (Normal) (G1 Evacuation Pause)</span><br><span class="line">[gc,task       ] GC(29234) Using 8 workers of 8 for evacuation</span><br><span class="line">[gc,mmu        ] GC(29234) MMU target violated: 61.0ms (60.0ms&#x2F;61.0ms)</span><br><span class="line">[gc,phases     ] GC(29234)   Pre Evacuate Collection Set: 0.1ms</span><br><span class="line">[gc,phases     ] GC(29234)   Evacuate Collection Set: 26.6ms</span><br><span class="line">[gc,phases     ] GC(29234)   Post Evacuate Collection Set: 870.6ms</span><br><span class="line">[gc,phases     ] GC(29234)   Other: 1.2ms</span><br><span class="line">[gc,heap       ] GC(29234) Eden regions: 1771-&gt;0(84)</span><br><span class="line">[gc,heap       ] GC(29234) Survivor regions: 72-&gt;69(231)</span><br><span class="line">[gc,heap       ] GC(29234) Old regions: 327-&gt;327</span><br><span class="line">[gc,heap       ] GC(29234) Humongous regions: 1-&gt;1</span><br><span class="line">[gc,metaspace  ] GC(29234) Metaspace: 75815K-&gt;75815K(1118208K)</span><br><span class="line">[gc            ] GC(29234) Pause Young (Normal) (G1 Evacuation Pause) 4340M-&gt;791M(6144M) 898.525ms</span><br><span class="line">[gc,cpu        ] GC(29234) User&#x3D;0.22s Sys&#x3D;0.00s Real&#x3D;0.90s</span><br></pre></td></tr></table></figure>

<ul>
<li>Eden regions shrinking 1771 -&gt; 84<ul>
<li>If not otherwise constrained, then G1 adaptively sizes the young generation size between the values that -XX:G1NewSizePercent and -XX:G1MaxNewSizePercent determine to meet pause-time. See Garbage-First Garbage Collector Tuning for more information about how to fix long pauses.</li>
</ul>
</li>
<li>User=0.22s Sys=0.00s Real=0.90s, Real &gt; User + Sys<ul>
<li>gc lack of cpu time</li>
</ul>
</li>
</ul>
<h1 id="从-GC-log-了解与分析-gc"><a href="#从-GC-log-了解与分析-gc" class="headerlink" title="从 GC log 了解与分析 gc"></a>从 GC log 了解与分析 gc</h1><p>CMS 介绍</p>
<p>CMS, Concurrent Mark Sweep, 并发的标记清楚算法GC.</p>
<h2 id="CMS-执行"><a href="#CMS-执行" class="headerlink" title="CMS 执行"></a>CMS 执行</h2><ol>
<li>初始化标记</li>
<li>并发标记</li>
<li>并发预清理</li>
<li>重标记</li>
<li>并发清理</li>
<li>重置</li>
</ol>
<p>环境配置是 JDK8, HotSpot VM</p>
<p>应用配置的参数</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">-<span class="string">XX:</span>+UseConcMarkSweepGC                             <span class="comment">// 使用 CMS GC</span></span><br><span class="line">-<span class="string">XX:</span>+UseCMSInitiatingOccupancyOnly                  <span class="comment">// 不基于运行时收集的数据来启动 CMS 垃圾收集的周期, 使用CMSInitiatingOccupancyFraction</span></span><br><span class="line">-<span class="string">XX:</span>CMSInitiatingOccupancyFraction=<span class="number">70</span>               <span class="comment">// 使用70%后开始 CMS GC</span></span><br><span class="line">-<span class="string">XX:</span>+ExplicitGCInvokesConcurrentAndUnloadsClasses   <span class="comment">// 显式 GC 执行 CMS GC 非 FGC</span></span><br><span class="line">-<span class="string">XX:</span>+CMSClassUnloadingEnabled                       <span class="comment">// CMS 也收集 PermGen space (https://blogs.oracle.com/poonam/about-g1-garbage-collector,-permanent-generation-and-metaspace)</span></span><br><span class="line">-<span class="string">XX:</span>+ParallelRefProcEnabled                         <span class="comment">// 并行处理 ref</span></span><br><span class="line">-<span class="string">XX:</span>+CMSScavengeBeforeRemark                        <span class="comment">// 在CMS remark前执行一次minor gc清理新生代, 减少stop-the-world时间</span></span><br><span class="line">-<span class="string">XX:</span>+PrintGCDetails                                 <span class="comment">// 打印 GC 详细信息</span></span><br><span class="line">-<span class="string">XX:</span>+PrintGCDateStamps                              <span class="comment">// 输出GC的时间戳</span></span><br></pre></td></tr></table></figure>

<p>CMS GC log 如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; initial mark stop-the-world</span><br><span class="line">2018-08-06T10:55:07.447+0800: 495808.570: [GC (CMS Initial Mark) [1 CMS-initial-mark: 1421882K(1966080K)] 1464386K(3027776K), 0.0610635 secs] [Times: user&#x3D;0.05 sys&#x3D;0.00, real&#x3D;0.06 secs] </span><br><span class="line">&#x2F;&#x2F; concurrent mark</span><br><span class="line">2018-08-06T10:55:07.510+0800: 495808.633: [CMS-concurrent-mark-start]</span><br><span class="line">2018-08-06T10:55:38.879+0800: 495840.002: [CMS-concurrent-mark: 27.341&#x2F;31.368 secs] [Times: user&#x3D;48.82 sys&#x3D;8.29, real&#x3D;31.36 secs] </span><br><span class="line">&#x2F;&#x2F; concurrent preclean</span><br><span class="line">2018-08-06T10:55:38.879+0800: 495840.002: [CMS-concurrent-preclean-start]</span><br><span class="line">2018-08-06T10:55:39.303+0800: 495840.426: [CMS-concurrent-preclean: 0.131&#x2F;0.424 secs] [Times: user&#x3D;0.89 sys&#x3D;0.05, real&#x3D;0.43 secs] </span><br><span class="line">&#x2F;&#x2F; abortable preclean</span><br><span class="line">2018-08-06T10:55:39.303+0800: 495840.427: [CMS-concurrent-abortable-preclean-start]</span><br><span class="line">2018-08-06T10:55:39.303+0800: 495840.427: [CMS-concurrent-abortable-preclean: 0.000&#x2F;0.000 secs] [Times: user&#x3D;0.00 sys&#x3D;0.00, real&#x3D;0.00 secs] </span><br><span class="line">&#x2F;&#x2F; final remark stop-the-world</span><br><span class="line">2018-08-06T10:55:39.320+0800: 495840.444: [GC (CMS Final Remark) [YG occupancy: 237032 K (1061696 K)]2018-08-06T10:55:39.321+0800: 495840.444: [GC (CMS Final Remark) 2018-08-06T10:55:39.321+0800: 495840.444: [ParNew: 237032K-&gt;237032K(1061696K), 0.0000520 secs] 2068900K-&gt;2068900K(3027776K), 0.0004108 secs] [Times: user&#x3D;0.00 sys&#x3D;0.00, real&#x3D;0.00 secs] </span><br><span class="line">&#x2F;&#x2F; rescan</span><br><span class="line">2018-08-06T10:55:39.321+0800: 495840.444: [Rescan (parallel) , 0.1066672 secs]2018-08-06T10:55:39.428+0800: 495840.551: [weak refs processing, 0.0868804 secs]2018-08-06T10:55:39.515+0800: 495840.638: [class unloading, 0.0667963 secs]</span><br><span class="line">&#x2F;&#x2F; scrub symbol table</span><br><span class="line">2018-08-06T10:55:39.582+0800: 495840.705: [scrub symbol table, 0.0554765 secs]2018-08-06T10:55:39.637+0800: 495840.761: [scrub string table, 0.0065050 secs][1 CMS-remark: 1831867K(1966080K)] 2068900K(3027776K), 0.3247966 secs] [Times: user&#x3D;0.48 sys&#x3D;0.01, real&#x3D;0.32 secs] </span><br><span class="line">2018-08-06T10:55:39.646+0800: 495840.770: [CMS-concurrent-sweep-start]</span><br><span class="line">2018-08-06T10:55:48.631+0800: 495849.755: [CMS-concurrent-sweep: 6.052&#x2F;8.985 secs] [Times: user&#x3D;7.66 sys&#x3D;4.13, real&#x3D;8.99 secs] </span><br><span class="line">&#x2F;&#x2F; reset start</span><br><span class="line">2018-08-06T10:55:49.130+0800: 495850.253: [CMS-concurrent-reset-start]</span><br><span class="line">2018-08-06T10:55:49.139+0800: 495850.263: [CMS-concurrent-reset: 0.009&#x2F;0.009 secs] [Times: user&#x3D;0.03 sys&#x3D;0.00, real&#x3D;0.00 secs] </span><br><span class="line">2018-08-06T10:55:53.548+0800: 495854.672: [CMS: 1336369K-&gt;468683K(1966080K), 2.2096604 secs] 2336499K-&gt;468683K(3027776K), [Metaspace: 120912K-&gt;120912K(1165312K)], 2.7556633 secs] [Times: user&#x3D;2.87 sys&#x3D;0.01, real&#x3D;2.75 secs]</span><br></pre></td></tr></table></figure>

<h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><h3 id="CMS-阶段"><a href="#CMS-阶段" class="headerlink" title="CMS 阶段"></a>CMS 阶段</h3><table>
<thead>
<tr>
<th>步骤</th>
<th>解释</th>
<th>stop-the-world</th>
</tr>
</thead>
<tbody><tr>
<td>CMS Initial Mark</td>
<td>可达性分析, 标记 GC Roots <code>直接关联</code> 对象</td>
<td>True</td>
</tr>
<tr>
<td>CMS-concurrent-mark</td>
<td>GC Tracing, 从 GC Roots 开始对堆进行<code>可达性分析</code>, 找出存活对象</td>
<td>False</td>
</tr>
<tr>
<td>CMS-concurrent-preclean</td>
<td>负责前一个阶段标记了又发生改变的对象标记</td>
<td>False</td>
</tr>
<tr>
<td>CMS-concurrent-abortable-preclean</td>
<td>尝试着去承担 Final Remark 阶段足够多的工作, 重复的做相同的事情直到 abort 条件</td>
<td>False</td>
</tr>
<tr>
<td>CMS Final Remark</td>
<td>完成标记整个年老代的所有的存活对象</td>
<td>True</td>
</tr>
<tr>
<td>CMS-concurrent-sweep</td>
<td>开始移除对象</td>
<td>False</td>
</tr>
<tr>
<td>CMS-concurrent-reset</td>
<td>重置 CMS 算法内部结构</td>
<td>False</td>
</tr>
</tbody></table>
<h3 id="GC-触发条件"><a href="#GC-触发条件" class="headerlink" title="GC 触发条件"></a>GC 触发条件</h3><table>
<thead>
<tr>
<th>原因</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Allocation Failure</td>
<td>新生代(Young generation)不够空间给创建新对象, 触发 minor gc.</td>
</tr>
<tr>
<td>Promotion Failure</td>
<td>没有 <code>连续</code> 的空间来存放更大的对象. 通常会导致 FGC.</td>
</tr>
<tr>
<td>GCLocker Initiated GC</td>
<td>JNI 临界区被释放就会触发</td>
</tr>
<tr>
<td>Concurrent Mode Failure</td>
<td>CMS 采用多个线程和应用线程并发执行, 减少停顿时间, 通常发生于年老代被用完之前不能完成对无引用对象的回收或者年老代不能满足新的空间分配</td>
</tr>
<tr>
<td>Heap Dump Initiated GC</td>
<td>heap dump 之前进行 FGC , 一般是通过工具 dump 会触发 (jmap)</td>
</tr>
</tbody></table>
<h3 id="GC-异常点"><a href="#GC-异常点" class="headerlink" title="GC 异常点"></a>GC 异常点</h3><p>通过 <a href="https://hpeng526.github.io/posts/18/1808cmsgc/gceasy.io" target="_blank" rel="noopener external nofollow noreferrer">gceasy.io</a> 上传日志, 分析异常点得出</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">It looks like your application <span class="keyword">is</span> waiting due to lack of compute resources (either CPU <span class="keyword">or</span> I/O cycles). Serious production applications shouldn<span class="string">'t be stranded because of compute resources. In 47 GC event(s), '</span>real<span class="string">' time took more than '</span>us<span class="string">r' + '</span>sys<span class="string">' time.</span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>Timestamp</th>
<th>User Time (secs)</th>
<th>Sys Time (secs)</th>
<th>Real Time (secs)</th>
</tr>
</thead>
<tbody><tr>
<td>2018-08-06T10:21:12</td>
<td>0.26</td>
<td>0.01</td>
<td>0.61</td>
</tr>
<tr>
<td>2018-08-06T10:21:18</td>
<td>0.24</td>
<td>0.04</td>
<td>0.9</td>
</tr>
<tr>
<td>2018-08-06T10:33:25</td>
<td>0.22</td>
<td>0.01</td>
<td>0.58</td>
</tr>
<tr>
<td>2018-08-06T10:34:54</td>
<td>0.3</td>
<td>0.01</td>
<td>0.52</td>
</tr>
<tr>
<td>2018-08-06T10:35:15</td>
<td>0.55</td>
<td>0.02</td>
<td>1.15</td>
</tr>
</tbody></table>
<p>意思就是 ‘real’ time &gt; ‘usr’ + ‘sys’, 造成这种现象的可能性有</p>
<ol>
<li>Heavy I/O 如果有 I/O 密集任务, ‘real time’ 会变长. &gt; 解决方案 1. 优化高 I/O 任务 1. 在服务器上减少导致高 I/O 的任务 1. 迁移应用到低 I/O 的服务器上</li>
<li>Lack of CPU 如果是服务器上有多个进程在跑, 程序得不到足够的 CPU 周期, 就会开始等待. 因此 ‘real time’会变长 &gt; 解决方案: 1. 减少服务器上的进程 1. 增加 CPU 1. 迁移应用到充足 CPU 服务器上</li>
</ol>
<h3 id="现象分析"><a href="#现象分析" class="headerlink" title="现象分析"></a>现象分析</h3><p>当时出现的现象是: 1. CPU 告警 1. 上去服务器看到系统负载已经到70左右 1. top 信息看到应用占用 CPU 高 1. GC 日志显示同一台服务器上的两个服务在10点时间段 CMS 都在工作 1. 业务高峰期 1. 4核服务器</p>
<p>初步分析: 1. 从应用线程dump分析, 应用内线程无明显异常现象. 1. 结合 top -H 初步得到是 GC 线程在运行 1. 从 GC log 入手, 分析得出异常点, 回顾与计算两个服务 CMS 线程占用了一半的 CPU 资源 <code>(4+3)/4*2</code>, 导致 CPU 资源紧缺, 整体服务变慢.</p>
<p>参考4资料</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">https:</span><span class="comment">//www.cnblogs.com/zhangxiaoguang/p/5792468.html</span></span><br><span class="line"><span class="symbol">https:</span><span class="comment">//juejin.im/post/5b651200f265da0fa00a38d7?utm_source=gold_browser_extension</span></span><br><span class="line"><span class="symbol">https:</span><span class="comment">//stackoverflow.com/questions/22149075/why-promotion-failure-and-concurrent-mode-failure</span></span><br><span class="line"><span class="symbol">https:</span><span class="comment">//blog.gceasy.io/2016/12/08/real-time-greater-than-user-and-sys-time/</span></span><br></pre></td></tr></table></figure>



<h1 id="linux性能监控"><a href="#linux性能监控" class="headerlink" title="linux性能监控"></a>linux性能监控</h1><p> CPU、Memory、IO、Network等指标的讲解</p>
<h2 id="一、CPU"><a href="#一、CPU" class="headerlink" title="一、CPU"></a>一、CPU</h2><p>1、良好状态指标</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- CPU利用率：User Time &lt;= 70%，System Time &lt;= 35%，User Time +<span class="built_in"> System </span>Time &lt;= 70%。</span><br><span class="line">- 上下文切换：与CPU利用率相关联，如果CPU利用率状态良好，大量的上下文切换也是可以接受的。</span><br><span class="line">- 可运行队列：每个处理器的可运行队列&lt;=3个线程。</span><br></pre></td></tr></table></figure>



<p>2、监控工具</p>
<ul>
<li><p>vmstat</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> vmstat <span class="number">1</span></span><br><span class="line">procs -----------memory---------- ---swap-- -----io---- --system-- -----cpu------</span><br><span class="line">r b  swpd  free  buff cache  si  so  bi  bo  <span class="keyword">in</span>  cs us sy id wa st</span><br><span class="line"><span class="number">14</span> <span class="number">0</span>  <span class="number">140</span> <span class="number">2904316</span> <span class="number">341912</span> <span class="number">3952308</span> <span class="number">0</span>  <span class="number">0</span>   <span class="number">0</span>  <span class="number">460</span> <span class="number">1106</span> <span class="number">9593</span> <span class="number">36</span> <span class="number">64</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span></span><br><span class="line"><span class="number">17</span> <span class="number">0</span>  <span class="number">140</span> <span class="number">2903492</span> <span class="number">341912</span> <span class="number">3951780</span> <span class="number">0</span>  <span class="number">0</span>   <span class="number">0</span>   <span class="number">0</span> <span class="number">1037</span> <span class="number">9614</span> <span class="number">35</span> <span class="number">65</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span></span><br><span class="line"><span class="number">20</span> <span class="number">0</span>  <span class="number">140</span> <span class="number">2902016</span> <span class="number">341912</span> <span class="number">3952000</span> <span class="number">0</span>  <span class="number">0</span>   <span class="number">0</span>   <span class="number">0</span> <span class="number">1046</span> <span class="number">9739</span> <span class="number">35</span> <span class="number">64</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span></span><br><span class="line"><span class="number">17</span> <span class="number">0</span>  <span class="number">140</span> <span class="number">2903904</span> <span class="number">341912</span> <span class="number">3951888</span> <span class="number">0</span>  <span class="number">0</span>   <span class="number">0</span>  <span class="number">76</span> <span class="number">1044</span> <span class="number">9879</span> <span class="number">37</span> <span class="number">63</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span></span><br><span class="line"><span class="number">16</span> <span class="number">0</span>  <span class="number">140</span> <span class="number">2904580</span> <span class="number">341912</span> <span class="number">3952108</span> <span class="number">0</span>  <span class="number">0</span>   <span class="number">0</span>   <span class="number">0</span> <span class="number">1055</span> <span class="number">9808</span> <span class="number">34</span> <span class="number">65</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">重要参数：</span><br><span class="line">r，run queue，可运行队列的线程数，这些线程都是可运行状态，只不过CPU暂时不可用；</span><br><span class="line">b，被blocked的进程数，正在等待IO请求；</span><br><span class="line"><span class="keyword">in</span>，<span class="built_in">int</span>errupts，被处理过的中断数</span><br><span class="line">cs，context <span class="keyword">switch</span>，系统上正在做上下文切换的数目</span><br><span class="line">us，用户占用CPU的百分比</span><br><span class="line">sys，内核和中断占用CPU的百分比</span><br><span class="line">id，CPU完全空闲的百分比</span><br><span class="line"></span><br><span class="line">上例可得：</span><br><span class="line">sy高us低，以及高频度的上下文切换（cs），说明应用程序进行了大量的系统调用；</span><br><span class="line">这台<span class="number">4</span>核机器的r应该在<span class="number">12</span>个以内，现在r在<span class="number">14</span>个线程以上，此时CPU负荷很重。</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>$查看某个进程占用的CPU资源</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">while</span> :; <span class="keyword">do</span> ps -eo pid,ni,pri,pcpu,psr,comm | grep <span class="string">'test_command'</span>; sleep <span class="number">1</span>; done</span><br><span class="line"> PID NI PRI %CPU PSR COMMAND</span><br><span class="line"><span class="number">28577</span>  <span class="number">0</span> <span class="number">23</span> <span class="number">0.0</span>  <span class="number">0</span> test_command</span><br><span class="line"><span class="number">28578</span>  <span class="number">0</span> <span class="number">23</span> <span class="number">0.0</span>  <span class="number">3</span> test_command</span><br><span class="line"><span class="number">28579</span>  <span class="number">0</span> <span class="number">23</span> <span class="number">0.0</span>  <span class="number">2</span> test_command</span><br><span class="line"><span class="number">28581</span>  <span class="number">0</span> <span class="number">23</span> <span class="number">0.0</span>  <span class="number">2</span> test_command</span><br><span class="line"><span class="number">28582</span>  <span class="number">0</span> <span class="number">23</span> <span class="number">0.0</span>  <span class="number">3</span> test_command</span><br><span class="line"><span class="number">28659</span>  <span class="number">0</span> <span class="number">23</span> <span class="number">0.0</span>  <span class="number">0</span> test_command</span><br><span class="line">……</span><br></pre></td></tr></table></figure>







</li>
</ul>
<h2 id="二、Memory"><a href="#二、Memory" class="headerlink" title="二、Memory"></a>二、Memory</h2><p>1、良好状态指标</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- swap <span class="keyword">in</span> （si） == <span class="number">0</span>，swap <span class="keyword">out</span> （so） == <span class="number">0</span></span><br><span class="line">- 应用程序可用内存/系统物理内存 &lt;= <span class="number">70</span>%</span><br></pre></td></tr></table></figure>



<p>2、监控工具</p>
<ul>
<li><p>vmstat</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ vmstat <span class="number">1</span></span><br><span class="line">procs -----------memory---------- ---swap-- -----io---- --system-- -----cpu------</span><br><span class="line">r b  swpd  free  buff cache  si  so  bi  bo  <span class="keyword">in</span>  cs us sy id wa st</span><br><span class="line"><span class="number">0</span> <span class="number">3</span> <span class="number">252696</span>  <span class="number">2432</span>  <span class="number">268</span>  <span class="number">7148</span> <span class="number">3604</span> <span class="number">2368</span> <span class="number">3608</span> <span class="number">2372</span> <span class="number">288</span> <span class="number">288</span> <span class="number">0</span> <span class="number">0</span> <span class="number">21</span> <span class="number">78</span> <span class="number">1</span></span><br><span class="line"><span class="number">0</span> <span class="number">2</span> <span class="number">253484</span>  <span class="number">2216</span>  <span class="number">228</span>  <span class="number">7104</span> <span class="number">5368</span> <span class="number">2976</span> <span class="number">5372</span> <span class="number">3036</span> <span class="number">930</span> <span class="number">519</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">100</span> <span class="number">0</span></span><br><span class="line"><span class="number">0</span> <span class="number">1</span> <span class="number">259252</span>  <span class="number">2616</span>  <span class="number">128</span>  <span class="number">6148</span> <span class="number">19784</span> <span class="number">18712</span> <span class="number">19784</span> <span class="number">18712</span> <span class="number">3821</span> <span class="number">1853</span> <span class="number">0</span> <span class="number">1</span> <span class="number">3</span> <span class="number">95</span> <span class="number">1</span></span><br><span class="line"><span class="number">1</span> <span class="number">2</span> <span class="number">260008</span>  <span class="number">2188</span>  <span class="number">144</span>  <span class="number">6824</span> <span class="number">11824</span> <span class="number">2584</span> <span class="number">12664</span> <span class="number">2584</span> <span class="number">1347</span> <span class="number">1174</span> <span class="number">14</span> <span class="number">0</span> <span class="number">0</span> <span class="number">86</span> <span class="number">0</span></span><br><span class="line"><span class="number">2</span> <span class="number">1</span> <span class="number">262140</span>  <span class="number">2964</span>  <span class="number">128</span>  <span class="number">5852</span> <span class="number">24912</span> <span class="number">17304</span> <span class="number">24952</span> <span class="number">17304</span> <span class="number">4737</span> <span class="number">2341</span> <span class="number">86</span> <span class="number">10</span> <span class="number">0</span> <span class="number">0</span> <span class="number">4</span></span><br><span class="line"></span><br><span class="line">重要参数：</span><br><span class="line">swpd，已使用的 SWAP 空间大小，KB 为单位；</span><br><span class="line">free，可用的物理内存大小，KB 为单位；</span><br><span class="line">buff，物理内存用来缓存读写操作的buffer大小，KB 为单位；</span><br><span class="line">cache，物理内存用来缓存进程地址空间的 cache 大小，KB 为单位；</span><br><span class="line">si，数据从 SWAP 读取到 RAM（swap <span class="keyword">in</span>）的大小，KB 为单位；</span><br><span class="line">so，数据从 RAM 写到 SWAP（swap <span class="keyword">out</span>）的大小，KB 为单位。</span><br><span class="line"></span><br><span class="line">上例可得：</span><br><span class="line">物理可用内存 free 基本没什么显著变化，swapd逐步增加，说明最小可用的内存始终保持在 <span class="number">256</span>MB(物理内存大小) * <span class="number">10</span>％ = <span class="number">2.56</span>MB 左右，当脏页达到<span class="number">10</span>％的时候就开始大量使用swap。</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>free</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">free</span> <span class="string">-m</span></span><br><span class="line"><span class="string">total</span> <span class="string">used</span> <span class="string">free</span> <span class="string">shared</span> <span class="string">buffers</span> <span class="string">cached</span></span><br><span class="line"><span class="attr">Mem:</span> <span class="number">8111</span> <span class="number">7185</span> <span class="number">926</span> <span class="number">0</span> <span class="number">243</span> <span class="number">6299</span></span><br><span class="line"><span class="string">-/+</span> <span class="attr">buffers/cache:</span> <span class="number">643</span> <span class="number">7468</span></span><br><span class="line"><span class="attr">Swap:</span> <span class="number">8189</span> <span class="number">0</span> <span class="number">8189</span></span><br></pre></td></tr></table></figure>



</li>
</ul>
<h2 id="三、磁盘IO"><a href="#三、磁盘IO" class="headerlink" title="三、磁盘IO"></a>三、磁盘IO</h2><p>1、良好状态指标</p>
<ul>
<li><p>iowait % &lt; 20%</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">提高命中率的一个简单方式就是增大文件缓存区面积，缓存区越大预存的页面就越多，命中率也越高。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Linux</span> <span class="string">内核希望能尽可能产生次缺页中断（从文件缓存区读），并且能尽可能避免主缺页中断（从硬盘读），这样随着次缺页中断的增多，文件缓存区也逐步增大，直到系统只有少量可用物理内存的时候 Linux 才开始释放一些不用的页。</span></span><br></pre></td></tr></table></figure>



</li>
</ul>
<p>2、监控工具</p>
<ul>
<li><p>查看物理内存和文件缓存情况</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ cat /proc/meminfo</span><br><span class="line">MemTotal:   <span class="number">8182776</span> kB</span><br><span class="line">MemFree:    <span class="number">3053808</span> kB</span><br><span class="line">Buffers:    <span class="number">342704</span> kB</span><br><span class="line">Cached:    <span class="number">3972748</span> kB</span><br><span class="line">这台服务器总共有 <span class="number">8</span>GB 物理内存（MemTotal），<span class="number">3</span>GB 左右可用内存（MemFree），<span class="number">343</span>MB左右用来做磁盘缓存（Buffers），<span class="number">4</span>GB左右用来做文件缓存区（Cached）。</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>sar</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ sar -d <span class="number">2</span> <span class="number">3</span></span><br><span class="line">Linux <span class="number">2.6</span><span class="number">.9</span><span class="number">-42.</span>ELsmp (webserver) <span class="number">11</span>/<span class="number">30</span>/<span class="number">2008</span> _i686_ (<span class="number">8</span> CPU)</span><br><span class="line"><span class="number">11</span>:<span class="number">09</span>:<span class="number">33</span> PM DEV tps rd_sec/s wr_sec/s avgrq-sz avgqu-sz await svctm %util</span><br><span class="line"><span class="number">11</span>:<span class="number">09</span>:<span class="number">35</span> PM dev8<span class="number">-0</span> <span class="number">0.00</span> <span class="number">0.00</span> <span class="number">0.00</span> <span class="number">0.00</span> <span class="number">0.00</span> <span class="number">0.00</span> <span class="number">0.00</span> <span class="number">0.00</span></span><br><span class="line"><span class="number">11</span>:<span class="number">09</span>:<span class="number">35</span> PM DEV tps rd_sec/s wr_sec/s avgrq-sz avgqu-sz await svctm %util</span><br><span class="line"><span class="number">11</span>:<span class="number">09</span>:<span class="number">37</span> PM dev8<span class="number">-0</span> <span class="number">1.00</span> <span class="number">0.00</span> <span class="number">12.00</span> <span class="number">12.00</span> <span class="number">0.00</span> <span class="number">0.00</span> <span class="number">0.00</span> <span class="number">0.00</span></span><br><span class="line"><span class="number">11</span>:<span class="number">09</span>:<span class="number">37</span> PM DEV tps rd_sec/s wr_sec/s avgrq-sz avgqu-sz await svctm %util</span><br><span class="line"><span class="number">11</span>:<span class="number">09</span>:<span class="number">39</span> PM dev8<span class="number">-0</span> <span class="number">1.99</span> <span class="number">0.00</span> <span class="number">47.76</span> <span class="number">24.00</span> <span class="number">0.00</span> <span class="number">0.50</span> <span class="number">0.25</span> <span class="number">0.05</span></span><br><span class="line">Average: DEV tps rd_sec/s wr_sec/s avgrq-sz avgqu-sz await svctm %util</span><br><span class="line">Average: dev8<span class="number">-0</span> <span class="number">1.00</span> <span class="number">0.00</span> <span class="number">19.97</span> <span class="number">20.00</span> <span class="number">0.00</span> <span class="number">0.33</span> <span class="number">0.17</span> <span class="number">0.02</span></span><br><span class="line"></span><br><span class="line">重要参数：</span><br><span class="line">await表示平均每次设备I/O操作的等待时间（以毫秒为单位）。</span><br><span class="line">svctm表示平均每次设备I/O操作的服务时间（以毫秒为单位）。</span><br><span class="line">%util表示一秒中有百分之几的时间用于I/O操作。</span><br><span class="line">如果svctm的值与await很接近，表示几乎没有I/O等待，磁盘性能很好，如果await的值远高于svctm的值，则表示I/O队列等待太长，系统上运行的应用程序将变慢。</span><br><span class="line">如果%util接近<span class="number">100</span>%，表示磁盘产生的I/O请求太多，I/O系统已经满负荷的在工作，该磁盘可能存在瓶颈。</span><br></pre></td></tr></table></figure>







</li>
</ul>
<h2 id="四、Network-IO"><a href="#四、Network-IO" class="headerlink" title="四、Network IO"></a>四、Network IO</h2><p>对于UDP</p>
<p>1、良好状态指标</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">接收、发送缓冲区不长时间有等待处理的网络包</span><br></pre></td></tr></table></figure>



<p>2、监控工具</p>
<ul>
<li>netstat</li>
</ul>
<p>对于UDP服务，查看所有监听的UDP端口的网络情况</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ watch netstat -lunp</span><br><span class="line">Proto Recv-Q Send-Q Local Address      Foreign Address     State    PID/Program name</span><br><span class="line">udp    <span class="number">0</span>   <span class="number">0</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">64000</span>      <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:*              -</span><br><span class="line">udp    <span class="number">0</span>   <span class="number">0</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">38400</span>      <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:*              -</span><br><span class="line">udp    <span class="number">0</span>   <span class="number">0</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">38272</span>      <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:*              -</span><br><span class="line">udp    <span class="number">0</span>   <span class="number">0</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">36992</span>      <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:*              -</span><br><span class="line">udp    <span class="number">0</span>   <span class="number">0</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">17921</span>      <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:*              -</span><br><span class="line">udp    <span class="number">0</span>   <span class="number">0</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">11777</span>      <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:*              -</span><br><span class="line">udp    <span class="number">0</span>   <span class="number">0</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">14721</span>      <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:*              -</span><br><span class="line">udp    <span class="number">0</span>   <span class="number">0</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">36225</span>      <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:*              -</span><br><span class="line"></span><br><span class="line">RecvQ、SendQ为<span class="number">0</span>，或者不长时间有数值是比较正常的。</span><br></pre></td></tr></table></figure>





<p>对于UDP服务，查看丢包情况（网卡收到了，但是应用层没有处理过来造成的丢包）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ watch netstat -su</span><br><span class="line">Udp:</span><br><span class="line">  278073881 packets received</span><br><span class="line">  4083356897 packets to unknown port received.</span><br><span class="line">  2474435364 packet receive errors</span><br><span class="line">  1079038030 packets sent</span><br><span class="line"></span><br><span class="line">packet receive errors 这一项数值增长了，则表明在丢包。</span><br><span class="line"></span><br><span class="line">[这里](http://www.withdevo.net/?p=18)有对“packet receive errors”的稍微详细些的解释，它包含了7种错误，and通常表明是<span class="keyword">checksum</span>错误。不过我们通常通过这个数值的变化来判断UDP服务是否丢包（第<span class="number">2</span>项错误），不知道是否有其他什么方法来判断UDP的丢包？：</span><br><span class="line"></span><br><span class="line"><span class="string">"packet receive errors"</span> usually means:</span><br><span class="line">\<span class="number">1</span>) <span class="keyword">data</span> <span class="keyword">is</span> truncated, <span class="keyword">error</span> <span class="keyword">in</span> <span class="keyword">checksum</span> <span class="keyword">while</span> copying</span><br><span class="line">\<span class="number">2</span>) udp queue <span class="keyword">is</span> <span class="keyword">full</span>, so it needs <span class="keyword">to</span> be dropped</span><br><span class="line">\<span class="number">3</span>) unable <span class="keyword">to</span> receive udp <span class="keyword">package</span> <span class="keyword">from</span> encapsulated socket</span><br><span class="line">\<span class="number">4</span>) sock_queue_rcv_skb() <span class="keyword">failed</span> <span class="keyword">with</span> -ENOMEM</span><br><span class="line">\<span class="number">5</span>) it <span class="keyword">is</span> a <span class="keyword">short</span> packet</span><br><span class="line">\<span class="number">6</span>) <span class="keyword">no</span> <span class="keyword">space</span> <span class="keyword">for</span> header <span class="keyword">in</span> udp packet <span class="keyword">when</span> validating packet</span><br><span class="line">\<span class="number">7</span>) xfrm6_policy_check() fails</span><br><span class="line">many times it means the <span class="keyword">checksum</span> <span class="keyword">is</span> <span class="keyword">not</span> right.</span><br></pre></td></tr></table></figure>





<p>对于TCP（来自david的经验，thx~~）</p>
<p>1、良好状态指标</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">对于TCP而言，不会出现因为缓存不足而存在丢包的事，因为网络等其他原因，导致丢了包，协议层也会通过重传机制来保证丢的包到达对方。</span><br><span class="line"></span><br><span class="line">所以，tcp而言更多的专注重传率。</span><br></pre></td></tr></table></figure>



<p>2、监控工具</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /proc/net/snmp | grep Tcp:</span></span><br><span class="line"><span class="attr">Tcp:</span> <span class="string">RtoAlgorithm</span> <span class="string">RtoMin</span> <span class="string">RtoMax</span> <span class="string">MaxConn</span> <span class="string">ActiveOpens</span> <span class="string">PassiveOpens</span> <span class="string">AttemptFails</span> <span class="string">EstabResets</span> <span class="string">CurrEstab</span> <span class="string">InSegs</span> <span class="string">OutSegs</span> <span class="string">RetransSegs</span> <span class="string">InErrs</span> <span class="string">OutRsts</span></span><br><span class="line"><span class="attr">Tcp:</span> <span class="number">1</span> <span class="number">200</span> <span class="number">120000</span> <span class="number">-1</span> <span class="number">78447</span> <span class="number">413</span> <span class="number">50234</span> <span class="number">221</span> <span class="number">3</span> <span class="number">5984652</span> <span class="number">5653408</span> <span class="number">156800</span> <span class="number">0</span> <span class="number">849</span></span><br><span class="line"></span><br><span class="line"><span class="string">重传率</span> <span class="string">=</span> <span class="string">RetransSegs</span> <span class="string">/</span> <span class="string">OutSegs</span></span><br><span class="line"><span class="string">至于这个值在多少范围内，算ok的，得看具体的业务了。</span></span><br><span class="line"><span class="string">业务侧更关注的是响应时间。</span></span><br><span class="line"><span class="string">每天一点点，感受自己存在的意义。</span></span><br></pre></td></tr></table></figure>



<h1 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">dstat</span> <span class="string">–c</span> <span class="string">打印cpu</span></span><br><span class="line"><span class="string">top</span></span><br><span class="line"></span><br><span class="line"><span class="string">[root@host-80-80-41-196</span> <span class="string">webcache]#</span> <span class="string">dstat</span> <span class="string">-c</span> <span class="number">2</span></span><br><span class="line"><span class="number">2</span><span class="string">秒打印一次</span></span><br><span class="line"><span class="string">----total-cpu-usage----</span></span><br><span class="line"><span class="string">usr</span>   <span class="string">sys</span> <span class="string">idl</span>  <span class="string">wai</span> <span class="string">hiq</span> <span class="string">siq</span></span><br><span class="line">  <span class="number">5</span>   <span class="number">5</span>   <span class="number">85</span>   <span class="number">2</span>   <span class="number">1</span>   <span class="number">1</span></span><br><span class="line">  <span class="number">3</span>   <span class="number">2</span>   <span class="number">94</span>   <span class="number">0</span>   <span class="number">1</span>   <span class="number">1</span></span><br><span class="line">  <span class="number">4</span>   <span class="number">2</span>   <span class="number">91</span>   <span class="number">1</span>   <span class="number">1</span>   <span class="number">1</span></span><br><span class="line"><span class="string">usr:用户占用</span></span><br><span class="line"><span class="string">sys:系统占中</span></span><br><span class="line"><span class="string">idl:cpu空闲</span></span><br><span class="line"><span class="string">wai:等待</span></span><br><span class="line"><span class="string">hiq:中断</span></span><br><span class="line"><span class="string">siq:软件中断</span></span><br><span class="line"></span><br><span class="line"><span class="string">dstat</span> <span class="string">服务器性能查看命令</span></span><br><span class="line"><span class="comment"># dstat -c</span></span><br><span class="line">   <span class="string">usr:用户占用，sys系统占中，idl</span> <span class="string">cpu空闲，</span> <span class="string">wai等待，hiq中断，siq软件中断</span></span><br><span class="line"><span class="comment"># dstat -C</span></span><br><span class="line">   <span class="string">-C</span> <span class="string">当多个CPU的时候用此参数</span></span><br><span class="line"><span class="comment"># dstat -C 0,1 显示CPU0和1</span></span><br><span class="line"><span class="comment"># dstat -d 显示磁盘读写数据大小</span></span><br><span class="line"><span class="comment"># dstat -n 显示网络状态</span></span><br><span class="line"><span class="comment"># dstat -N eth1 有多块网卡时指定要显示的网卡</span></span><br><span class="line"><span class="comment"># dstat -l 显示系统负载</span></span><br><span class="line"><span class="comment"># dstat -m 显示内存使用情况</span></span><br><span class="line"><span class="comment"># dstat -g 显示页面使用情况</span></span><br><span class="line"><span class="comment"># dstat -p 显示进程状态</span></span><br><span class="line"><span class="comment"># dstat -s 显示swap使用状态</span></span><br><span class="line"><span class="comment"># dstat -r I/O 请求情况</span></span><br><span class="line"><span class="comment"># dstat --socket 用来显示tcp udp端口状态</span></span><br><span class="line"><span class="comment"># dstat -v vmstat</span></span><br><span class="line"><span class="comment"># dstat --output /home/dd.csv可以把状态信息以csv的格式重定向到指定的文件中，以便日后查看</span></span><br><span class="line"></span><br><span class="line"><span class="string">---------------------------------------------------</span></span><br><span class="line"><span class="string">lscpu命令，查看的是cpu的统计信息.</span></span><br><span class="line"><span class="string">blue@blue-pc:~$</span> <span class="string">lscpu</span></span><br><span class="line"><span class="attr">Architecture:</span>          <span class="string">i686</span>            <span class="comment">#cpu架构</span></span><br><span class="line"><span class="string">CPU</span> <span class="string">op-mode(s):</span>        <span class="number">32</span><span class="string">-bit,</span> <span class="number">64</span><span class="string">-bit</span></span><br><span class="line"><span class="attr">Byte Order:</span>            <span class="string">Little</span> <span class="string">Endian</span>   <span class="comment">#小尾序</span></span><br><span class="line"><span class="string">CPU(s):</span>                <span class="number">4</span>               <span class="comment">#总共有4核</span></span><br><span class="line"><span class="string">On-line</span> <span class="string">CPU(s)</span> <span class="attr">list:</span>   <span class="number">0</span><span class="number">-3</span></span><br><span class="line"><span class="string">Thread(s)</span> <span class="attr">per core:</span>    <span class="number">1</span>               <span class="comment">#每个cpu核，只能支持一个线程，即不支持超线程</span></span><br><span class="line"><span class="string">Core(s)</span> <span class="attr">per socket:</span>    <span class="number">4</span>               <span class="comment">#每个cpu，有4个核</span></span><br><span class="line"><span class="string">Socket(s):</span>             <span class="number">1</span>               <span class="comment">#总共有1一个cpu</span></span><br><span class="line"><span class="attr">Vendor ID:</span>             <span class="string">GenuineIntel</span>    <span class="comment">#cpu产商 intel</span></span><br><span class="line"><span class="attr">CPU family:</span>            <span class="number">6</span></span><br><span class="line"><span class="attr">Model:</span>                 <span class="number">42</span></span><br><span class="line"><span class="attr">Stepping:</span>              <span class="number">7</span></span><br><span class="line"><span class="attr">CPU MHz:</span>               <span class="number">1600.000</span></span><br><span class="line"><span class="attr">BogoMIPS:</span>              <span class="number">5986.12</span></span><br><span class="line"><span class="attr">Virtualization:</span>        <span class="string">VT-x</span>            <span class="comment">#支持cpu虚拟化技术</span></span><br><span class="line"><span class="attr">L1d cache:</span>             <span class="string">32K</span></span><br><span class="line"><span class="attr">L1i cache:</span>             <span class="string">32K</span></span><br><span class="line"><span class="attr">L2 cache:</span>              <span class="string">256K</span></span><br><span class="line"><span class="attr">L3 cache:</span>              <span class="string">6144K</span></span><br><span class="line"></span><br><span class="line"><span class="string">查看/proc/cpuinfo,可以知道每个cpu信息，如每个CPU的型号，主频等。</span></span><br><span class="line"><span class="comment">#cat /proc/cpuinfo</span></span><br><span class="line"><span class="attr">processor    :</span> <span class="number">0</span></span><br><span class="line"><span class="attr">vendor_id    :</span> <span class="string">GenuineIntel</span></span><br><span class="line"><span class="attr">cpu family    :</span> <span class="number">6</span></span><br><span class="line"><span class="attr">model        :</span> <span class="number">42</span></span><br><span class="line"><span class="attr">model name    :</span> <span class="string">Intel(R)</span> <span class="string">Core(TM)</span> <span class="string">i5-2320</span> <span class="string">CPU</span> <span class="string">@</span> <span class="number">3.</span><span class="string">00GHz</span></span><br><span class="line"><span class="string">.....</span></span><br><span class="line"></span><br><span class="line"><span class="string">上面输出的是第一个cpu部分信息，还有3个cpu信息省略了。</span></span><br></pre></td></tr></table></figure>



<h1 id="内存"><a href="#内存" class="headerlink" title="内存"></a>内存</h1><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">连接CPU和磁盘，放在内存速度快，规格DDR4</span><br><span class="line">free -m</span><br><span class="line"></span><br><span class="line">如下显示free是显示的当前内存的使用</span><br><span class="line">-m的意思是M字节来显示内容</span><br><span class="line">free -m</span><br><span class="line">total used free <span class="keyword">shared</span> buffers cached</span><br><span class="line">Mem: <span class="number">1002</span> <span class="number">769</span> <span class="number">232</span> <span class="number">0</span> <span class="number">62</span> <span class="number">421</span></span><br><span class="line">-/+ buffers/cache: <span class="number">286</span> <span class="number">715</span></span><br><span class="line">Swap: <span class="number">1153</span> <span class="number">0</span> <span class="number">1153</span></span><br><span class="line"></span><br><span class="line">第一部分Mem行:</span><br><span class="line">total 内存总数: <span class="number">1002</span>M</span><br><span class="line">used 已经使用的内存数: <span class="number">769</span>M</span><br><span class="line">free 空闲的内存数: <span class="number">232</span>M</span><br><span class="line"><span class="keyword">shared</span> 当前已经废弃不用,总是<span class="number">0</span></span><br><span class="line">buffers Buffer缓存内存数: <span class="number">62</span>M</span><br><span class="line">cached Page缓存内存数:<span class="number">421</span>M</span><br><span class="line">关系：total(<span class="number">1002</span>M) = used(<span class="number">769</span>M) + free(<span class="number">232</span>M)</span><br><span class="line"></span><br><span class="line">第二部分(-/+ buffers/cache):</span><br><span class="line">(-buffers/cache) used内存数：<span class="number">286</span>M </span><br><span class="line">(指的第一部分Mem行中的used – buffers – cached)</span><br><span class="line"></span><br><span class="line">(+buffers/cache) free内存数: <span class="number">715</span>M </span><br><span class="line">(指的第一部分Mem行中的free + buffers + cached)</span><br><span class="line"></span><br><span class="line">可见-buffers/cache反映的是被程序实实在在吃掉的内存,而+buffers/cache反映的是可以挪用的内存总数.</span><br><span class="line"></span><br><span class="line">第三部分是指交换分区, 我想不讲大家都明白.</span><br><span class="line">	大家看了上面,还是很晕.第一部分(Mem)与第二部分(-/+ buffers/cache)的结果中有关used和free为什么这么奇怪.</span><br><span class="line">其实我们可以从二个方面来解释:</span><br><span class="line">对操作系统来讲是Mem的参数,buffers/cached都是属于被使用,所以它认为free只有<span class="number">232.</span></span><br><span class="line">对应用程序来讲是(-/+ buffers/cach),buffers/cached 是等同可用的,因为buffer/cached是为了提高程序执行的性能,当程序使用内存时,buffer/cached会很快地被使用.</span><br><span class="line">　　所以,以应用来看看,以(-/+ buffers/cache)的free和used为主.所以我们看这个就好了，另外告诉大家一些常识，Linux为了提高磁盘和内存存取效率, Linux做了很多精心的设计, 除了对dentry进行缓存(用于VFS,加速文件路径名到inode的转换), 还采取了两种主要Cache方式：Buffer Cache和Page Cache.前者针对磁盘块的读写,后者针对文件inode的读写，这些Cache能有效缩短了 I/O系统调用(比如read,write,getdents)的时间。</span><br><span class="line">	记住内存是拿来用的,不是拿来看的，不像windows,无论你的真实物理内存有多少,他都要拿硬盘交换文件来读.这也就是windows为什么常常提示虚拟空间不足的原因。你们想想,多无聊,在内存还有大部分的时候,拿出一部分硬盘空间来充当内存，硬盘怎么会快过内存.所以我们看linux,只要不用swap的交换空间,就不用担心自己的内存太少.如果常常swap用很多,可能你就要考虑加物理内存了.这也是linux看内存是否够用的标准哦。</span><br><span class="line"></span><br><span class="line">查看内存条数命令：</span><br><span class="line">dmidecode | grep -A16 <span class="string">"Memory Device$"</span>s</span><br><span class="line"></span><br><span class="line">dstat –m</span><br><span class="line">[<span class="symbol">root@</span>host<span class="number">-80</span><span class="number">-80</span><span class="number">-41</span><span class="number">-196</span> webcache]# dstat -m</span><br><span class="line">------memory-usage-----</span><br><span class="line"> used  buff  cach  free</span><br><span class="line"><span class="number">1627</span>M <span class="number">11.9</span>M <span class="number">2266</span>M <span class="number">45.3</span>M</span><br><span class="line"><span class="number">1631</span>M <span class="number">11.9</span>M <span class="number">2266</span>M <span class="number">41.0</span>M</span><br><span class="line"><span class="number">1633</span>M <span class="number">11.9</span>M <span class="number">2266</span>M <span class="number">39.1</span>M</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">释放内存：</span><br><span class="line"><span class="number">1.</span>清理前内存使用情况 </span><br><span class="line">free -m</span><br><span class="line"><span class="number">2.</span>开始清理: </span><br><span class="line">echo <span class="number">3</span> &gt; /proc/sys/vm/drop_caches</span><br><span class="line">【</span><br><span class="line">To free pagecache, use:</span><br><span class="line">echo <span class="number">1</span> &gt; /proc/sys/vm/drop_caches</span><br><span class="line"> </span><br><span class="line">to free dentries <span class="keyword">and</span> inodes, use:</span><br><span class="line">echo <span class="number">2</span> &gt; /proc/sys/vm/drop_caches</span><br><span class="line"></span><br><span class="line">to free pagecache, dentries <span class="keyword">and</span> inodes, use:</span><br><span class="line">echo <span class="number">3</span> &gt;/proc/sys/vm/drop_caches</span><br><span class="line">】</span><br><span class="line"><span class="number">3.</span>清理后内存使用情况 </span><br><span class="line">free -m</span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>完成!</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">概要查看内存情况</span><br><span class="line">free -m</span><br><span class="line">             total       used       free     <span class="keyword">shared</span>    buffers     cached</span><br><span class="line">Mem:          <span class="number">3926</span>       <span class="number">3651</span>        <span class="number">274</span>          <span class="number">0</span>         <span class="number">12</span>        <span class="number">404</span></span><br><span class="line">-/+ buffers/cache:       <span class="number">3235</span>        <span class="number">691</span></span><br><span class="line">Swap:         <span class="number">9536</span>         <span class="number">31</span>       <span class="number">9505</span></span><br><span class="line">这里的单位是MB，总共的内存是<span class="number">3926</span>MB。</span><br><span class="line"></span><br><span class="line">查看内存详细使用</span><br><span class="line"># cat /proc/meminfo </span><br><span class="line">MemTotal:        <span class="number">4020868</span> kB</span><br><span class="line">MemFree:          <span class="number">230884</span> kB</span><br><span class="line">Buffers:            <span class="number">7600</span> kB</span><br><span class="line">Cached:           <span class="number">454772</span> kB</span><br><span class="line">SwapCached:          <span class="number">836</span> kB</span><br><span class="line">.....</span><br><span class="line"> </span><br><span class="line">查看内存硬件信息</span><br><span class="line">dmidecode -t memory</span><br><span class="line"># dmidecode <span class="number">2.11</span></span><br><span class="line">SMBIOS <span class="number">2.7</span> present.</span><br><span class="line"></span><br><span class="line">Handle <span class="number">0x0008</span>, DMI type <span class="number">16</span>, <span class="number">23</span> bytes</span><br><span class="line">Physical Memory Array</span><br><span class="line">    Location: System Board Or Motherboard</span><br><span class="line">....</span><br><span class="line">    Maximum Capacity: <span class="number">32</span> GB</span><br><span class="line">....</span><br><span class="line"></span><br><span class="line">Handle <span class="number">0x000A</span>, DMI type <span class="number">17</span>, <span class="number">34</span> bytes</span><br><span class="line">....</span><br><span class="line">Memory Device</span><br><span class="line">    Array Handle: <span class="number">0x0008</span></span><br><span class="line">    Error Information Handle: Not Provided</span><br><span class="line">    Total Width: <span class="number">64</span> bits</span><br><span class="line">    Data Width: <span class="number">64</span> bits</span><br><span class="line">    Size: <span class="number">4096</span> MB</span><br><span class="line">.....</span><br><span class="line"></span><br><span class="line">我的主板有<span class="number">4</span>个槽位，只用了一个槽位，上面插了一条<span class="number">4096</span>MB的内存。</span><br></pre></td></tr></table></figure>



<h1 id="IO"><a href="#IO" class="headerlink" title="IO"></a>IO</h1><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">SATA,SAS,SSD(转的越快越好)</span><br><span class="line"></span><br><span class="line">最好的磁盘是SSD</span><br><span class="line">lsscsi(实际磁盘的挂载)</span><br><span class="line">df –h</span><br><span class="line"></span><br><span class="line">查看硬盘和分区分布</span><br><span class="line"># lsblk</span><br><span class="line">NAME   MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT</span><br><span class="line">sda      <span class="number">8</span>:<span class="number">0</span>    <span class="number">0</span> <span class="number">465.8</span>G  <span class="number">0</span> disk </span><br><span class="line">├─sda1   <span class="number">8</span>:<span class="number">1</span>    <span class="number">0</span>     <span class="number">1</span>G  <span class="number">0</span> part /boot</span><br><span class="line">├─sda2   <span class="number">8</span>:<span class="number">2</span>    <span class="number">0</span>   <span class="number">9.3</span>G  <span class="number">0</span> part [SWAP]</span><br><span class="line">├─sda3   <span class="number">8</span>:<span class="number">3</span>    <span class="number">0</span>  <span class="number">74.5</span>G  <span class="number">0</span> part /</span><br><span class="line">├─sda4   <span class="number">8</span>:<span class="number">4</span>    <span class="number">0</span>     <span class="number">1</span>K  <span class="number">0</span> part </span><br><span class="line">├─sda5   <span class="number">8</span>:<span class="number">5</span>    <span class="number">0</span> <span class="number">111.8</span>G  <span class="number">0</span> part /home</span><br><span class="line">└─sda6   <span class="number">8</span>:<span class="number">6</span>    <span class="number">0</span> <span class="number">269.2</span>G  <span class="number">0</span> part </span><br><span class="line"></span><br><span class="line">显示很直观</span><br><span class="line"></span><br><span class="line">如果要看硬盘和分区的详细信息</span><br><span class="line"># fdisk -l</span><br><span class="line">Disk /dev/sda: <span class="number">500.1</span> GB, <span class="number">500107862016</span> bytes</span><br><span class="line"><span class="number">255</span> heads, <span class="number">63</span> sectors/track, <span class="number">60801</span> cylinders, total <span class="number">976773168</span> sectors</span><br><span class="line">Units = sectors of <span class="number">1</span> * <span class="number">512</span> = <span class="number">512</span> bytes</span><br><span class="line">Sector size (logical/physical): <span class="number">512</span> bytes / <span class="number">4096</span> bytes</span><br><span class="line">I/O size (minimum/optimal): <span class="number">4096</span> bytes / <span class="number">4096</span> bytes</span><br><span class="line">Disk identifier: <span class="number">0x00023728</span></span><br><span class="line"></span><br><span class="line">   Device Boot      Start         End      Blocks   Id  System</span><br><span class="line">/dev/sda1   *        <span class="number">2048</span>     <span class="number">2148351</span>     <span class="number">1073152</span>   <span class="number">83</span>  Linux</span><br><span class="line">/dev/sda2         <span class="number">2148352</span>    <span class="number">21680127</span>     <span class="number">9765888</span>   <span class="number">82</span>  Linux swap / Solaris</span><br><span class="line">/dev/sda3        <span class="number">21680128</span>   <span class="number">177930239</span>    <span class="number">78125056</span>   <span class="number">83</span>  Linux</span><br><span class="line">/dev/sda4       <span class="number">177932286</span>   <span class="number">976771071</span>   <span class="number">399419393</span>    <span class="number">5</span>  Extended/dev/sda5       <span class="number">177932288</span>   <span class="number">412305407</span>   <span class="number">117186560</span>   <span class="number">83</span>  Linux</span><br><span class="line">/dev/sda6       <span class="number">412307456</span>   <span class="number">976771071</span>   <span class="number">282231808</span>   <span class="number">83</span>  Linux</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">iostat -xm <span class="number">2</span></span><br><span class="line">[<span class="symbol">root@</span>host<span class="number">-80</span><span class="number">-80</span><span class="number">-41</span><span class="number">-196</span> vm]# iostat -xm <span class="number">2</span></span><br><span class="line">Linux <span class="number">2.6</span><span class="number">.18</span><span class="number">-164.</span>el5 (host<span class="number">-80</span><span class="number">-80</span><span class="number">-41</span><span class="number">-196</span>)    <span class="number">2017</span>年<span class="number">02</span>月<span class="number">04</span>日</span><br><span class="line">avg-cpu:  %user   %nice %system %iowait  %steal   %idle</span><br><span class="line">           <span class="number">5.26</span>    <span class="number">0.00</span>    <span class="number">7.53</span>    <span class="number">1.84</span>    <span class="number">0.00</span>    <span class="number">85.38</span></span><br><span class="line">Device:         rrqm/s   wrqm/s   r/s   w/s    rMB/s    wMB/s avgrq-sz avgqu-sz   await  svctm  %util</span><br><span class="line">vda               <span class="number">0.04</span>     <span class="number">2.48</span>  <span class="number">3.21</span> <span class="number">17.36</span>     <span class="number">0.02</span>     <span class="number">0.38</span>    <span class="number">40.03</span>     <span class="number">2.13</span>  <span class="number">103.45</span>   <span class="number">2.92</span>   <span class="number">6.01</span></span><br><span class="line">vda1              <span class="number">0.03</span>     <span class="number">2.48</span>  <span class="number">3.21</span> <span class="number">17.36</span>     <span class="number">0.02</span>     <span class="number">0.38</span>    <span class="number">40.03</span>     <span class="number">2.13</span>  <span class="number">103.45</span>   <span class="number">2.92</span>   <span class="number">6.01</span></span><br><span class="line">vdb               <span class="number">0.00</span>     <span class="number">0.00</span>  <span class="number">0.00</span>  <span class="number">0.00</span>     <span class="number">0.00</span>     <span class="number">0.00</span>    <span class="number">21.07</span>     <span class="number">0.00</span>    <span class="number">4.33</span>   <span class="number">4.33</span>   <span class="number">0.00</span></span><br><span class="line"></span><br><span class="line">第一部分包含了CPU报告</span><br><span class="line">•	%user : 	显示了在执行用户(应用)层时的CPU利用率</span><br><span class="line">•	%nice : 	显示了在以nice优先级运行用户层的CPU利用率</span><br><span class="line">•	%system : 	显示了在执行系统(内核)层时的CPU利用率</span><br><span class="line">•	%iowait : 	显示了CPU在I/O请求挂起时空闲时间的百分比</span><br><span class="line">•	%steal : 	显示了当hypervisor正服务于另外一个虚拟处理器时无意识地等待虚拟CPU所占有的时间百分比。</span><br><span class="line">• %idle : 		显示了CPU在I/O没有挂起请求时空闲时间的百分比</span><br><span class="line"></span><br><span class="line">第二部分包含了设备利用率报告</span><br><span class="line">Device : 		列出的/dev 目录下的设备/分区名称</span><br><span class="line">tps : 			显示每秒传输给设备的数量。更高的tps意味着处理器更忙。</span><br><span class="line">Blk_read/s : 	显示了每秒从设备上读取的块的数量(KB,MB)</span><br><span class="line">Blk_wrtn/s : 	显示了每秒写入设备上块的数量(KB,MB)</span><br><span class="line">Blk_read : 		显示所有已读取的块</span><br><span class="line">Blk_wrtn : 		显示所有已写入的块</span><br><span class="line">注：%idle表示磁盘的忙和闲</span><br><span class="line"></span><br><span class="line">dd  <span class="keyword">if</span>=/dev/zero  of=/home/a.txt  bs=<span class="number">100</span>m  count=<span class="number">10</span></span><br><span class="line">备份/dev/zero磁盘开始<span class="number">100</span>m到指定路径/home/a.txt仅拷贝<span class="number">10</span>个块</span><br></pre></td></tr></table></figure>



<h1 id="带宽"><a href="#带宽" class="headerlink" title="带宽"></a>带宽</h1><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">命令：ethtool eth* </span><br><span class="line">如：ethtool eth1或者ethtool eth0</span><br><span class="line">ethtool eth1</span><br><span class="line">网卡down掉：ifconfig eth1 down / ifconfig eth1 up</span><br><span class="line">电口和光口看Port: Twisted Pair</span><br><span class="line">(Twisted Pair为电口，也叫双绞线; Port：FIBRE为光口)</span><br><span class="line"></span><br><span class="line">[<span class="symbol">root@</span>host<span class="number">-80</span><span class="number">-80</span><span class="number">-41</span><span class="number">-196</span> webcache]# ethtool eth1</span><br><span class="line">Settings <span class="keyword">for</span> eth1:</span><br><span class="line">        Supported ports: [ TP ]</span><br><span class="line">        Supported link modes:   <span class="number">10</span>baseT/Half <span class="number">10</span>baseT/Full </span><br><span class="line">                                <span class="number">100</span>baseT/Half <span class="number">100</span>baseT/Full </span><br><span class="line">                                <span class="number">1000</span>baseT/Full </span><br><span class="line">        Supports <span class="built_in">auto</span>-negotiation: Yes</span><br><span class="line">        Advertised link modes:  <span class="number">10</span>baseT/Half <span class="number">10</span>baseT/Full </span><br><span class="line">                                <span class="number">100</span>baseT/Half <span class="number">100</span>baseT/Full </span><br><span class="line">                                <span class="number">1000</span>baseT/Full </span><br><span class="line">        Advertised <span class="built_in">auto</span>-negotiation: Yes</span><br><span class="line">        Speed: <span class="number">1000</span>Mb/s</span><br><span class="line">        Duplex: Full</span><br><span class="line">        Port: Twisted Pair</span><br><span class="line">        PHYAD: <span class="number">0</span></span><br><span class="line">        Transceiver: <span class="built_in">int</span>ernal</span><br><span class="line">        Auto-negotiation: on</span><br><span class="line">        Supports Wake-on: umbg</span><br><span class="line">        Wake-on: g</span><br><span class="line">        Current message level: <span class="number">0x00000007</span> (<span class="number">7</span>)</span><br><span class="line">        Link detected: yes</span><br><span class="line">        </span><br><span class="line">电口：<span class="number">1</span>G；</span><br><span class="line">光口（光纤）：<span class="number">10</span>G</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dstat –n <span class="number">2</span></span><br><span class="line">dstat –tcmnd 同时查看CPU，内存，IO，带宽</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">查看网卡硬件信息</span><br><span class="line"># lspci | grep -i <span class="string">'eth'</span></span><br><span class="line"><span class="number">02</span>:<span class="number">00.0</span> Ethernet controller: Realtek Semiconductor Co., Ltd. RTL8111/<span class="number">8168</span>B PCI Express Gigabit Ethernet controller (rev <span class="number">06</span>)</span><br><span class="line"> </span><br><span class="line">查看系统的所有网络接口</span><br><span class="line"># ifconfig -a</span><br><span class="line">eth0      Link encap:以太网  硬件地址 b8:<span class="number">97</span>:<span class="number">5</span>a:<span class="number">17</span>:b3:<span class="number">8f</span>  </span><br><span class="line">          .....</span><br><span class="line"></span><br><span class="line">lo        Link encap:本地环回  </span><br><span class="line">          .....</span><br><span class="line">或者是</span><br><span class="line">ip link show</span><br><span class="line"><span class="number">1</span>: lo: &lt;LOOPBACK&gt; mtu <span class="number">16436</span> qdisc noqueue state DOWN </span><br><span class="line">link/loopback <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> brd <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line"><span class="number">2</span>: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="number">1500</span> qdisc pfifo_fast state UP qlen <span class="number">1000</span></span><br><span class="line">link/ether b8:<span class="number">97</span>:<span class="number">5</span>a:<span class="number">17</span>:b3:<span class="number">8f</span> brd ff:ff:ff:ff:ff:ff</span><br><span class="line"> </span><br><span class="line">如果要查看某个网络接口的详细信息，例如eth0的详细参数和指标</span><br><span class="line"># ethtool eth0</span><br><span class="line">Settings <span class="keyword">for</span> eth0:</span><br><span class="line">    Supported ports: [ TP MII ]</span><br><span class="line">    Supported link modes:   <span class="number">10</span>baseT/Half <span class="number">10</span>baseT/Full </span><br><span class="line">                            <span class="number">100</span>baseT/Half <span class="number">100</span>baseT/Full </span><br><span class="line">                            <span class="number">1000</span>baseT/Half <span class="number">1000</span>baseT/Full #支持千兆半双工，全双工模式</span><br><span class="line">    Supported pause frame use: No </span><br><span class="line">    Supports <span class="built_in">auto</span>-negotiation: Yes #支持自适应模式，一般都支持</span><br><span class="line">    Advertised link modes:  <span class="number">10</span>baseT/Half <span class="number">10</span>baseT/Full </span><br><span class="line">                            <span class="number">100</span>baseT/Half <span class="number">100</span>baseT/Full </span><br><span class="line">                            <span class="number">1000</span>baseT/Half <span class="number">1000</span>baseT/Full</span><br><span class="line">    Advertised pause frame use: Symmetric Receive-only</span><br><span class="line">    Advertised <span class="built_in">auto</span>-negotiation: Yes #默认使用自适应模式</span><br><span class="line">    Link partner advertised link modes:  <span class="number">10</span>baseT/Half <span class="number">10</span>baseT/Full </span><br><span class="line">                                         <span class="number">100</span>baseT/Half <span class="number">100</span>baseT/Full </span><br><span class="line">    .....</span><br><span class="line">    Speed: <span class="number">100</span>Mb/s #现在网卡的速度是<span class="number">100</span>Mb,网卡使用自适应模式，所以推测路由是<span class="number">100</span>Mb，导致网卡从支持千兆，变成要支持百兆</span><br><span class="line">    Duplex: Full   #全双工</span><br><span class="line">    .....</span><br><span class="line">    Link detected: yes    #表示有网线连接，和路由是通的</span><br></pre></td></tr></table></figure>



<h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">查看pci信息，即主板所有硬件槽信息。</span><br><span class="line">lspci</span><br><span class="line">00:00.0 Host bridge: Intel Corporation 2nd Generation Core Processor Family DRAM Controller (rev 09) #主板芯片</span><br><span class="line">00:02.0 VGA compatible controller: Intel Corporation 2nd Generation Core Processor Family Integrated Graphics Controller (rev 09) #显卡</span><br><span class="line">00:14.0 USB controller: Intel Corporation Panther Point USB xHCI Host Controller (rev 04) #usb控制器</span><br><span class="line">00:16.0 Communication controller: Intel Corporation Panther Point MEI Controller #1 (rev 04)</span><br><span class="line">00:1a.0 USB controller: Intel Corporation Panther Point USB Enhanced Host Controller #2 (rev 04)</span><br><span class="line">00:1b.0 Audio device: Intel Corporation Panther Point High Definition Audio Controller (rev 04) #声卡</span><br><span class="line">00:1c.0 PCI bridge: Intel Corporation Panther Point PCI Express Root<span class="built_in"> Port </span>1 (rev c4) #pci 插槽</span><br><span class="line">00:1c.2 PCI bridge: Intel Corporation Panther Point PCI Express Root<span class="built_in"> Port </span>3 (rev c4)</span><br><span class="line">00:1c.3 PCI bridge: Intel Corporation Panther Point PCI Express Root<span class="built_in"> Port </span>4 (rev c4)</span><br><span class="line">00:1d.0 USB controller: Intel Corporation Panther Point USB Enhanced Host Controller #1 (rev 04)</span><br><span class="line">00:1f.0 ISA bridge: Intel Corporation Panther Point LPC Controller (rev 04)</span><br><span class="line">00:1f.2 IDE interface: Intel Corporation Panther Point 4<span class="built_in"> port </span>SATA Controller [IDE mode] (rev 04) #硬盘接口</span><br><span class="line">00:1f.3 SMBus: Intel Corporation Panther Point SMBus Controller (rev 04)</span><br><span class="line">00:1f.5 IDE interface: Intel Corporation Panther Point 2<span class="built_in"> port </span>SATA Controller [IDE mode] (rev 04) #硬盘接口</span><br><span class="line">02:00.0<span class="built_in"> Ethernet </span>controller: Realtek Semiconductor Co., Ltd. RTL8111/8168B PCI Express Gigabit<span class="built_in"> Ethernet </span>controller (rev 06) #网卡</span><br><span class="line">03:00.0 PCI bridge: Integrated Technology Express, Inc. Device 8893 (rev 41)</span><br><span class="line">如果要更详细的信息:lspci -v 或者 lspci -vv</span><br><span class="line">如果要看设备树:lscpi -t</span><br><span class="line"></span><br><span class="line"> 查看bios信息</span><br><span class="line"><span class="comment"># dmidecode -t bios</span></span><br><span class="line"><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span></span><br><span class="line">BIOS Information</span><br><span class="line">    Vendor: American Megatrends Inc.</span><br><span class="line">    Version: 4.6.5</span><br><span class="line">    Release Date: 04/25/2012</span><br><span class="line">    <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>.</span><br><span class="line">    BIOS Revision: 4.6</span><br><span class="line"><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span></span><br></pre></td></tr></table></figure>



<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">手工释放Linux内存——/proc/sys/vm/drop_cache</span><br><span class="line"></span><br><span class="line">linux的内存查看：</span><br><span class="line">[<span class="symbol">root@</span>localhost <span class="number">0.1</span><span class="number">.0</span>]# free -m</span><br><span class="line">             total       used       free     <span class="keyword">shared</span>    buffers     cached</span><br><span class="line">Mem:          <span class="number">4032</span>        <span class="number">694</span>       <span class="number">3337</span>          <span class="number">0</span>          <span class="number">0</span>         <span class="number">25</span></span><br><span class="line">需要说明的是，mem的used=free+buffers+cached，有些情况是cached占用很多资源，算起来数值就是不对，其实不影响实际使用，下面转载部分有说明如何清除cached的占用（实际上可以不清除，不会影响实际使用）</span><br><span class="line">当在Linux下频繁存取文件后，物理内存会很快被用光，当程序结束后，内存不会被正常释放，而是一直作为caching。这个问题，貌似有不少人在问，不过都没有看到有什么很好解决的办法。那么我来谈谈这个问题。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">一、通常情况</span><br><span class="line">先来说说free命令：</span><br><span class="line">引用[<span class="symbol">root@</span>server ~]# free -m</span><br><span class="line">total used free <span class="keyword">shared</span> buffers cached</span><br><span class="line">Mem: <span class="number">249</span> <span class="number">163</span> <span class="number">86</span> <span class="number">0</span> <span class="number">10</span> <span class="number">94</span></span><br><span class="line">-/+ buffers/cache: <span class="number">58</span> <span class="number">191</span></span><br><span class="line">Swap: <span class="number">511</span> <span class="number">0</span> <span class="number">511</span></span><br><span class="line">其中：</span><br><span class="line">引用total 内存总数</span><br><span class="line">used 已经使用的内存数</span><br><span class="line">free 空闲的内存数</span><br><span class="line"><span class="keyword">shared</span> 多个进程共享的内存总额</span><br><span class="line">buffers Buffer Cache和cached Page Cache 磁盘缓存的大小</span><br><span class="line">-buffers/cache 的内存数:used - buffers - cached</span><br><span class="line">+buffers/cache 的内存数:free + buffers + cached</span><br><span class="line">可用的memory=free memory+buffers+cached。</span><br><span class="line">有了这个基础后，可以得知，我现在used为<span class="number">163</span>MB，free为<span class="number">86</span>MB，buffer和cached分别为<span class="number">10</span>MB，<span class="number">94</span>MB。</span><br><span class="line">那么我们来看看,如果我执行复制文件,内存会发生什么变化.</span><br><span class="line">引用[<span class="symbol">root@</span>server ~]# cp -r /etc ~/test/</span><br><span class="line">[<span class="symbol">root@</span>server ~]# free -m</span><br><span class="line">total used free <span class="keyword">shared</span> buffers cached</span><br><span class="line">Mem: <span class="number">249</span> <span class="number">244</span> <span class="number">4</span> <span class="number">0</span> <span class="number">8</span> <span class="number">174</span></span><br><span class="line">-/+ buffers/cache: <span class="number">62</span> <span class="number">187</span></span><br><span class="line">Swap: <span class="number">511</span> <span class="number">0</span> <span class="number">511</span></span><br><span class="line">在我命令执行结束后，used为<span class="number">244</span>MB，free为<span class="number">4</span>MB，buffers为<span class="number">8</span>MB，cached为<span class="number">174</span>MB，天呐，都被cached吃掉了。别紧张，这是为了提高文件读取效率的做法。</span><br><span class="line">为了提高磁盘存取效率，Linux做了一些精心的设计，除了对dentry进行缓存（用于VFS，加速文件路径名到inode的转换），还采取了两种主要Cache方式：Buffer Cache和Page Cache。前者针对磁盘块的读写，后者针对文件inode的读写。这些Cache有效缩短了 I/O系统调用（比如read，write，getdents）的时间。</span><br><span class="line">那么有人说过段时间，linux会自动释放掉所用的内存。等待一段时间后，我们使用free再来试试，看看是否有释放？</span><br><span class="line">[<span class="symbol">root@</span>server test]# free -m</span><br><span class="line">total used free <span class="keyword">shared</span> buffers cached</span><br><span class="line">Mem: <span class="number">249</span> <span class="number">244</span> <span class="number">5</span> <span class="number">0</span> <span class="number">8</span> <span class="number">174</span></span><br><span class="line">-/+ buffers/cache: <span class="number">61</span> <span class="number">188</span></span><br><span class="line">Swap: <span class="number">511</span> <span class="number">0</span> <span class="number">511</span></span><br><span class="line">似乎没有任何变化。（实际情况下，内存的管理还与Swap有关）</span><br><span class="line">那么我能否手动释放掉这些内存呢？回答是可以的！</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">二、手动释放缓存</span><br><span class="line">/proc是一个虚拟文件系统，我们可以通过对它的读写操作做为与kernel实体间进行通信的一种手段。也就是说可以通过修改/proc中的文件，来对当前kernel的行为做出调整。那么我们可以通过调整/proc/sys/vm/drop_caches来释放内存。操作如下：</span><br><span class="line">[<span class="symbol">root@</span>server test]# cat /proc/sys/vm/drop_caches</span><br><span class="line"><span class="number">0</span></span><br><span class="line">首先，/proc/sys/vm/drop_caches的值，默认为<span class="number">0</span>。</span><br><span class="line">[<span class="symbol">root@</span>server test]# sync</span><br><span class="line">手动执行sync命令（描述：sync 命令运行 sync 子例程。如果必须停止系统，则运行sync 命令以确保文件系统的完整性。sync 命令将所有未写的系统缓冲区写到磁盘中，包含已修改的 i-node、已延迟的块 I/O 和读写映射文件）</span><br><span class="line">[<span class="symbol">root@</span>server test]# echo <span class="number">3</span> &gt; /proc/sys/vm/drop_caches</span><br><span class="line">[<span class="symbol">root@</span>server test]# cat /proc/sys/vm/drop_caches</span><br><span class="line"><span class="number">3</span></span><br><span class="line">将/proc/sys/vm/drop_caches值设为<span class="number">3</span></span><br><span class="line">[<span class="symbol">root@</span>server test]# free -m</span><br><span class="line">total used free <span class="keyword">shared</span> buffers cached</span><br><span class="line">Mem: <span class="number">249</span> <span class="number">66</span> <span class="number">182</span> <span class="number">0</span> <span class="number">0</span> <span class="number">11</span></span><br><span class="line">-/+ buffers/cache: <span class="number">55</span> <span class="number">194</span></span><br><span class="line">Swap: <span class="number">511</span> <span class="number">0</span> <span class="number">511</span></span><br><span class="line">再来运行free命令，会发现现在的used为<span class="number">66</span>MB，free为<span class="number">182</span>MB，buffers为<span class="number">0</span>MB，cached为<span class="number">11</span>MB。那么有效的释放了buffer和cache。</span><br><span class="line">有关/proc/sys/vm/drop_caches的用法在下面进行了说明</span><br><span class="line">引用/proc/sys/vm/drop_caches (since Linux <span class="number">2.6</span><span class="number">.16</span>)</span><br><span class="line">Writing to <span class="keyword">this</span> file causes the kernel to drop clean caches,dentries <span class="keyword">and</span> inodes <span class="keyword">from</span> memory, causing that memory to become free.</span><br><span class="line">To free pagecache, use</span><br><span class="line"> echo <span class="number">1</span> &gt; /proc/sys/vm/drop_caches;</span><br><span class="line"> to free dentries <span class="keyword">and</span> inodes, use</span><br><span class="line">echo <span class="number">2</span> &gt; /proc/sys/vm/drop_caches;</span><br><span class="line">to free pagecache, dentries <span class="keyword">and</span> inodes, use</span><br><span class="line"> echo <span class="number">3</span> &gt;/proc/sys/vm/drop_caches.</span><br><span class="line">Because <span class="keyword">this</span> <span class="keyword">is</span> a non-destructive operation <span class="keyword">and</span> dirty objects are <span class="keyword">not</span> freeable, the user should run sync first.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">三、我的意见</span><br><span class="line">上述文章就长期以来很多用户对Linux内存管理方面的疑问，给出了一个比较“直观”的回复，我更觉得有点像是核心开发小组的妥协。</span><br><span class="line">对于是否需要使用这个值，或向用户提及这个值，我是有保留意见的：</span><br><span class="line"><span class="number">1</span>、从man可以看到，这值从<span class="number">2.6</span><span class="number">.16</span>以后的核心版本才提供，也就是老版的操作系统，如红旗DC <span class="number">5.0</span>、RHEL <span class="number">4.</span>x之前的版本都没有；</span><br><span class="line"><span class="number">2</span>、若对于系统内存是否够用的观察，我还是原意去看swap的使用率和si/so两个值的大小；</span><br><span class="line">用户常见的疑问是，为什么free这么小，是否关闭应用后内存没有释放？</span><br><span class="line">但实际上，我们都知道这是因为Linux对内存的管理与Windows不同，free小并不是说内存不够用了，应该看的是free的第二行最后一个值：<span class="string">"-/+ buffers/cache: 58 191"</span> 这才是系统可用的内存大小。</span><br><span class="line">实际项目中告诉我们，如果因为是应用有像内存泄露、溢出的问题，从swap的使用情况是可以比较快速可以判断的，但free上面反而比较难查看。相反，如果在这个时候，我们告诉用户，修改系统的一个值，“可以”释放内存，free就大了。用户会怎么想？不会觉得操作系统“有问题”吗？所以说，我觉得既然核心是可以快速清空buffer或cache，也不难做到（这从上面的操作中可以明显看到），但核心并没有这样做（默认值是<span class="number">0</span>），我们就不应该随便去改变它。一般情况下，应用在系统上稳定运行了，free值也会保持在一个稳定值的，虽然看上去可能比较小。当发生内存不足、应用获取不到可用内存、OOM错误等问题时，还是更应该去分析应用方面的原因，如用户量太大导致内存不足、发生应用内存溢出等情况，否则，清空buffer，强制腾出free的大小，可能只是把问题给暂时屏蔽了。</span><br><span class="line">我觉得，排除内存不足的情况外，除非是在软件开发阶段，需要临时清掉buffer，以判断应用的内存使用情况；或应用已经不再提供支持，即使应用对内存的时候确实有问题，而且无法避免的情况下，才考虑定时清空buffer。（可惜，这样的应用通常都是运行在老的操作系统版本上，上面的操作也解决不了）。</span><br><span class="line">测试</span><br><span class="line">[<span class="symbol">root@</span>testserver ~]# uname -a</span><br><span class="line">Linux testserver <span class="number">2.6</span><span class="number">.18</span><span class="number">-164.</span>el5 #<span class="number">1</span> SMP Thu Sep <span class="number">3</span> <span class="number">03</span>:<span class="number">28</span>:<span class="number">30</span> EDT <span class="number">2009</span> x86_64 x86_64 x86_64 GNU/Linux</span><br><span class="line">[<span class="symbol">root@</span>testserver ~]# free -m</span><br><span class="line">             total       used       free     <span class="keyword">shared</span>    buffers     cached</span><br><span class="line">Mem:          <span class="number">2013</span>       <span class="number">1661</span>        <span class="number">352</span>          <span class="number">0</span>        <span class="number">223</span>       <span class="number">1206</span></span><br><span class="line">-/+ buffers/cache:        <span class="number">231</span>       <span class="number">1782</span></span><br><span class="line">Swap:         <span class="number">2047</span>          <span class="number">0</span>       <span class="number">2047</span></span><br><span class="line">[<span class="symbol">root@</span>testserver ~]# sync</span><br><span class="line">[<span class="symbol">root@</span>testserver ~]# sync</span><br><span class="line">[<span class="symbol">root@</span>testserver ~]# cat /proc/sys/vm/drop_caches</span><br><span class="line"><span class="number">0</span></span><br><span class="line">[<span class="symbol">root@</span>testserver ~]# echo <span class="number">3</span> &gt; /proc/sys/vm/drop_caches</span><br><span class="line">[<span class="symbol">root@</span>testserver ~]# cat /proc/sys/vm/drop_caches    </span><br><span class="line"><span class="number">3</span></span><br><span class="line">[<span class="symbol">root@</span>testserver ~]# free -m</span><br><span class="line">             total       used       free     <span class="keyword">shared</span>    buffers     cached</span><br><span class="line">Mem:          <span class="number">2013</span>        <span class="number">100</span>       <span class="number">1913</span>          <span class="number">0</span>          <span class="number">0</span>         <span class="number">14</span></span><br><span class="line">-/+ buffers/cache:         <span class="number">85</span>       <span class="number">1927</span></span><br><span class="line">Swap:         <span class="number">2047</span>          <span class="number">0</span>       <span class="number">2047</span></span><br></pre></td></tr></table></figure>



<p>待整理</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">timeout：</span><br><span class="line">cat <span class="regexp">/proc/</span>sys<span class="regexp">/net/</span>ipv4/tcp_fin_timeout</span><br><span class="line"></span><br><span class="line">curl多少大小：</span><br><span class="line">curl  -o <span class="regexp">/dev/</span><span class="literal">null</span>  -H <span class="string">"Range:bytes=0-1048576"</span></span><br></pre></td></tr></table></figure>



<p>命令ss</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">ss命令高级网络 </span><br><span class="line">ss命令用来显示处于活动状态的套接字信息。ss命令可以用来获取socket统计信息，它可以显示和netstat类似的内容。但ss的优势在于它能够显示更多更详细的有关TCP和连接状态的信息，而且比netstat更快速更高效。 当服务器的socket连接数量变得非常大时，无论是使用netstat命令还是直接cat /proc/net/tcp，执行速度都会很慢。可能你不会有切身的感受，但请相信我，当服务器维持的连接达到上万个的时候，使用netstat等于浪费 生命，而用ss才是节省时间。 天下武功唯快不破。ss快的秘诀在于，它利用到了TCP协议栈中tcp_diag。tcp_diag是一个用于分析统计的模块，可以获得Linux 内核中第一手的信息，这就确保了ss的快捷高效。当然，如果你的系统中没有tcp_diag，ss也可以正常运行，只是效率会变得稍慢。</span><br><span class="line"></span><br><span class="line"> 语法 ss(选项) 选项 </span><br><span class="line"><span class="deletion">-h：显示帮助信息； </span></span><br><span class="line"><span class="deletion">-V：显示指令版本信息； </span></span><br><span class="line"><span class="deletion">-n：不解析服务名称，以数字方式显示； </span></span><br><span class="line"><span class="deletion">-a：显示所有的套接字； </span></span><br><span class="line"><span class="deletion">-l：显示处于监听状态的套接字； </span></span><br><span class="line"><span class="deletion">-o：显示计时器信息； </span></span><br><span class="line"><span class="deletion">-m：显示套接字的内存使用情况； </span></span><br><span class="line"><span class="deletion">-p：显示使用套接字的进程信息； </span></span><br><span class="line"><span class="deletion">-i：显示内部的TCP信息； </span></span><br><span class="line"><span class="deletion">-4：只显示ipv4的套接字； </span></span><br><span class="line"><span class="deletion">-6：只显示ipv6的套接字； </span></span><br><span class="line"><span class="deletion">-t：只显示tcp套接字； </span></span><br><span class="line"><span class="deletion">-u：只显示udp套接字； </span></span><br><span class="line"><span class="deletion">-d：只显示DCCP套接字； </span></span><br><span class="line"><span class="deletion">-w：仅显示RAW套接字； </span></span><br><span class="line"><span class="deletion">-x：仅显示UNIX域套接字</span></span><br><span class="line"></span><br><span class="line">显示ICP连接</span><br><span class="line">ss -t -a</span><br><span class="line"></span><br><span class="line">显示 Sockets 摘要</span><br><span class="line">ss -s</span><br><span class="line">列出当前的established, closed, orphaned and waiting TCP sockets</span><br><span class="line"></span><br><span class="line">列出所有打开的网络连接端口</span><br><span class="line">ss -l</span><br><span class="line"></span><br><span class="line">常用的  ss -antl</span><br></pre></td></tr></table></figure>



<p>wget</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br></pre></td><td class="code"><pre><span class="line">wget命令用来从指定的URL下载文件。wget非常稳定，它在带宽很窄的情况下和不稳定网络中有很强的适应性，如果是由于网络的原因下载失败，wget会不断的尝试，直到整个文件下载完毕。如果是服务器打断下载过程，它会再次联到服务器上从停止的地方继续下载。这对从那些限定了链接时间的服务器上下载大文件非常有用。</span><br><span class="line"></span><br><span class="line">语法：</span><br><span class="line">wget(选项)(参数)</span><br><span class="line"></span><br><span class="line">选项：</span><br><span class="line">-a&lt;日志文件&gt;：在指定的日志文件中记录资料的执行过程；</span><br><span class="line"> -A&lt;后缀名&gt;：指定要下载文件的后缀名，多个后缀名之间使用逗号进行分隔；</span><br><span class="line"> -b：进行后台的方式运行wget； -B&lt;连接地址&gt;：设置参考的连接地址的基地地址；</span><br><span class="line"> -c：继续执行上次终端的任务；</span><br><span class="line"> -C&lt;标志&gt;：设置服务器数据块功能标志on为激活，off为关闭，默认值为on；</span><br><span class="line"> -d：调试模式运行指令； -D&lt;域名列表&gt;：设置顺着的域名列表，域名之间用“，”分隔；</span><br><span class="line"> -e&lt;指令&gt;：作为文件“.wgetrc”中的一部分执行指定的指令；</span><br><span class="line"> -h：显示指令帮助信息；</span><br><span class="line"> -i&lt;文件&gt;：从指定文件获取要下载的URL地址；</span><br><span class="line"> -l&lt;目录列表&gt;：设置顺着的目录列表，多个目录用“，”分隔；</span><br><span class="line"> -L：仅顺着关联的连接；</span><br><span class="line"> -r：递归下载方式；</span><br><span class="line"> -nc：文件存在时，下载文件不覆盖原有文件；</span><br><span class="line"> -nv：下载时只显示更新和出错信息，不显示指令的详细执行过程；</span><br><span class="line"> -q：不显示指令执行过程；</span><br><span class="line"> -nh：不查询主机名称；</span><br><span class="line"> -v：显示详细执行过程；</span><br><span class="line"> -V：显示版本信息；</span><br><span class="line"> --passive-ftp：使用被动模式PASV连接FTP服务器；</span><br><span class="line"> --follow-ftp：从HTML文件中下载FTP连接文件。</span><br><span class="line"></span><br><span class="line">参数：</span><br><span class="line">URL：下载指定的URL地址。</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>、使用wget下载单个文件 </span><br><span class="line"></span><br><span class="line">以下的例子是从网络下载一个文件并保存在当前目录 </span><br><span class="line"></span><br><span class="line">wget http:<span class="comment">//cn.wordpress.org/wordpress-3.1-zh_CN.zip </span></span><br><span class="line"></span><br><span class="line">在下载的过程中会显示进度条，包含（下载完成百分比，已经下载的字节，当前下载速度，剩余下载时间）。 </span><br><span class="line"></span><br><span class="line"><span class="number">2</span>、使用wget -O下载并以不同的文件名保存 </span><br><span class="line"></span><br><span class="line">wget默认会以最后一个符合”/”的后面的字符来命令，对于动态链接的下载通常文件名会不正确。 </span><br><span class="line">错误：下面的例子会下载一个文件并以名称download.php?id=<span class="number">1080</span>保存 </span><br><span class="line"></span><br><span class="line">wget http:<span class="comment">//www.centos.bz/download?id=1 </span></span><br><span class="line">即使下载的文件是zip格式，它仍然以download.php?id=<span class="number">1080</span>命令。 </span><br><span class="line">正确：为了解决这个问题，我们可以使用参数-O来指定一个文件名： </span><br><span class="line"></span><br><span class="line">wget -O wordpress.zip http:<span class="comment">//www.centos.bz/download.php?id=1080 </span></span><br><span class="line"></span><br><span class="line"><span class="number">3</span>、使用wget –limit -rate限速下载 </span><br><span class="line">当你执行wget的时候，它默认会占用全部可能的宽带下载。但是当你准备下载一个大文件，而你还需要下载其它文件时就有必要限速了。 </span><br><span class="line"></span><br><span class="line">wget –limit-rate=<span class="number">300</span>k http:<span class="comment">//cn.wordpress.org/wordpress-3.1-zh_CN.zip </span></span><br><span class="line"></span><br><span class="line"><span class="number">4</span>、使用wget -c断点续传 </span><br><span class="line">使用wget -c重新启动下载中断的文件: </span><br><span class="line"></span><br><span class="line">wget -c http:<span class="comment">//cn.wordpress.org/wordpress-3.1-zh_CN.zip </span></span><br><span class="line">对于我们下载大文件时突然由于网络等原因中断非常有帮助，我们可以继续接着下载而不是重新下载一个文件。需要继续中断的下载时可以使用-c参数。 </span><br><span class="line"></span><br><span class="line"><span class="number">5</span>、使用wget -b后台下载 </span><br><span class="line">对于下载非常大的文件的时候，我们可以使用参数-b进行后台下载。 </span><br><span class="line"></span><br><span class="line">wget -b http:<span class="comment">//cn.wordpress.org/wordpress-3.1-zh_CN.zip </span></span><br><span class="line">Continuing <span class="keyword">in</span> background, pid <span class="number">1840.</span> </span><br><span class="line">Output will be written to `wget-log’. </span><br><span class="line">你可以使用以下命令来察看下载进度 </span><br><span class="line"></span><br><span class="line">tail -f wget-log </span><br><span class="line"></span><br><span class="line"><span class="number">6</span>、伪装代理名称下载 </span><br><span class="line">有些网站能通过根据判断代理名称不是浏览器而拒绝你的下载请求。不过你可以通过–user-agent参数伪装。 </span><br><span class="line"></span><br><span class="line">wget –user-agent=”Mozilla/<span class="number">5.0</span> (Windows; U; Windows NT <span class="number">6.1</span>; en-US) AppleWebKit/<span class="number">534.16</span> (KHTML, like Gecko) Chrome/<span class="number">10.0</span><span class="number">.648</span><span class="number">.204</span> Safari/<span class="number">534.16</span>″ 下载链接 </span><br><span class="line"></span><br><span class="line"><span class="number">7</span>、使用wget –spider测试下载链接 </span><br><span class="line">当你打算进行定时下载，你应该在预定时间测试下载链接是否有效。我们可以增加–spider参数进行检查。 </span><br><span class="line"></span><br><span class="line">wget –spider URL </span><br><span class="line">如果下载链接正确，将会显示 </span><br><span class="line"></span><br><span class="line">wget –spider URL </span><br><span class="line">Spider mode enabled. Check <span class="keyword">if</span> remote file exists. </span><br><span class="line">HTTP request sent, awaiting response… <span class="number">200</span> OK </span><br><span class="line">Length: unspecified [text/html] </span><br><span class="line">Remote file exists <span class="keyword">and</span> could contain further links, </span><br><span class="line">but recursion <span class="keyword">is</span> disabled — <span class="keyword">not</span> retrieving. </span><br><span class="line">这保证了下载能在预定的时间进行，但当你给错了一个链接，将会显示如下错误 </span><br><span class="line"></span><br><span class="line">wget –spider url </span><br><span class="line">Spider mode enabled. Check <span class="keyword">if</span> remote file exists. </span><br><span class="line">HTTP request sent, awaiting response… <span class="number">404</span> Not Found </span><br><span class="line">Remote file does <span class="keyword">not</span> exist — broken link!!! </span><br><span class="line">你可以在以下几种情况下使用spider参数： </span><br><span class="line"></span><br><span class="line">定时下载之前进行检查 </span><br><span class="line">间隔检测网站是否可用 </span><br><span class="line">检查网站页面的死链接 </span><br><span class="line"></span><br><span class="line"><span class="number">8</span>、使用wget –tries增加重试次数 </span><br><span class="line">如果网络有问题或下载一个大文件也有可能失败。wget默认重试<span class="number">20</span>次连接下载文件。如果需要，你可以使用–tries增加重试次数。 </span><br><span class="line"></span><br><span class="line">wget –tries=<span class="number">40</span> URL </span><br><span class="line"></span><br><span class="line"><span class="number">9</span>、使用wget -i下载多个文件 </span><br><span class="line">首先，保存一份下载链接文件 </span><br><span class="line"></span><br><span class="line">cat &gt; filelist.txt </span><br><span class="line">url1 </span><br><span class="line">url2 </span><br><span class="line">url3 </span><br><span class="line">url4 </span><br><span class="line">接着使用这个文件和参数-i下载 </span><br><span class="line"></span><br><span class="line">wget -i filelist.txt </span><br><span class="line"></span><br><span class="line"><span class="number">10</span>、使用wget –mirror镜像网站 </span><br><span class="line">下面的例子是下载整个网站到本地。 </span><br><span class="line"></span><br><span class="line">wget –mirror -p –convert-links -P ./LOCAL URL </span><br><span class="line">–miror:开户镜像下载 </span><br><span class="line">-p:下载所有为了html页面显示正常的文件 </span><br><span class="line">–convert-links:下载后，转换成本地的链接 </span><br><span class="line">-P ./LOCAL：保存所有文件和目录到本地指定目录 </span><br><span class="line"></span><br><span class="line"><span class="number">11</span>、使用wget –reject过滤指定格式下载 </span><br><span class="line">你想下载一个网站，但你不希望下载图片，你可以使用以下命令。 </span><br><span class="line"></span><br><span class="line">wget –reject=gif url </span><br><span class="line"></span><br><span class="line"><span class="number">12</span>、使用wget -o把下载信息存入日志文件 </span><br><span class="line">你不希望下载信息直接显示在终端而是在一个日志文件，可以使用以下命令： </span><br><span class="line"></span><br><span class="line">wget -o download.log URL </span><br><span class="line"></span><br><span class="line"><span class="number">13</span>、使用wget -Q限制总下载文件大小 </span><br><span class="line">当你想要下载的文件超过<span class="number">5</span>M而退出下载，你可以使用以下命令: </span><br><span class="line"></span><br><span class="line">wget -Q5m -i filelist.txt </span><br><span class="line">注意：这个参数对单个文件下载不起作用，只能递归下载时才有效。 </span><br><span class="line"></span><br><span class="line"><span class="number">14</span>、使用wget -r -A下载指定格式文件 </span><br><span class="line">可以在以下情况使用该功能 </span><br><span class="line"></span><br><span class="line">下载一个网站的所有图片 </span><br><span class="line">下载一个网站的所有视频 </span><br><span class="line">下载一个网站的所有PDF文件 </span><br><span class="line">wget -r -A.pdf url </span><br><span class="line"></span><br><span class="line"><span class="number">15</span>、使用wget FTP下载 </span><br><span class="line">你可以使用wget来完成ftp链接的下载。 </span><br><span class="line">使用wget匿名ftp下载 </span><br><span class="line"></span><br><span class="line">wget ftp-url </span><br><span class="line"></span><br><span class="line">使用wget用户名和密码认证的ftp下载 </span><br><span class="line"></span><br><span class="line">wget –ftp-user=USERNAME –ftp-password=PASSWORD url</span><br><span class="line"></span><br><span class="line">wget是在Linux下开发的开放源代码的软件，作者是Hrvoje Niksic，后来被移植到包括Windows在内的各个平台上。它有以下功能和特点： </span><br><span class="line"></span><br><span class="line">（<span class="number">1</span>）支持断点下传功能；这一点，也是网络蚂蚁和FlashGet当年最大的卖点，现在，Wget也可以使用此功能，那些网络不是太好的用户可以放心了； </span><br><span class="line">（<span class="number">2</span>）同时支持FTP和HTTP下载方式；尽管现在大部分软件可以使用HTTP方式下载，但是，有些时候，仍然需要使用FTP方式下载软件； </span><br><span class="line">（<span class="number">3</span>）支持代理服务器；对安全强度很高的系统而言，一般不会将自己的系统直接暴露在互联网上，所以，支持代理是下载软件必须有的功能； </span><br><span class="line">（<span class="number">4</span>）设置方便简单；可能，习惯图形界面的用户已经不是太习惯命令行了，但是，命令行在设置上其实有更多的优点，最少，鼠标可以少点很多次，也不要担心是否错点鼠标； </span><br><span class="line">（<span class="number">5</span>）程序小，完全免费；程序小可以考虑不计，因为现在的硬盘实在太大了；完全免费就不得不考虑了，即使网络上有很多所谓的免费软件，但是，这些软件的广告却不是我们喜欢的； </span><br><span class="line"></span><br><span class="line">wget虽然功能强大，但是使用起来还是比较简单的，基本的语法是：wget [参数列表] URL。下面就结合具体的例子来说明一下wget的用法。 </span><br><span class="line"></span><br><span class="line"><span class="number">1</span>、下载整个http或者ftp站点。 </span><br><span class="line">wget http:<span class="comment">//place.your.url/here </span></span><br><span class="line">这个命令可以将http:<span class="comment">//place.your.url/here 首页下载下来。使用-x会强制建立服务器上一模一样的目录，如果使用-nd参数，那么服务器上下载的所有内容都会加到本地当前目录。 </span></span><br><span class="line"></span><br><span class="line">wget -r http:<span class="comment">//place.your.url/here </span></span><br><span class="line">这 个命令会按照递归的方法，下载服务器上所有的目录和文件，实质就是下载整个网站。这个命令一定要小心使用，因为在下载的时候，被下载网站指向的所有地址同 样会被下载，因此，如果这个网站引用了其他网站，那么被引用的网站也会被下载下来！基于这个原因，这个参数不常用。可以用-l number参数来指定下载的层次。例如只下载两层，那么使用-l <span class="number">2</span>。 </span><br><span class="line"></span><br><span class="line">要是您想制作镜像站点，那么可以使用－m参数，例如：wget -m http:<span class="comment">//place.your.url/here </span></span><br><span class="line">这时wget会自动判断合适的参数来制作镜像站点。此时，wget会登录到服务器上，读入robots.txt并按robots.txt的规定来执行。 </span><br><span class="line"></span><br><span class="line"><span class="number">2</span>、断点续传。 </span><br><span class="line">当文件特别大或者网络特别慢的时候，往往一个文件还没有下载完，连接就已经被切断，此时就需要断点续传。wget的断点续传是自动的，只需要使用-c参数，例如： </span><br><span class="line">wget -c http:<span class="comment">//the.url.of/incomplete/file </span></span><br><span class="line">使用断点续传要求服务器支持断点续传。-t参数表示重试次数，例如需要重试<span class="number">100</span>次，那么就写-t <span class="number">100</span>，如果设成-t <span class="number">0</span>，那么表示无穷次重试，直到连接成功。-T参数表示超时等待时间，例如-T <span class="number">120</span>，表示等待<span class="number">120</span>秒连接不上就算超时。 </span><br><span class="line"></span><br><span class="line"><span class="number">3</span>、批量下载。 </span><br><span class="line">如果有多个文件需要下载，那么可以生成一个文件，把每个文件的URL写一行，例如生成文件download.txt，然后用命令：wget -i download.txt </span><br><span class="line">这样就会把download.txt里面列出的每个URL都下载下来。（如果列的是文件就下载文件，如果列的是网站，那么下载首页） </span><br><span class="line"></span><br><span class="line"><span class="number">4</span>、选择性的下载。 </span><br><span class="line">可以指定让wget只下载一类文件，或者不下载什么文件。例如： </span><br><span class="line">wget -m –reject=gif http:<span class="comment">//target.web.site/subdirectory </span></span><br><span class="line">表示下载http:<span class="comment">//target.web.site/subdirectory，但是忽略gif文件。–accept=LIST 可以接受的文件类型，–reject=LIST拒绝接受的文件类型。 </span></span><br><span class="line"></span><br><span class="line"><span class="number">5</span>、密码和认证。 </span><br><span class="line">wget只能处理利用用户名/密码方式限制访问的网站，可以利用两个参数： </span><br><span class="line">–http-user=USER设置HTTP用户 </span><br><span class="line">–http-passwd=PASS设置HTTP密码 </span><br><span class="line">对于需要证书做认证的网站，就只能利用其他下载工具了，例如curl。 </span><br><span class="line"></span><br><span class="line"><span class="number">6</span>、利用代理服务器进行下载。 </span><br><span class="line">如果用户的网络需要经过代理服务器，那么可以让wget通过代理服务器进行文件的下载。此时需要在当前用户的目录下创建一个.wgetrc文件。文件中可以设置代理服务器： </span><br><span class="line">http-proxy = <span class="number">111.111</span><span class="number">.111</span><span class="number">.111</span>:<span class="number">8080</span> </span><br><span class="line">ftp-proxy = <span class="number">111.111</span><span class="number">.111</span><span class="number">.111</span>:<span class="number">8080</span> </span><br><span class="line">分别表示http的代理服务器和ftp的代理服务器。如果代理服务器需要密码则使用： </span><br><span class="line">–proxy-user=USER设置代理用户 </span><br><span class="line">–proxy-passwd=PASS设置代理密码 </span><br><span class="line">这两个参数。 </span><br><span class="line">使用参数–proxy=on/off 使用或者关闭代理。 </span><br><span class="line">wget还有很多有用的功能，需要用户去挖掘。 </span><br><span class="line"></span><br><span class="line">附录： </span><br><span class="line"></span><br><span class="line">命令格式： </span><br><span class="line">wget [参数列表] [目标软件、网页的网址] </span><br><span class="line"></span><br><span class="line">-V,–version 显示软件版本号然后退出； </span><br><span class="line">-h,–help显示软件帮助信息； </span><br><span class="line">-e,–execute=COMMAND 执行一个 “.wgetrc”命令 </span><br><span class="line"></span><br><span class="line">-o,–output-file=FILE 将软件输出信息保存到文件； </span><br><span class="line">-a,–append-output=FILE将软件输出信息追加到文件； </span><br><span class="line">-d,–debug显示输出信息； </span><br><span class="line">-q,–quiet 不显示输出信息； </span><br><span class="line">-i,–input-file=FILE 从文件中取得URL； </span><br><span class="line"></span><br><span class="line">-t,–tries=NUMBER 是否下载次数（<span class="number">0</span>表示无穷次） </span><br><span class="line">-O –output-document=FILE下载文件保存为别的文件名 </span><br><span class="line">-nc, –no-clobber 不要覆盖已经存在的文件 </span><br><span class="line">-N,–timestamping只下载比本地新的文件 </span><br><span class="line">-T,–timeout=SECONDS 设置超时时间 </span><br><span class="line">-Y,–proxy=on/off 关闭代理 </span><br><span class="line"></span><br><span class="line">-nd,–no-directories 不建立目录 </span><br><span class="line">-x,–force-directories 强制建立目录 </span><br><span class="line"></span><br><span class="line">–http-user=USER设置HTTP用户 </span><br><span class="line">–http-passwd=PASS设置HTTP密码 </span><br><span class="line">–proxy-user=USER设置代理用户 </span><br><span class="line">–proxy-passwd=PASS设置代理密码 </span><br><span class="line"></span><br><span class="line">-r,–recursive 下载整个网站、目录（小心使用） </span><br><span class="line">-l,–level=NUMBER 下载层次 </span><br><span class="line"></span><br><span class="line">-A,–accept=LIST 可以接受的文件类型 </span><br><span class="line">-R,–reject=LIST拒绝接受的文件类型 </span><br><span class="line">-D,–domains=LIST可以接受的域名 </span><br><span class="line">–exclude-domains=LIST拒绝的域名 </span><br><span class="line">-L,–relative 下载关联链接 </span><br><span class="line">–follow-ftp 只下载FTP链接 </span><br><span class="line">-H,–span-hosts 可以下载外面的主机 </span><br><span class="line">-I,–include-directories=LIST允许的目录 </span><br><span class="line">-X,–exclude-directories=LIST 拒绝的目录 </span><br><span class="line"></span><br><span class="line">中文文档名在平常的情况下会被编码， 但是在 –cut-dirs 时又是正常的， </span><br><span class="line">wget -r -np -nH –cut-dirs=<span class="number">3</span> ftp:<span class="comment">//host/test/ </span></span><br><span class="line">测试.txt </span><br><span class="line">wget -r -np -nH -nd ftp:<span class="comment">//host/test/ </span></span><br><span class="line">%B4%FA%B8%D5.txt </span><br><span class="line">wget “ftp:<span class="comment">//host/test/*” </span></span><br><span class="line">%B4%FA%B8%D5.txt </span><br><span class="line"></span><br><span class="line">由 於不知名的原因，可能是为了避开特殊档名， wget 会自动将抓取档名的部分用 encode_string 处理过， 所以该 patch 就把被 encode_string 处理成 “%<span class="number">3</span>A” 这种东西， 用 decode_string 还原成 “:”，并套用在目录与档案名称的部分，decode_string 是 wget 内建的函式。 </span><br><span class="line"></span><br><span class="line">wget -t0 -c -nH -x -np -b -m -P /home/sunny/NOD32view/ http:<span class="comment">//downloads1.kaspersky-labs.com/bases/ -o wget.log</span></span><br></pre></td></tr></table></figure>

    </div>

    
    
    
      
  <div class="popular-posts-header">相关文章推荐</div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\2021\06\29\STE\2021-06-29-STE\" rel="bookmark">STE</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="\2021\06\29\STE\2021-06-29-接口\" rel="bookmark">接口</a></div>
    </li>
  </ul>

        <div class="reward-container">
  <div>赞赏一下吧～</div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/alipay.png" alt="tongsiying 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>tongsiying
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://tongsiying.github.io/2021/06/29/STE/2021-06-29-performance/" title="performance">https://tongsiying.github.io/2021/06/29/STE/2021-06-29-performance/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener external nofollow noreferrer" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/STE/" rel="tag"># STE</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/06/29/project/project_CDN/2021-06-29-CDN/" rel="prev" title="CND">
      <i class="fa fa-chevron-left"></i> CND
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/06/29/games/2021-06-29-games/" rel="next" title="games">
      games <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#java性能工具"><span class="nav-text">java性能工具</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#jvm内存快照dump文件太大，怎么分析"><span class="nav-text">jvm内存快照dump文件太大，怎么分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1、场景"><span class="nav-text">1、场景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2、dump生成"><span class="nav-text">2、dump生成</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3、准备工作，下载LINUX的MAT"><span class="nav-text">3、准备工作，下载LINUX的MAT</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4、在linux执行分析命令"><span class="nav-text">4、在linux执行分析命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5、打开分析报告"><span class="nav-text">5、打开分析报告</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#G1GC-概念与性能调优-jdk11"><span class="nav-text">G1GC 概念与性能调优 (jdk11)</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#堆"><span class="nav-text">堆</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Java-9-以后开启的参数"><span class="nav-text">Java 9 以后开启的参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#G1-的-GC-阶段"><span class="nav-text">G1 的 GC 阶段</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Young-Only-Phase"><span class="nav-text">Young Only Phase</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Mixed-gc-Phase"><span class="nav-text">Mixed gc Phase</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#g1gc-young-shrinking"><span class="nav-text">g1gc young shrinking</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#从-GC-log-了解与分析-gc"><span class="nav-text">从 GC log 了解与分析 gc</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#CMS-执行"><span class="nav-text">CMS 执行</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#知识点"><span class="nav-text">知识点</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CMS-阶段"><span class="nav-text">CMS 阶段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GC-触发条件"><span class="nav-text">GC 触发条件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GC-异常点"><span class="nav-text">GC 异常点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#现象分析"><span class="nav-text">现象分析</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#linux性能监控"><span class="nav-text">linux性能监控</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#一、CPU"><span class="nav-text">一、CPU</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二、Memory"><span class="nav-text">二、Memory</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三、磁盘IO"><span class="nav-text">三、磁盘IO</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#四、Network-IO"><span class="nav-text">四、Network IO</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CPU"><span class="nav-text">CPU</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#内存"><span class="nav-text">内存</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#IO"><span class="nav-text">IO</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#带宽"><span class="nav-text">带宽</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#其他"><span class="nav-text">其他</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="tongsiying"
      src="/images/gutianle.gif">
  <p class="site-author-name" itemprop="name">tongsiying</p>
  <div class="site-description" itemprop="description">问渠那得清如许？为有源头活水来。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">432</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">48</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/tongsiying" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;tongsiying" rel="noopener external nofollow noreferrer" target="_blank"><i class="github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:wxtlucky1015@163.com" title="E-Mail → mailto:wxtlucky1015@163.com" rel="noopener external nofollow noreferrer" target="_blank"><i class="envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/u/2964109344" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;u&#x2F;2964109344" rel="noopener external nofollow noreferrer" target="_blank"><i class="weibo fa-fw"></i>Weibo</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://tongsiying.github.io/" title="tongsiying → https:&#x2F;&#x2F;tongsiying.github.io"><i class="wrench fa-fw"></i>tongsiying</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://tongsiying.github.io/ReadingNotes/" title="ReadingNotes → https:&#x2F;&#x2F;tongsiying.github.io&#x2F;ReadingNotes&#x2F;"><i class="book fa-fw"></i>ReadingNotes</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://tongsiying.github.io/blog/" title="blog → https:&#x2F;&#x2F;tongsiying.github.io&#x2F;blog&#x2F;"><i class="book fa-fw"></i>blog</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://tongsiying.github.io/blog/tools/" title="tools → https:&#x2F;&#x2F;tongsiying.github.io&#x2F;blog&#x2F;tools&#x2F;"><i class="wrench fa-fw"></i>tools</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://tongsiying.github.io/lanlan/" title="lanlan → https:&#x2F;&#x2F;tongsiying.github.io&#x2F;lanlan&#x2F;"><i class="wrench fa-fw"></i>lanlan</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://tongsiying.github.io/Music/" title="note → https:&#x2F;&#x2F;tongsiying.github.io&#x2F;Music&#x2F;"><i class="wrench fa-fw"></i>note</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://tongsiying.github.io/sound/" title="Music → https:&#x2F;&#x2F;tongsiying.github.io&#x2F;sound&#x2F;"><i class="wrench fa-fw"></i>Music</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://tongsiying.github.io/JSONFormat/" title="JSONFormat → https:&#x2F;&#x2F;tongsiying.github.io&#x2F;JSONFormat&#x2F;"><i class="wrench fa-fw"></i>JSONFormat</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://tongsiying.github.io/HTML5-Canvas/" title="Canvas → https:&#x2F;&#x2F;tongsiying.github.io&#x2F;HTML5-Canvas&#x2F;"><i class="wrench fa-fw"></i>Canvas</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://tongsiying.github.io/games/" title="games → https:&#x2F;&#x2F;tongsiying.github.io&#x2F;games&#x2F;"><i class="wrench fa-fw"></i>games</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://tongsiying.github.io/love/" title="love → https:&#x2F;&#x2F;tongsiying.github.io&#x2F;love&#x2F;"><i class="wrench fa-fw"></i>love</a>
      </span>
  </div>



		<div style="">
  <canvas id="canvas" style="width:60%;">��ǰ�������֧��canvas������������������</canvas>
</div>
<script>
(function(){

   var digit=
    [
        [
            [0,0,1,1,1,0,0],
            [0,1,1,0,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,0,1,1,0],
            [0,0,1,1,1,0,0]
        ],//0
        [
            [0,0,0,1,1,0,0],
            [0,1,1,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [1,1,1,1,1,1,1]
        ],//1
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,0,0,0],
            [0,1,1,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,0,0,0,1,1],
            [1,1,1,1,1,1,1]
        ],//2
        [
            [1,1,1,1,1,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,1,1,0],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//3
        [
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,1,0],
            [0,0,1,1,1,1,0],
            [0,1,1,0,1,1,0],
            [1,1,0,0,1,1,0],
            [1,1,1,1,1,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,1,1]
        ],//4
        [
            [1,1,1,1,1,1,1],
            [1,1,0,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,1,1,1,1,0],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//5
        [
            [0,0,0,0,1,1,0],
            [0,0,1,1,0,0,0],
            [0,1,1,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,0,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//6
        [
            [1,1,1,1,1,1,1],
            [1,1,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0]
        ],//7
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//8
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,1,1,0,0,0,0]
        ],//9
        [
            [0,0,0,0,0,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,0,0,0]
        ]//:
    ];

var canvas = document.getElementById('canvas');

if(canvas.getContext){
    var cxt = canvas.getContext('2d');
    //����canvas�Ŀ���
    var H = 100,W = 700;
    canvas.height = H;
    canvas.width = W;
    cxt.fillStyle = '#f00';
    cxt.fillRect(10,10,50,50);

    //�洢ʱ������
    var data = [];
    //�洢�˶���С��
    var balls = [];
    //�������Ӱ뾶
    var R = canvas.height/20-1;
    (function(){
        var temp = /(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date());
        //�洢ʱ�����֣���ʮλСʱ����λСʱ��ð�š�ʮλ���ӡ���λ���ӡ�ð�š�ʮλ���ӡ���λ������7���������
        data.push(temp[1],temp[2],10,temp[3],temp[4],10,temp[5],temp[6]);
    })();

    /*���ɵ�������*/
    function renderDigit(index,num){
        for(var i = 0; i < digit[num].length; i++){
            for(var j = 0; j < digit[num][i].length; j++){
                if(digit[num][i][j] == 1){
                    cxt.beginPath();
                    cxt.arc(14*(R+2)*index + j*2*(R+1)+(R+1),i*2*(R+1)+(R+1),R,0,2*Math.PI);
                    cxt.closePath();
                    cxt.fill();
                }
            }
        }
    }

    /*����ʱ��*/
    function updateDigitTime(){
        var changeNumArray = [];
        var temp = /(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date());
        var NewData = [];
        NewData.push(temp[1],temp[2],10,temp[3],temp[4],10,temp[5],temp[6]);
        for(var i = data.length-1; i >=0 ; i--){
            //ʱ�䷢���仯
            if(NewData[i] !== data[i]){
                //���仯������ֵ����data�����е������洢��changeNumArray������
                changeNumArray.push(i+'_'+(Number(data[i])+1)%10);
            }
        }
        //����С��
        for(var i = 0; i< changeNumArray.length; i++){
            addBalls.apply(this,changeNumArray[i].split('_'));
        }
        data = NewData.concat();
    }

    /*����С��״̬*/
    function updateBalls(){
        for(var i = 0; i < balls.length; i++){
            balls[i].stepY += balls[i].disY;
            balls[i].x += balls[i].stepX;
            balls[i].y += balls[i].stepY;
            if(balls[i].x > W + R || balls[i].y > H + R){
                balls.splice(i,1);
                i--;
            }
        }
    }

    /*����Ҫ�˶���С��*/
    function addBalls(index,num){
        var numArray = [1,2,3];
        var colorArray =  ["#3BE","#09C","#A6C","#93C","#9C0","#690","#FB3","#F80","#F44","#C00"];
        for(var i = 0; i < digit[num].length; i++){
            for(var j = 0; j < digit[num][i].length; j++){
                if(digit[num][i][j] == 1){
                    var ball = {
                        x:14*(R+2)*index + j*2*(R+1)+(R+1),
                        y:i*2*(R+1)+(R+1),
                        stepX:Math.floor(Math.random() * 4 -2),
                        stepY:-2*numArray[Math.floor(Math.random()*numArray.length)],
                        color:colorArray[Math.floor(Math.random()*colorArray.length)],
                        disY:1
                    };
                    balls.push(ball);
                }
            }
        }
    }

    /*��Ⱦ*/
    function render(){
        //���û������ȣ��ﵽ��ջ�����Ч��
        canvas.height = 100;
        //��Ⱦʱ��
        for(var i = 0; i < data.length; i++){
            renderDigit(i,data[i]);
        }
        //��ȾС��
        for(var i = 0; i < balls.length; i++){
            cxt.beginPath();
            cxt.arc(balls[i].x,balls[i].y,R,0,2*Math.PI);
            cxt.fillStyle = balls[i].color;
            cxt.closePath();
            cxt.fill();
        }
    }

    clearInterval(oTimer);
    var oTimer = setInterval(function(){
        //����ʱ��
        updateDigitTime();
        //����С��״̬
        updateBalls();
        //��Ⱦ
        render();
    },50);
}

})();
</script>
      </div>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; Weeny – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">tongsiying</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">7.6m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">114:48</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
